<!DOCTYPE html>
<html lang="en" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Complete documentation for MPM (Mehr's Package Manager). Learn installation, usage, package development, and advanced features.">
    <meta name="keywords" content="MPM, package manager, documentation, installation, development guide">
    <meta name="author" content="Mehr">
    <meta name="theme-color" content="#171717">
    <meta name="color-scheme" content="dark">
    
    <!-- Open Graph -->
    <meta property="og:title" content="MPM Documentation">
    <meta property="og:description" content="Complete documentation for MPM (Mehr's Package Manager)">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mpm.mehrnet.com/">
    <meta property="og:site_name" content="MPM Docs">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="MPM Documentation">
    <meta name="twitter:description" content="Complete documentation for MPM (Mehr's Package Manager)">
    
    <!-- Canonical -->
    <link rel="canonical" href="https://mpm.mehrnet.com/">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='3 1 18 22' fill='none' shape-rendering='geometricPrecision'%3E%3Cdefs%3E%3ClinearGradient id='gTop' x1='3' y1='1' x2='21' y2='11'%3E%3Cstop offset='0' stop-color='%23ffd1a1'/%3E%3Cstop offset='1' stop-color='%23ff8a2a'/%3E%3C/linearGradient%3E%3ClinearGradient id='gLeft' x1='3' y1='7' x2='12' y2='23'%3E%3Cstop offset='0' stop-color='%23ff9a3d'/%3E%3Cstop offset='1' stop-color='%23f97316'/%3E%3C/linearGradient%3E%3ClinearGradient id='gRight' x1='12' y1='12' x2='21' y2='23'%3E%3Cstop offset='0' stop-color='%23f97316'/%3E%3Cstop offset='1' stop-color='%23ea580c'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpolygon fill='url(%23gLeft)' points='3,7.3 11.1,12.2 11.1,23 3,18.1'/%3E%3Cpolygon fill='url(%23gRight)' points='21,7.3 12.9,12.2 12.9,23 21,18.1'/%3E%3Cpolygon fill='url(%23gTop)' points='12,1 20.4,6.2 12,10.8 3.6,6.2'/%3E%3C/svg%3E">
    
    <title>MPM Documentation</title>
    <style>
        /* ========== CSS VARIABLES & RESET ========== */
        :root {
            --bg-primary: #171717;
            --bg-secondary: #2a1f19;
            --bg-tertiary: #1e2021;
            --text-primary: #e2e8f0;
            --text-secondary: #a89280;
            --text-tertiary: #c4b5a8;
            --text-muted: #6b5a52;
            --border: #3d2a23;
            --border-secondary: #4d3a30;
            --accent: #f34e3f;
            --selection-bg: #4a3531;
            --selection-text: #c4b5a8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *::selection {
            background-color: var(--selection-bg);
            color: var(--selection-text);
        }

        *::-moz-selection {
            background-color: var(--selection-bg);
            color: var(--selection-text);
        }

        /* ========== GLOBAL & BASE STYLES ========== */
        html {
            scroll-behavior: smooth;
            overflow-y: scroll;
        }

        html[dir="rtl"] { direction: rtl; }
        html[dir="ltr"] { direction: ltr; }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            display: flex;
        }

        /* ========== LAYOUT: SIDEBAR (DESKTOP) ========== */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background-color: var(--bg-tertiary);
            overflow-y: auto;
            border-right: 1px solid var(--border);
            z-index: 100;
        }

        html[dir="rtl"] .sidebar {
            left: auto;
            right: 0;
            border-right: none;
            border-left: 1px solid var(--border);
        }

        /* ========== SIDEBAR HEADER ========== */
        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border-secondary);
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            background-color: var(--bg-tertiary);
            z-index: 50;
        }

        .sidebar-logo {
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .logo-text {
            font-size: 0.85em;
            font-weight: 700;
            color: var(--accent);
            flex: 1;
            margin-left: 8px;
        }

        html[dir="rtl"] .logo-text {
            margin-left: 0;
            margin-right: 8px;
        }

        /* ========== LANGUAGE SELECTOR ========== */
        .lang-btn-wrapper {
            position: relative;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            background: none;
            border: 1px solid var(--border-secondary);
            color: var(--text-secondary);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .lang-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .lang-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 4px);
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            z-index: 9999;
            white-space: nowrap;
            overflow: hidden;
        }

        html[dir="rtl"] .lang-dropdown {
            right: auto;
            left: 0;
        }

        .lang-dropdown.show {
            display: block;
        }

        .lang-option {
            display: block;
            width: 100%;
            padding: 10px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
            text-align: left;
        }

        html[dir="rtl"] .lang-option {
            text-align: right;
        }

        .lang-option:hover,
        .lang-option.active {
            background-color: rgba(243, 78, 63, 0.1);
            color: var(--accent);
        }

        /* ========== TABLE OF CONTENTS (NAVIGATION) ========== */
        .toc {
            padding: 24px 0;
        }

        .toc-section {
            padding: 0;
        }

        .toc-title {
            padding: 8px 24px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }

        .toc-link {
            display: block;
            padding: 10px 24px;
            color: var(--text-tertiary);
            text-decoration: none;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        html[dir="rtl"] .toc-link {
            border-left: none;
            border-right: 3px solid transparent;
        }

        .toc-link:hover,
        .toc-link:target,
        .toc-link.active {
            color: var(--accent);
            background-color: rgba(243, 78, 63, 0.1);
        }

        .toc-link:hover { padding-left: 28px; }
        html[dir="rtl"] .toc-link:hover {
            padding-left: 24px;
            padding-right: 28px;
        }

        .toc-link:target,
        .toc-link.active {
            border-left-color: var(--accent);
            padding-left: 21px;
        }

        html[dir="rtl"] .toc-link:target,
        html[dir="rtl"] .toc-link.active {
            border-left: none;
            border-right-color: var(--accent);
            padding-left: 24px;
            padding-right: 21px;
        }

        /* ========== LAYOUT: MAIN CONTENT (DESKTOP) ========== */
        .main {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            height: 100vh;
        }

        html[dir="rtl"] .main {
            margin-left: 0;
            margin-right: 280px;
            direction: rtl;
        }

        .content-section {
            max-width: 900px;
            margin-bottom: 80px;
            scroll-margin-top: 20px;
            direction: inherit;
        }

        .content-section :target {
            background-color: rgba(243, 78, 63, 0.05);
            padding: 8px 16px;
            border-radius: 4px;
        }

        /* ========== CONTENT: TYPOGRAPHY ========== */
        .content-section h1 {
            color: var(--accent);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .content-section h2 {
            color: var(--accent);
            margin-top: 32px;
            margin-bottom: 16px;
        }

        .content-section h3,
        .content-section h4,
        .content-section h5,
        .content-section h6 {
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .content-section p {
            margin-bottom: 16px;
            color: var(--text-tertiary);
        }

        /* ========== CONTENT: LINKS ========== */
        .content-section a {
            color: var(--accent);
            text-decoration: none;
        }

        .content-section a:hover {
            text-decoration: underline;
        }

        /* ========== CONTENT: CODE & PRE ========== */
        .content-section code {
            background-color: var(--bg-secondary);
            color: #10b981;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }

        .content-section pre {
            background-color: var(--bg-secondary);
            color: #e0e0e0;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 16px 0;
            border-left: 3px solid var(--accent);
        }

        html[dir="rtl"] .content-section pre {
            border-left: none;
            border-right: 3px solid var(--accent);
        }

        .content-section pre code {
            background: none;
            color: inherit;
            padding: 0;
            border-radius: 0;
        }

        /* ========== CONTENT: BLOCKQUOTE ========== */
        .content-section blockquote {
            border-left: 4px solid var(--accent);
            padding-left: 16px;
            margin: 16px 0;
            color: var(--text-secondary);
        }

        html[dir="rtl"] .content-section blockquote {
            border-left: none;
            border-right: 4px solid var(--accent);
            padding-left: 0;
            padding-right: 16px;
        }

        /* ========== CONTENT: TABLES ========== */
        .content-section table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        .content-section th,
        .content-section td {
            padding: 12px;
            border: 1px solid var(--border);
            text-align: left;
        }

        html[dir="rtl"] .content-section th,
        html[dir="rtl"] .content-section td {
            text-align: right;
        }

        .content-section th {
            background-color: rgba(243, 78, 63, 0.1);
            color: var(--accent);
        }

        .content-section tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.2);
        }

        /* ========== CONTENT: LISTS ========== */
        .content-section ul,
        .content-section ol {
            margin: 16px 0 16px 24px;
        }

        html[dir="rtl"] .content-section ul,
        html[dir="rtl"] .content-section ol {
            margin: 16px 24px 16px 0;
        }

        .content-section li {
            margin-bottom: 8px;
        }

        /* ========== MOBILE MENU BUTTON ========== */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            padding: 6px;
            cursor: pointer;
            color: var(--accent);
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .mobile-menu-btn:hover {
            opacity: 0.8;
        }

        .mobile-menu-btn svg {
            display: none;
            transition: all 0.3s;
        }

        .mobile-menu-btn .menu-icon {
            display: block;
        }

        .mobile-menu-btn.active .menu-icon {
            display: none;
        }

        .mobile-menu-btn.active .close-icon {
            display: block;
        }

        /* ========== RESPONSIVE: MOBILE (768px and below) ========== */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 0;
                z-index: 100;
                overflow: visible;
            }

            html[dir="rtl"] .sidebar {
                left: auto;
                right: 0;
                border-left: none;
                border-bottom: 1px solid var(--border);
            }

            .sidebar-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                padding: 0 8px;
                height: 60px;
                grid-template-columns: auto auto minmax(0, 1fr) auto;
                grid-template-rows: 60px;
                gap: 4px;
                background-color: var(--bg-tertiary);
                border-bottom: 1px solid var(--border-secondary);
                z-index: 101;
                overflow: visible;
            }

            .mobile-menu-btn {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                padding: 4px;
                margin: 0;
            }

            .sidebar-logo {
                flex-shrink: 0;
            }

            .logo-text {
                margin-left: 6px;
                font-size: 0.7em;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                line-height: 1;
                min-width: 0;
            }

            html[dir="rtl"] .logo-text {
                margin-left: 0;
                margin-right: 6px;
            }

            .lang-btn {
                padding: 4px 8px;
                font-size: 0.65em;
                white-space: nowrap;
            }

            .toc {
                position: fixed;
                left: 0;
                right: 0;
                top: 60px;
                width: 100%;
                max-height: calc(100vh - 60px);
                padding: 16px 0;
                background-color: var(--bg-tertiary);
                overflow-y: auto;
                border-bottom: 1px solid var(--border);
                transform: translateY(-100%);
                transition: transform 0.3s ease;
            }

            html[dir="rtl"] .toc {
                left: auto;
                right: 0;
            }

            .sidebar.mobile-open .toc {
                transform: translateY(0);
            }

            .main {
                margin-left: 0;
                margin-top: 60px;
                padding: 16px;
                height: calc(100vh - 60px);
            }

            html[dir="rtl"] .main {
                margin-right: 0;
                margin-top: 60px;
            }
        }
    </style>
</head>
<body>
    <script>
        // Early language detection to prevent content flashing in wrong language
        (function() {
            function detectLanguageFromHash() {
                const hash = window.location.hash.slice(1);

                // If URL has a hash, prioritize finding the language it belongs to
                if (hash) {
                    try {
                        const decodedHash = decodeURIComponent(hash);
                        const element = document.getElementById(decodedHash);
                        if (element) {
                            const section = element.closest('[data-lang]');
                            if (section) {
                                return section.getAttribute('data-lang');
                            }
                        }
                    } catch (e) {
                        // Continue to fallback
                    }
                }

                // Fallback: saved preference, then browser language, then English
                return localStorage.getItem('mpm-docs-lang') ||
                       (navigator.language.startsWith('fa') ? 'fa' :
                        navigator.language.startsWith('fr') ? 'fr' : 'en');
            }

            function applyLanguage(lang) {
                const htmlRoot = document.documentElement;
                htmlRoot.setAttribute('lang', lang);
                htmlRoot.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');
                localStorage.setItem('mpm-docs-lang', lang);

                // Show/hide content sections by language
                document.querySelectorAll('[data-lang]').forEach(el => {
                    el.hidden = el.getAttribute('data-lang') !== lang;
                });
            }

            // Apply language before main script runs (must wait for DOM)
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    const initialLang = detectLanguageFromHash();
                    applyLanguage(initialLang);
                });
            } else {
                const initialLang = detectLanguageFromHash();
                applyLanguage(initialLang);
            }
        })();
    </script>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <button class="mobile-menu-btn" id="mobile-menu-btn" aria-label="Toggle menu">
                <svg class="menu-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
                <svg class="close-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
            <a href="/" class="sidebar-logo" aria-label="Home">
                <svg width="24" height="24" viewBox="3 1 18 22" fill="none" aria-hidden="true" shape-rendering="geometricPrecision">
                    <defs>
                        <linearGradient id="gTop" x1="3" y1="1" x2="21" y2="11"><stop offset="0" stop-color="#ffd1a1"/><stop offset="1" stop-color="#ff8a2a"/></linearGradient>
                        <linearGradient id="gLeft" x1="3" y1="7" x2="12" y2="23"><stop offset="0" stop-color="#ff9a3d"/><stop offset="1" stop-color="#f97316"/></linearGradient>
                        <linearGradient id="gRight" x1="12" y1="12" x2="21" y2="23"><stop offset="0" stop-color="#f97316"/><stop offset="1" stop-color="#ea580c"/></linearGradient>
                    </defs>
                    <polygon fill="url(#gLeft)" points="3,7.3 11.1,12.2 11.1,23 3,18.1"/><polygon fill="url(#gRight)" points="21,7.3 12.9,12.2 12.9,23 21,18.1"/><polygon fill="url(#gTop)" points="12,1 20.4,6.2 12,10.8 3.6,6.2"/>
                </svg>
            </a>
            <span id="logo-text" class="logo-text">Mehr's Package Manager</span>
            <div class="lang-btn-wrapper">
                <button class="lang-btn" id="lang-btn">EN</button>
                <div class="lang-dropdown" id="lang-dropdown">
                    <button class="lang-option" data-lang="en">English</button>
                    <button class="lang-option" data-lang="fr">Français</button>
                    <button class="lang-option" data-lang="fa">فارسی</button>
                </div>
            </div>
        </div>

        <nav class="toc" id="toc-nav">
            <!-- Navbar will be generated with data-lang wrappers -->
    <div data-lang="en">
        <div class="toc-section">
            <div class="toc-title">Installation &amp; Setup Guide</div>
            <a href="#installation" class="toc-link" data-section="installation">Installation</a>
            <a href="#first-run" class="toc-link" data-section="first-run">First Run</a>
            <a href="#configuration" class="toc-link" data-section="configuration">Configuration</a>
            <a href="#getting-started" class="toc-link" data-section="getting-started">Getting Started</a>
            <a href="#package-development" class="toc-link" data-section="package-development">Package Development</a>
            <a href="#repository-setup" class="toc-link" data-section="repository-setup">Repository Setup</a>
            <a href="#deployment" class="toc-link" data-section="deployment">Deployment</a>
            <a href="#troubleshooting" class="toc-link" data-section="troubleshooting">Troubleshooting</a>
            <a href="#next-steps" class="toc-link" data-section="next-steps">Next Steps</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">Usage Reference</div>
            <a href="#request-formats" class="toc-link" data-section="request-formats">Request Formats</a>
            <a href="#built-in-commands" class="toc-link" data-section="built-in-commands">Built-in Commands</a>
            <a href="#package-manager" class="toc-link" data-section="package-manager">Package Manager</a>
            <a href="#response-protocol" class="toc-link" data-section="response-protocol">Response Protocol</a>
            <a href="#configuration-files" class="toc-link" data-section="configuration-files">Configuration Files</a>
            <a href="#custom-commands" class="toc-link" data-section="custom-commands">Custom Commands</a>
            <a href="#architecture" class="toc-link" data-section="architecture">Architecture</a>
            <a href="#performance" class="toc-link" data-section="performance">Performance</a>
            <a href="#troubleshooting-1" class="toc-link" data-section="troubleshooting-1">Troubleshooting</a>
            <a href="#see-also" class="toc-link" data-section="see-also">See Also</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">Package Development Guide</div>
            <a href="#quick-start" class="toc-link" data-section="quick-start">Quick Start</a>
            <a href="#package-structure" class="toc-link" data-section="package-structure">Package Structure</a>
            <a href="#handler-implementation" class="toc-link" data-section="handler-implementation">Handler Implementation</a>
            <a href="#package-metadata" class="toc-link" data-section="package-metadata">Package Metadata</a>
            <a href="#testing-packages" class="toc-link" data-section="testing-packages">Testing Packages</a>
            <a href="#distribution" class="toc-link" data-section="distribution">Distribution</a>
            <a href="#best-practices-1" class="toc-link" data-section="best-practices-1">Best Practices</a>
            <a href="#examples" class="toc-link" data-section="examples">Examples</a>
            <a href="#see-also-1" class="toc-link" data-section="see-also-1">See Also</a>
        </div>
    </div>
    <div data-lang="fa" hidden>
        <div class="toc-section">
            <div class="toc-title">راهنمای نصب و تنظیمات</div>
            <a href="#فهرست-مطالب" class="toc-link" data-section="فهرست-مطالب">فهرست مطالب</a>
            <a href="#نصب" class="toc-link" data-section="نصب">نصب</a>
            <a href="#اولین-اجرا" class="toc-link" data-section="اولین-اجرا">اولین اجرا</a>
            <a href="#پیکربندی" class="toc-link" data-section="پیکربندی">پیکربندی</a>
            <a href="#شروع-کار" class="toc-link" data-section="شروع-کار">شروع کار</a>
            <a href="#توسعه-بسته" class="toc-link" data-section="توسعه-بسته">توسعه بسته</a>
            <a href="#تنظیم-مخزن" class="toc-link" data-section="تنظیم-مخزن">تنظیم مخزن</a>
            <a href="#استقرار" class="toc-link" data-section="استقرار">استقرار</a>
            <a href="#حل-مسائل" class="toc-link" data-section="حل-مسائل">حل مسائل</a>
            <a href="#مراحل-بعدی" class="toc-link" data-section="مراحل-بعدی">مراحل بعدی</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">راهنمای مرجع استفاده</div>
            <a href="#فهرست-مطالب-1" class="toc-link" data-section="فهرست-مطالب-1">فهرست مطالب</a>
            <a href="#فرمت-های-درخواست" class="toc-link" data-section="فرمت-های-درخواست">فرمت های درخواست</a>
            <a href="#فرماندهای-درون-ساخت" class="toc-link" data-section="فرماندهای-درون-ساخت">فرماندهای درون ساخت</a>
            <a href="#مدیریت-بسته" class="toc-link" data-section="مدیریت-بسته">مدیریت بسته</a>
            <a href="#پروتکل-پاسخ" class="toc-link" data-section="پروتکل-پاسخ">پروتکل پاسخ</a>
            <a href="#فایل-های-تنظیمات" class="toc-link" data-section="فایل-های-تنظیمات">فایل های تنظیمات</a>
            <a href="#فرماندهای-سفارشی" class="toc-link" data-section="فرماندهای-سفارشی">فرماندهای سفارشی</a>
            <a href="#معماری" class="toc-link" data-section="معماری">معماری</a>
            <a href="#کارایی" class="toc-link" data-section="کارایی">کارایی</a>
            <a href="#حل-مسائل-1" class="toc-link" data-section="حل-مسائل-1">حل مسائل</a>
            <a href="#همچنین-ببینید" class="toc-link" data-section="همچنین-ببینید">همچنین ببینید</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">راهنمای توسعه بسته</div>
            <a href="#فهرست-مطالب-2" class="toc-link" data-section="فهرست-مطالب-2">فهرست مطالب</a>
            <a href="#شروع-سریع" class="toc-link" data-section="شروع-سریع">شروع سریع</a>
            <a href="#ساختار-بسته" class="toc-link" data-section="ساختار-بسته">ساختار بسته</a>
            <a href="#پیاده-سازی-کننده" class="toc-link" data-section="پیاده-سازی-کننده">پیاده سازی کننده</a>
            <a href="#فرادادهای-بسته" class="toc-link" data-section="فرادادهای-بسته">فرادادهای بسته</a>
            <a href="#تست-بسته-ها" class="toc-link" data-section="تست-بسته-ها">تست بسته ها</a>
            <a href="#توزیع" class="toc-link" data-section="توزیع">توزیع</a>
            <a href="#بهترین-عملکردها-1" class="toc-link" data-section="بهترین-عملکردها-1">بهترین عملکردها</a>
            <a href="#مثال-ها" class="toc-link" data-section="مثال-ها">مثال ها</a>
            <a href="#همچنین-ببینید-1" class="toc-link" data-section="همچنین-ببینید-1">همچنین ببینید</a>
        </div>
    </div>
    <div data-lang="fr" hidden>
        <div class="toc-section">
            <div class="toc-title">Référence d&#39;utilisation</div>
            <a href="#table-des-matières" class="toc-link" data-section="table-des-matières">Table des matières</a>
            <a href="#formats-de-requête" class="toc-link" data-section="formats-de-requête">Formats de requête</a>
            <a href="#commandes-intégrées" class="toc-link" data-section="commandes-intégrées">Commandes intégrées</a>
            <a href="#gestionnaire-de-paquets" class="toc-link" data-section="gestionnaire-de-paquets">Gestionnaire de paquets</a>
            <a href="#protocole-de-réponse" class="toc-link" data-section="protocole-de-réponse">Protocole de réponse</a>
            <a href="#fichiers-de-configuration" class="toc-link" data-section="fichiers-de-configuration">Fichiers de configuration</a>
            <a href="#commandes-personnalisées" class="toc-link" data-section="commandes-personnalisées">Commandes personnalisées</a>
            <a href="#architecture-1" class="toc-link" data-section="architecture-1">Architecture</a>
            <a href="#performance-1" class="toc-link" data-section="performance-1">Performance</a>
            <a href="#dépannage" class="toc-link" data-section="dépannage">Dépannage</a>
            <a href="#voir-aussi" class="toc-link" data-section="voir-aussi">Voir aussi</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">Guide d&#39;installation et de configuration</div>
            <a href="#table-des-matières-1" class="toc-link" data-section="table-des-matières-1">Table des matières</a>
            <a href="#installation-1" class="toc-link" data-section="installation-1">Installation</a>
            <a href="#première-exécution" class="toc-link" data-section="première-exécution">Première exécution</a>
            <a href="#configuration-1" class="toc-link" data-section="configuration-1">Configuration</a>
            <a href="#commencer" class="toc-link" data-section="commencer">Commencer</a>
            <a href="#développement-de-paquets" class="toc-link" data-section="développement-de-paquets">Développement de paquets</a>
            <a href="#configuration-du-référentiel" class="toc-link" data-section="configuration-du-référentiel">Configuration du référentiel</a>
            <a href="#déploiement" class="toc-link" data-section="déploiement">Déploiement</a>
            <a href="#dépannage-1" class="toc-link" data-section="dépannage-1">Dépannage</a>
            <a href="#étapes-suivantes" class="toc-link" data-section="étapes-suivantes">Étapes suivantes</a>
        </div>
        <div class="toc-section">
            <div class="toc-title">Guide de développement des paquets</div>
            <a href="#table-des-matières-2" class="toc-link" data-section="table-des-matières-2">Table des matières</a>
            <a href="#démarrage-rapide" class="toc-link" data-section="démarrage-rapide">Démarrage rapide</a>
            <a href="#structure-du-paquet" class="toc-link" data-section="structure-du-paquet">Structure du paquet</a>
            <a href="#implémentation-du-gestionnaire" class="toc-link" data-section="implémentation-du-gestionnaire">Implémentation du gestionnaire</a>
            <a href="#métadonnées-du-paquet" class="toc-link" data-section="métadonnées-du-paquet">Métadonnées du paquet</a>
            <a href="#tests-des-paquets" class="toc-link" data-section="tests-des-paquets">Tests des paquets</a>
            <a href="#distribution-1" class="toc-link" data-section="distribution-1">Distribution</a>
            <a href="#bonnes-pratiques-1" class="toc-link" data-section="bonnes-pratiques-1">Bonnes pratiques</a>
            <a href="#exemples" class="toc-link" data-section="exemples">Exemples</a>
            <a href="#voir-aussi-1" class="toc-link" data-section="voir-aussi-1">Voir aussi</a>
        </div>
    </div>


        </nav>
    </aside>

    <main class="main">
        <!-- Content sections generated with data-lang wrappers -->
    <section class="content-section" data-lang="en">
<!-- LANG:en -->
<h1 id="installation--setup-guide">Installation &amp; Setup Guide</h1>
<p>Complete guide for installing, configuring, and getting started with MPM - Mehr&#39;s Package Manager.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#first-run">First Run</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#package-development">Package Development</a></li>
<li><a href="#repository-setup">Repository Setup</a></li>
<li><a href="#deployment">Deployment</a></li>
</ul>
<hr>
<h2 id="installation">Installation</h2>
<h3 id="quick-install">Quick Install</h3>
<pre><code class="language-bash"># Download shell.php
wget https://raw.githubusercontent.com/mehrnet/mpm/main/shell.php

# Set permissions
chmod 644 shell.php

# Test installation
php shell.php echo &quot;Hello, World!&quot;
</code></pre>
<h3 id="manual-install">Manual Install</h3>
<ol>
<li>Download <code>shell.php</code> from the repository</li>
<li>Place it in your project root or web server directory</li>
<li>Ensure PHP 8.1+ is installed</li>
<li>Verify <code>ZipArchive</code> extension is enabled (for package management)</li>
</ol>
<h3 id="requirements">Requirements</h3>
<ul>
<li><strong>PHP</strong>: 8.1 or higher</li>
<li><strong>Extensions</strong>: <code>ZipArchive</code> (for package management)</li>
<li><strong>Permissions</strong>: Read/write access to project directory</li>
</ul>
<h2 id="first-run">First Run</h2>
<p>On first execution, MPM automatically generates configuration files:</p>
<pre><code class="language-bash"># Run any command to initialize
php shell.php ls
</code></pre>
<p>This creates:</p>
<pre><code>.config/
├── key              # API key (64 hex characters)
├── repos.json       # Repository mirrors configuration
├── packages.json    # Installed packages registry
└── path.json        # Command handler patterns
</code></pre>
<h3 id="api-key">API Key</h3>
<p>Your API key is displayed on first HTTP access or saved to <code>.config/key</code> on first CLI run:</p>
<pre><code class="language-bash"># View your API key
cat .config/key
</code></pre>
<p><strong>Important:</strong> Keep your API key secure. Anyone with access can execute commands.</p>
<h2 id="configuration">Configuration</h2>
<h3 id="repository-mirrors">Repository Mirrors</h3>
<p>Edit <code>.config/repos.json</code> to customize package repositories:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://repo.example.com&quot;,
    &quot;https://mirror1.example.com&quot;,
    &quot;https://mirror2.example.com&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.example.com&quot;
  ]
}
</code></pre>
<p>Mirrors are tried sequentially on failure with no backoff delay.</p>
<h3 id="command-handler-patterns">Command Handler Patterns</h3>
<p>Edit <code>.config/path.json</code> to customize where the shell looks for custom commands:</p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;,
  &quot;custom/handlers/[name].php&quot;
]
</code></pre>
<p>The <code>[name]</code> placeholder is replaced with the command name.</p>
<h3 id="environment-specific-configuration">Environment-Specific Configuration</h3>
<p>For different environments, you can:</p>
<ol>
<li><p><strong>Use different config directories:</strong></p>
<pre><code class="language-php">// Modify constants in shell.php (not recommended)
const DIR_CONFIG = &#39;.config&#39;;
</code></pre>
</li>
<li><p><strong>Symlink configuration:</strong></p>
<pre><code class="language-bash">ln -s .config.production .config
</code></pre>
</li>
<li><p><strong>Environment variables:</strong>
Access via <code>php shell.php env list</code></p>
</li>
</ol>
<h2 id="getting-started">Getting Started</h2>
<h3 id="cli-mode-recommended-for-development">CLI Mode (Recommended for Development)</h3>
<pre><code class="language-bash"># List files
php shell.php ls

# Read file contents
php shell.php cat shell.php | head -20

# Create directory
php shell.php mkdir tmp

# Copy files
php shell.php cp shell.php shell.backup.php

# Package management
php shell.php pkg search database
php shell.php pkg add users
php shell.php pkg list
php shell.php pkg upgrade
</code></pre>
<h3 id="http-mode-production">HTTP Mode (Production)</h3>
<ol>
<li><p><strong>Start PHP development server (testing):</strong></p>
<pre><code class="language-bash">php -S localhost:8000
</code></pre>
</li>
<li><p><strong>Get your API key:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
</code></pre>
</li>
<li><p><strong>Execute commands:</strong></p>
<pre><code class="language-bash"># List files
curl &quot;http://localhost:8000/shell.php/$KEY/ls&quot;

# Read file
curl &quot;http://localhost:8000/shell.php/$KEY/cat/README.md&quot;

# Package management
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
</li>
</ol>
<h3 id="production-web-server">Production Web Server</h3>
<p>For production, use a proper web server:</p>
<p><strong>Nginx:</strong></p>
<pre><code class="language-nginx">server {
    listen 80;
    server_name your-domain.com;
    root /var/www/shell;
    index shell.php;

    location / {
        try_files $uri $uri/ /shell.php$is_args$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index shell.php;
        include fastcgi_params;
    }
}
</code></pre>
<p><strong>Apache (.htaccess):</strong></p>
<pre><code class="language-apache">RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ shell.php/$1 [L,QSA]
</code></pre>
<h2 id="package-development">Package Development</h2>
<h3 id="creating-a-package">Creating a Package</h3>
<ol>
<li><p><strong>Create package structure:</strong></p>
<pre><code>mypackage/
├── handler.php       # Required: Entry point
├── package.json      # Required: Metadata
├── lib/             # Optional: Library code
└── data/            # Optional: Data files
</code></pre>
</li>
<li><p><strong>Write handler.php:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return &quot;Item 1\nItem 2\nItem 3&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Name required&#39;, 400);
            }
            return &quot;Created: $name&quot;;

        default:
            return &quot;Actions: list, create&quot;;
    }
};
</code></pre>
</li>
<li><p><strong>Create package.json:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Package description&quot;,
    &quot;author&quot;: &quot;Your Name&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
</code></pre>
</li>
</ol>
<h3 id="package-metadata-fields">Package Metadata Fields</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>string</td>
<td>Yes</td>
<td>Lowercase, no spaces, used in URLs</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Human-readable name</td>
</tr>
<tr>
<td><code>version</code></td>
<td>string</td>
<td>Yes</td>
<td>Semantic versioning (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>string</td>
<td>Yes</td>
<td>Brief description</td>
</tr>
<tr>
<td><code>author</code></td>
<td>string</td>
<td>No</td>
<td>Package author</td>
</tr>
<tr>
<td><code>license</code></td>
<td>string</td>
<td>No</td>
<td>License identifier (MIT, Apache-2.0, etc.)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>array</td>
<td>No</td>
<td>Array of package IDs</td>
</tr>
</tbody></table>
<h3 id="testing-your-package">Testing Your Package</h3>
<p><strong>CLI Mode:</strong></p>
<pre><code class="language-bash"># Install manually
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# Test commands
php shell.php mypackage list
php shell.php mypackage create item-name
</code></pre>
<p><strong>HTTP Mode:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/create/item-name&quot;
</code></pre>
<h3 id="best-practices">Best Practices</h3>
<ol>
<li><p><strong>Input Validation:</strong></p>
<pre><code class="language-php">$id = $args[0] ?? null;
if (!$id || !is_numeric($id)) {
    throw new \RuntimeException(&#39;Invalid ID&#39;, 400);
}
</code></pre>
</li>
<li><p><strong>Error Handling:</strong></p>
<pre><code class="language-php">try {
    $data = json_decode(file_get_contents(&#39;data.json&#39;), true);
    if (!$data) {
        throw new \RuntimeException(&#39;Invalid JSON&#39;, 400);
    }
} catch (\Throwable $e) {
    throw new \RuntimeException(&quot;Error: {$e-&gt;getMessage()}&quot;, 400);
}
</code></pre>
</li>
<li><p><strong>Security:</strong></p>
<pre><code class="language-php">// BAD: Direct use of user input
$file = $args[0];
return file_get_contents($file);  // Vulnerable to path traversal

// GOOD: Validate and restrict paths
$file = basename($args[0] ?? &#39;&#39;);  // Remove path components
$path = &quot;app/data/$file&quot;;
if (!file_exists($path)) {
    throw new \RuntimeException(&#39;File not found&#39;, 404);
}
return file_get_contents($path);
</code></pre>
</li>
</ol>
<h2 id="repository-setup">Repository Setup</h2>
<h3 id="creating-a-package-repository">Creating a Package Repository</h3>
<ol>
<li><p><strong>Create repository structure:</strong></p>
<pre><code>my-repo/
└── main/
    ├── database.json
    ├── mypackage-1.0.0.zip
    └── otherapkg-1.0.0.zip
</code></pre>
</li>
<li><p><strong>Build package ZIP:</strong></p>
<pre><code class="language-bash">cd mypackage
zip -r ../my-repo/main/mypackage-1.0.0.zip .
</code></pre>
</li>
<li><p><strong>Calculate checksum:</strong></p>
<pre><code class="language-bash">sha256sum my-repo/main/mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
</li>
<li><p><strong>Create database.json:</strong></p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;Package description&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;,
      &quot;author&quot;: &quot;Your Name&quot;,
      &quot;license&quot;: &quot;MIT&quot;
    }
  }
}
</code></pre>
</li>
<li><p><strong>Host the repository:</strong></p>
<ul>
<li>Upload to GitHub: <code>https://github.com/user/repo/raw/main/main/</code></li>
<li>Use CDN or static hosting</li>
<li>Ensure HTTPS is enabled</li>
</ul>
</li>
<li><p><strong>Configure shell to use your repository:</strong>
Edit <code>.config/repos.json</code>:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [&quot;https://github.com/user/repo/raw/main/main&quot;]
}
</code></pre>
</li>
</ol>
<h3 id="github-hosting-example">GitHub Hosting Example</h3>
<pre><code class="language-bash"># Create repository
mkdir -p my-packages/main
cd my-packages

# Add packages
cp /path/to/mypackage-1.0.0.zip main/
cat &gt; main/database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# Push to GitHub
git init
git add .
git commit -m &quot;Add packages&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# Users configure: https://github.com/user/my-packages/raw/main/main
</code></pre>
<h2 id="deployment">Deployment</h2>
<h3 id="development">Development</h3>
<pre><code class="language-bash"># Run PHP built-in server
php -S localhost:8000

# Test commands
php shell.php pkg list
curl &quot;http://localhost:8000/shell.php/$(cat .config/key)/pkg/list&quot;
</code></pre>
<h3 id="stagingproduction">Staging/Production</h3>
<ol>
<li><p><strong>Use proper web server</strong> (Nginx, Apache, Caddy)</p>
</li>
<li><p><strong>Enable HTTPS</strong> for API key security</p>
</li>
<li><p><strong>Set restrictive permissions:</strong></p>
<pre><code class="language-bash">chmod 644 shell.php
chmod 700 .config
chmod 600 .config/key
</code></pre>
</li>
<li><p><strong>Configure PHP-FPM</strong> for better performance</p>
</li>
<li><p><strong>Set up monitoring</strong> and logging</p>
</li>
<li><p><strong>Regular backups</strong> of <code>.config/</code> directory</p>
</li>
</ol>
<h3 id="docker-deployment">Docker Deployment</h3>
<pre><code class="language-dockerfile">FROM php:8.1-fpm

# Install extensions
RUN docker-php-ext-install zip

# Copy shell
COPY shell.php /var/www/html/

# Set permissions
RUN chown -R www-data:www-data /var/www/html

WORKDIR /var/www/html
</code></pre>
<h3 id="security-hardening">Security Hardening</h3>
<ol>
<li><p><strong>Restrict API key access:</strong></p>
<pre><code class="language-bash">chmod 600 .config/key
chown www-data:www-data .config/key
</code></pre>
</li>
<li><p><strong>Use environment-specific keys</strong></p>
</li>
<li><p><strong>Enable HTTPS only</strong> in production</p>
</li>
<li><p><strong>Rate limiting</strong> at web server level</p>
</li>
<li><p><strong>Monitor failed auth attempts</strong></p>
</li>
<li><p><strong>Regular security updates</strong></p>
</li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="common-issues">Common Issues</h3>
<p><strong>&quot;Permission denied&quot; errors:</strong></p>
<pre><code class="language-bash"># Fix permissions
chmod 755 .
chmod 644 shell.php
chmod -R 755 .config
</code></pre>
<p><strong>&quot;ZipArchive not found&quot;:</strong></p>
<pre><code class="language-bash"># Install extension
sudo apt-get install php-zip  # Debian/Ubuntu
sudo yum install php-zip       # CentOS/RHEL
</code></pre>
<p><strong>&quot;API key not found&quot; (CLI mode):</strong></p>
<pre><code class="language-bash"># Generate key manually
php shell.php ls  # This creates .config/key
</code></pre>
<p><strong>Lock file issues:</strong></p>
<pre><code class="language-bash"># Force unlock if stuck
php shell.php pkg unlock
</code></pre>
<h2 id="next-steps">Next Steps</h2>
<ul>
<li>Read the <a href="USAGE.md">Usage Reference</a> for complete command documentation</li>
<li>See <a href="PACKAGES.md">Package Development</a> for advanced package creation</li>
<li>Check out <a href="https://github.com/mehrnet/mpm-packages">example packages</a></li>
</ul>
<hr>
<p>For questions or issues, please visit: <a href="https://github.com/mehrnet/mpm">https://github.com/mehrnet/mpm</a></p>
<!-- LANG:en -->
<h1 id="usage-reference">Usage Reference</h1>
<p>Complete command reference and API documentation for MPM - Mehr&#39;s Package Manager.</p>
<h2 id="table-of-contents-1">Table of Contents</h2>
<ul>
<li><a href="#request-formats">Request Formats</a></li>
<li><a href="#built-in-commands">Built-in Commands</a></li>
<li><a href="#package-manager">Package Manager</a></li>
<li><a href="#response-protocol">Response Protocol</a></li>
<li><a href="#configuration-files">Configuration Files</a></li>
<li><a href="#custom-commands">Custom Commands</a></li>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#performance">Performance</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
<hr>
<h2 id="request-formats">Request Formats</h2>
<h3 id="http-mode">HTTP Mode</h3>
<p><strong>Format:</strong></p>
<pre><code>GET /shell.php/API_KEY/COMMAND/ARG0/ARG1/ARG2/...
</code></pre>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># Get API key
KEY=$(cat .config/key)

# List files
curl &quot;http://localhost/shell.php/$KEY/ls&quot;

# Read file
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;

# Echo with multiple arguments
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;

# Package management
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
<p><strong>Response:</strong></p>
<ul>
<li>Success: HTTP 200 with plain text response</li>
<li>Error: HTTP 4xx/5xx with error message</li>
</ul>
<h3 id="cli-mode">CLI Mode</h3>
<p><strong>Format:</strong></p>
<pre><code class="language-bash">php shell.php COMMAND ARG0 ARG1 ARG2 ...
</code></pre>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># List files
php shell.php ls

# Read file
php shell.php cat README.md

# Echo with multiple arguments
php shell.php echo hello world

# Package management
php shell.php pkg search database
php shell.php pkg add users
</code></pre>
<p><strong>Response:</strong></p>
<ul>
<li>Success: Output to STDOUT, exit code 0</li>
<li>Error: Output to STDERR with &quot;Error: &quot; prefix, exit code 1</li>
</ul>
<hr>
<h2 id="built-in-commands">Built-in Commands</h2>
<h3 id="ls-path">ls [path]</h3>
<p>List directory contents.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>path</code> (optional): Directory to list (default: current directory)</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php ls
php shell.php ls app
php shell.php ls app/packages

# HTTP
curl &quot;http://localhost/shell.php/$KEY/ls&quot;
curl &quot;http://localhost/shell.php/$KEY/ls/app&quot;
</code></pre>
<p><strong>Output:</strong>
Space-separated filenames (excludes <code>.</code> and <code>..</code>)</p>
<p><strong>Errors:</strong></p>
<ul>
<li>404: Directory not found</li>
<li>400: Cannot read directory</li>
<li>403: Path validation failed (absolute path or <code>..</code>)</li>
</ul>
<hr>
<h3 id="cat-">cat <file></h3>
<p>Read file contents.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>file</code> (required): Path to file</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cat README.md
php shell.php cat .config/key

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;
</code></pre>
<p><strong>Output:</strong>
File contents (preserves formatting and newlines)</p>
<p><strong>Errors:</strong></p>
<ul>
<li>400: Missing file argument or not a file</li>
<li>404: File not found</li>
<li>403: Path validation failed</li>
</ul>
<hr>
<h3 id="rm-">rm <file></h3>
<p>Delete file.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>file</code> (required): Path to file</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php rm temp.txt
php shell.php rm logs/old.log

# HTTP
curl &quot;http://localhost/shell.php/$KEY/rm/temp.txt&quot;
</code></pre>
<p><strong>Output:</strong>
Empty string on success (POSIX behavior)</p>
<p><strong>Errors:</strong></p>
<ul>
<li>400: Missing file argument, not a file, or cannot delete</li>
<li>404: File not found</li>
<li>403: Path validation failed</li>
</ul>
<hr>
<h3 id="mkdir-">mkdir <path></h3>
<p>Create directory (recursive).</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>path</code> (required): Directory path to create</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php mkdir uploads
php shell.php mkdir app/data/cache

# HTTP
curl &quot;http://localhost/shell.php/$KEY/mkdir/uploads&quot;
</code></pre>
<p><strong>Output:</strong>
Empty string on success</p>
<p><strong>Errors:</strong></p>
<ul>
<li>400: Missing path argument, already exists, or cannot create</li>
<li>403: Path validation failed</li>
</ul>
<hr>
<h3 id="cp--">cp <src> <dst></h3>
<p>Copy file.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>src</code> (required): Source file path</li>
<li><code>dst</code> (required): Destination file path</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cp config.json config.backup.json
php shell.php cp README.md docs/README.md

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cp/config.json/config.backup.json&quot;
</code></pre>
<p><strong>Output:</strong>
Empty string on success</p>
<p><strong>Errors:</strong></p>
<ul>
<li>400: Missing arguments, source not a file, or cannot copy</li>
<li>404: Source file not found</li>
<li>403: Path validation failed</li>
</ul>
<hr>
<h3 id="echo-">echo <text>...</h3>
<p>Echo text arguments.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>text...</code> (required): One or more text arguments</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php echo hello
php shell.php echo hello world &quot;from shell&quot;

# HTTP
curl &quot;http://localhost/shell.php/$KEY/echo/hello&quot;
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;
</code></pre>
<p><strong>Output:</strong>
Space-separated arguments</p>
<hr>
<h3 id="env-action-name">env [action] [name]</h3>
<p>Manage environment variables.</p>
<p><strong>Actions:</strong></p>
<ul>
<li><code>list</code> (default): List all environment variables</li>
<li><code>get &lt;name&gt;</code>: Get specific variable value</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php env list
php shell.php env get PATH
php shell.php env get HOME

# HTTP
curl &quot;http://localhost/shell.php/$KEY/env/list&quot;
curl &quot;http://localhost/shell.php/$KEY/env/get/PATH&quot;
</code></pre>
<p><strong>Output:</strong></p>
<ul>
<li><code>list</code>: One variable per line (<code>KEY=value</code>)</li>
<li><code>get</code>: Variable value only</li>
</ul>
<p><strong>Errors:</strong></p>
<ul>
<li>404: Variable not found or unknown action</li>
<li>400: Missing variable name for <code>get</code></li>
</ul>
<hr>
<h2 id="package-manager">Package Manager</h2>
<h3 id="pkg-add-package">pkg add [PACKAGE...]</h3>
<p>Install packages with automatic dependency resolution.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE...</code> (required): One or more package names</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg add users
php shell.php pkg add users auth database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users/auth&quot;
</code></pre>
<p><strong>Process:</strong></p>
<ol>
<li>Fetch repository database</li>
<li>Resolve dependencies (DFS topological sort)</li>
<li>Download all packages with checksum verification</li>
<li>Extract all packages to project root</li>
<li>Register packages atomically</li>
</ol>
<p><strong>Output:</strong></p>
<pre><code>Packages to install: dependency1, dependency2, users

Downloading packages...
All packages downloaded and verified

Extracting packages...
Extracted dependency1 (1.0.0)
Extracted dependency2 (2.0.0)
Extracted users (3.0.0)

Registering packages...

Successfully installed 3 package(s): dependency1, dependency2, users
</code></pre>
<p><strong>Errors:</strong></p>
<ul>
<li>404: Package not found</li>
<li>400: Circular dependency detected</li>
<li>503: All mirrors failed or lock held</li>
</ul>
<hr>
<h3 id="pkg-del-">pkg del <PACKAGE></h3>
<p>Remove package (fails if other packages depend on it).</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (required): Package name</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg del users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/del/users&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Removed package: users (version 1.0.0) - 15 files deleted, 3 empty directories removed
</code></pre>
<p><strong>Errors:</strong></p>
<ul>
<li>404: Package not installed</li>
<li>400: Package required by other packages</li>
<li>503: Lock held</li>
</ul>
<hr>
<h3 id="pkg-upgrade-package">pkg upgrade [PACKAGE]</h3>
<p>Upgrade all packages or specific package to latest version.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (optional): Package name (if omitted, upgrades all)</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg upgrade           # Upgrade all
php shell.php pkg upgrade users     # Upgrade specific

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade/users&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Will upgrade users from 1.0.0 to 1.1.0

Downloading package updates...
All package updates downloaded and verified

Extracting package updates...
Extracted users upgrade to 1.1.0

Registering upgrades...

Successfully upgraded 1 package(s): users
</code></pre>
<hr>
<h3 id="pkg-update">pkg update</h3>
<p>Refresh repository cache (fetch latest package database).</p>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg update

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/update&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Repository cache refreshed - 42 packages available
</code></pre>
<hr>
<h3 id="pkg-list-filter">pkg list [FILTER]</h3>
<p>List installed packages.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>FILTER</code> (optional): Filter by package name (case-insensitive)</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg list
php shell.php pkg list auth

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/list/auth&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Installed packages:

  users                 v1.0.0      installed: 2025-01-15
  auth                  v2.0.0      installed: 2025-01-15 (depends: users)
  database              v1.5.0      installed: 2025-01-15 (depends: users)
</code></pre>
<hr>
<h3 id="pkg-search-">pkg search <KEYWORD></h3>
<p>Search available packages.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>KEYWORD</code> (required): Search term</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg search database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Found 3 packages:

  mysql-driver          v1.0.0      MySQL Database Driver [installed]
    Provides MySQL connectivity for applications

  postgres-driver       v1.0.0      PostgreSQL Driver
    PostgreSQL database connector

  database-tools        v2.0.0      Database Management Tools
    Common database utilities and helpers
</code></pre>
<hr>
<h3 id="pkg-info-">pkg info <PACKAGE></h3>
<p>Show detailed package information.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (required): Package name</li>
</ul>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg info users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/info/users&quot;
</code></pre>
<p><strong>Output:</strong></p>
<pre><code>Package: User Management System
ID: users
Latest: 1.0.0
Description: Complete user management with authentication
Author: Mehrnet Team
License: MIT

Installed: v1.0.0 (on 2025-01-15T10:30:00Z)
Dependencies: none

Available versions:
  v1.0.0 - released: 2025-01-15
  v0.9.0 - released: 2025-01-01 (requires: auth-lib)
</code></pre>
<p><strong>Errors:</strong></p>
<ul>
<li>404: Package not found in repository</li>
</ul>
<hr>
<h3 id="pkg-unlock">pkg unlock</h3>
<p>Force remove lock file (for manual recovery).</p>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg unlock

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/unlock&quot;
</code></pre>
<p><strong>Output:</strong>
Empty string on success</p>
<p><strong>When to use:</strong>
If a package operation crashes, the lock file may remain. This command removes it.</p>
<hr>
<h3 id="pkg-help">pkg help</h3>
<p>Show package manager help.</p>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg help

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/help&quot;
</code></pre>
<hr>
<h3 id="pkg-version">pkg version</h3>
<p>Show package manager version.</p>
<p><strong>Examples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg version

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/version&quot;
</code></pre>
<hr>
<h2 id="response-protocol">Response Protocol</h2>
<h3 id="http-status-codes">HTTP Status Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>Success</td>
</tr>
<tr>
<td>400</td>
<td>Bad Request (invalid arguments, operational errors)</td>
</tr>
<tr>
<td>403</td>
<td>Forbidden (invalid API key, path validation failed)</td>
</tr>
<tr>
<td>404</td>
<td>Not Found (command, package, or file not found)</td>
</tr>
<tr>
<td>503</td>
<td>Service Unavailable (all mirrors failed, lock held)</td>
</tr>
</tbody></table>
<h3 id="cli-exit-codes">CLI Exit Codes</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Success</td>
</tr>
<tr>
<td>1</td>
<td>Error (any type)</td>
</tr>
</tbody></table>
<h3 id="posix-semantics">POSIX Semantics</h3>
<ul>
<li>Commands with output return data</li>
<li>Commands without output return empty string (but still exit 0/200)</li>
<li>Errors throw exceptions with appropriate codes</li>
</ul>
<hr>
<h2 id="configuration-files">Configuration Files</h2>
<h3 id="configkey">.config/key</h3>
<p>Plain text file containing 64-character hex API key.</p>
<p><strong>Format:</strong></p>
<pre><code>abc123def456789...  (64 hex characters)
</code></pre>
<p><strong>Generation:</strong></p>
<pre><code class="language-php">$key = bin2hex(random_bytes(32));
</code></pre>
<p><strong>Security:</strong></p>
<ul>
<li>Auto-generated on first run</li>
<li>Used for HTTP authentication</li>
<li>Auto-loaded for CLI mode</li>
<li>Timing-safe comparison via <code>hash_equals()</code></li>
</ul>
<hr>
<h3 id="configreposjson">.config/repos.json</h3>
<p>Repository mirrors configuration.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://primary-mirror.com/packages&quot;,
    &quot;https://secondary-mirror.com/packages&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.com/packages&quot;
  ]
}
</code></pre>
<p><strong>Mirror Selection:</strong></p>
<ul>
<li>Mirrors tried sequentially in array order</li>
<li>No backoff delay on failure</li>
<li>First successful mirror wins</li>
</ul>
<hr>
<h3 id="configpackagesjson">.config/packages.json</h3>
<p>Installed packages registry.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">{
  &quot;createdAt&quot;: &quot;2025-01-15T10:00:00Z&quot;,
  &quot;updatedAt&quot;: &quot;2025-01-15T10:30:00Z&quot;,
  &quot;packages&quot;: {
    &quot;users&quot;: {
      &quot;version&quot;: &quot;1.0.0&quot;,
      &quot;installed_at&quot;: &quot;2025-01-15T10:30:00Z&quot;,
      &quot;dependencies&quot;: [],
      &quot;files&quot;: [
        &quot;./app/packages/users/handler.php&quot;,
        &quot;./app/packages/users/module.php&quot;
      ],
      &quot;download_url&quot;: &quot;https://mirror.com/users-1.0.0.zip&quot;,
      &quot;download_time&quot;: &quot;2025-01-15T10:29:00Z&quot;,
      &quot;checksum&quot;: &quot;sha256:abc123...&quot;,
      &quot;repository&quot;: &quot;main&quot;
    }
  }
}
</code></pre>
<p><strong>Metadata:</strong></p>
<ul>
<li><code>createdAt</code>: Registry creation time</li>
<li><code>updatedAt</code>: Last modification time</li>
<li><code>files</code>: Array of installed file paths (for removal)</li>
<li><code>download_url</code>: Source mirror used</li>
<li><code>checksum</code>: Verified checksum</li>
</ul>
<hr>
<h3 id="configpathjson">.config/path.json</h3>
<p>Command handler discovery patterns.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;
]
</code></pre>
<p><strong>Pattern Matching:</strong></p>
<ul>
<li><code>[name]</code> replaced with command name</li>
<li>Patterns searched in array order</li>
<li>First match wins</li>
</ul>
<p><strong>Example:</strong>
Command <code>users</code> searches:</p>
<ol>
<li><code>app/packages/users/handler.php</code></li>
<li><code>bin/users.php</code></li>
</ol>
<hr>
<h2 id="custom-commands">Custom Commands</h2>
<h3 id="handler-format">Handler Format</h3>
<p>Handlers are PHP files returning a callable:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Process arguments
    // Return response or throw exception
    return &quot;output&quot;;
};
</code></pre>
<h3 id="argument-processing">Argument Processing</h3>
<p><strong>HTTP Mode:</strong></p>
<pre><code>GET /shell.php/KEY/mycommand/action/arg1/arg2
                      ↓        ↓      ↓    ↓
                  command   args[0] [1]  [2]
</code></pre>
<p><strong>CLI Mode:</strong></p>
<pre><code class="language-bash">php shell.php mycommand action arg1 arg2
               ↓        ↓      ↓    ↓
           command   args[0] [1]  [2]
</code></pre>
<p><strong>Handler receives:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];  // &#39;action&#39;
    $arg1 = $args[1];    // &#39;arg1&#39;
    $arg2 = $args[2];    // &#39;arg2&#39;
}
</code></pre>
<h3 id="error-handling">Error Handling</h3>
<p>Throw exceptions with HTTP status codes:</p>
<pre><code class="language-php">// Bad request
throw new \RuntimeException(&#39;Invalid input&#39;, 400);

// Not found
throw new \RuntimeException(&#39;Item not found&#39;, 404);

// Forbidden
throw new \RuntimeException(&#39;Permission denied&#39;, 403);
</code></pre>
<p><strong>Note:</strong> CLI mode converts all error codes to exit code 1.</p>
<h3 id="example-handler">Example Handler</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            // Read data
            $data = json_decode(
                file_get_contents(&#39;app/data/items.json&#39;),
                true
            );
            return json_encode($data);

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID required&#39;, 400);
            }
            // Fetch item
            return &quot;Item: $id&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Name required&#39;, 400);
            }
            // Create item
            return &quot;Created: $name&quot;;

        case &#39;help&#39;:
            return &quot;Actions: list, get &lt;id&gt;, create &lt;name&gt;&quot;;

        default:
            throw new \RuntimeException(&quot;Unknown action: $action&quot;, 404);
    }
};
</code></pre>
<hr>
<h2 id="architecture">Architecture</h2>
<h3 id="file-structure">File Structure</h3>
<pre><code>.
├── shell.php              # Main executable (2300 lines)
├── .config/               # Configuration (auto-created)
│   ├── key                # API key
│   ├── repos.json         # Repository mirrors
│   ├── packages.json      # Installed packages
│   └── path.json          # Handler patterns
├── .cache/                # Cache (auto-created)
│   ├── shell.lock         # Lock file
│   └── *.zip              # Downloaded packages
└── app/packages/          # Installed packages
    └── [package]/
        └── handler.php
</code></pre>
<h3 id="execution-flow">Execution Flow</h3>
<pre><code>1. Runtime Detection (HTTP/CLI)
   ↓
2. Initialize Config Files
   ↓
3. Parse Request (PATH_INFO or argv)
   ↓
4. Validate API Key
   ↓
5. Execute Command
   ├─ Built-in Command
   ├─ Package Manager
   └─ Custom Handler
   ↓
6. Send Response (HTTP headers or STDOUT/STDERR)
</code></pre>
<h3 id="package-manager-flow">Package Manager Flow</h3>
<p><strong>Installation:</strong></p>
<pre><code>1. Resolve Dependencies (DFS topological sort)
   ↓
2. Download All Packages (with checksum verification)
   ↓
3. Extract All Packages (with conflict resolution)
   ↓
4. Register in .config/packages.json (atomic)
</code></pre>
<p><strong>Key Features:</strong></p>
<ul>
<li><strong>Dependency Resolution:</strong> O(V + E) complexity</li>
<li><strong>Circular Detection:</strong> O(1) set lookups</li>
<li><strong>Checksum Verification:</strong> SHA256 with timing-safe comparison</li>
<li><strong>Mirror Failover:</strong> Sequential retry, no backoff</li>
<li><strong>Atomic Operations:</strong> All-or-nothing installations</li>
<li><strong>Conflict Resolution:</strong> Existing files renamed with <code>-2</code>, <code>-3</code>, etc.</li>
</ul>
<h3 id="security-model">Security Model</h3>
<ol>
<li><p><strong>Authentication:</strong></p>
<ul>
<li>64-character random API key</li>
<li><code>hash_equals()</code> timing-safe comparison</li>
<li>Auto-loaded in CLI mode</li>
</ul>
</li>
<li><p><strong>Path Validation:</strong></p>
<ul>
<li>Blocks absolute paths (<code>/etc/passwd</code>)</li>
<li>Blocks directory traversal (<code>../../../</code>)</li>
<li>Applied to all file operations</li>
</ul>
</li>
<li><p><strong>Package Security:</strong></p>
<ul>
<li>SHA256 checksum verification</li>
<li>Zip traversal detection</li>
<li>HTTPS mirror enforcement</li>
</ul>
</li>
</ol>
<hr>
<h2 id="performance">Performance</h2>
<h3 id="benchmarks">Benchmarks</h3>
<ul>
<li><strong>Application execution:</strong> &lt;1ms (measured via profiling)</li>
<li><strong>Built-in server overhead:</strong> 1000ms+ (use proper web server in production)</li>
<li><strong>Package download:</strong> Depends on network and mirror speed</li>
<li><strong>Dependency resolution:</strong> O(V + E) where V = packages, E = dependencies</li>
</ul>
<h3 id="optimization-tips">Optimization Tips</h3>
<ol>
<li><strong>Use production web server</strong> (Nginx, Apache)</li>
<li><strong>Enable PHP opcode cache</strong> (OPcache)</li>
<li><strong>Use CDN for package mirrors</strong></li>
<li><strong>Minimize custom handler complexity</strong></li>
<li><strong>Cache package database locally</strong></li>
</ol>
<hr>
<h2 id="troubleshooting-1">Troubleshooting</h2>
<h3 id="invalid-api-key">&quot;Invalid API key&quot;</h3>
<p><strong>HTTP 403</strong></p>
<p><strong>Cause:</strong> Missing or incorrect API key</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Check key
cat .config/key

# Regenerate key (delete and run again)
rm .config/key
php shell.php ls
</code></pre>
<hr>
<h3 id="api-key-not-found-cli">&quot;API key not found&quot; (CLI)</h3>
<p><strong>Exit code 1</strong></p>
<p><strong>Cause:</strong> <code>.config/key</code> file doesn&#39;t exist</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Initialize shell
php shell.php ls
</code></pre>
<hr>
<h3 id="command-not-found">&quot;Command not found&quot;</h3>
<p><strong>HTTP 404 / Exit code 1</strong></p>
<p><strong>Cause:</strong> Handler file not found</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Check handler patterns
cat .config/path.json

# Verify handler exists
ls app/packages/[command]/handler.php
ls bin/[command].php
</code></pre>
<hr>
<h3 id="another-pkg-operation-is-in-progress">&quot;Another pkg operation is in progress&quot;</h3>
<p><strong>HTTP 503 / Exit code 1</strong></p>
<p><strong>Cause:</strong> Lock file exists</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Wait for operation to complete, or force unlock
php shell.php pkg unlock

# Or manually remove
rm .cache/shell.lock
</code></pre>
<hr>
<h3 id="package-not-found">&quot;Package not found&quot;</h3>
<p><strong>HTTP 404 / Exit code 1</strong></p>
<p><strong>Cause:</strong> Package not in repository</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Refresh repository cache
php shell.php pkg update

# Search for package
php shell.php pkg search keyword
</code></pre>
<hr>
<h3 id="circular-dependency">&quot;Circular dependency&quot;</h3>
<p><strong>HTTP 400 / Exit code 1</strong></p>
<p><strong>Cause:</strong> Package dependency cycle (A → B → C → A)</p>
<p><strong>Solution:</strong>
Review package dependencies and remove the cycle. This is a package repository issue.</p>
<hr>
<h3 id="cannot-remove---required-by">&quot;Cannot remove - required by&quot;</h3>
<p><strong>HTTP 400 / Exit code 1</strong></p>
<p><strong>Cause:</strong> Other packages depend on the target package</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Remove dependent packages first
php shell.php pkg del dependent-package
php shell.php pkg del target-package
</code></pre>
<hr>
<h3 id="permission-errors">Permission Errors</h3>
<p><strong>Cause:</strong> File system permissions</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Fix permissions
chmod 755 .
chmod 644 shell.php
chmod 755 .config
chmod 644 .config/*
chmod 755 .cache
</code></pre>
<hr>
<h2 id="see-also">See Also</h2>
<ul>
<li><strong><a href="INSTALL.md">Installation Guide</a></strong> - Setup and configuration</li>
<li><strong><a href="PACKAGES.md">Package Development</a></strong> - Creating packages</li>
<li><strong><a href="https://github.com/mehrnet/mpm">GitHub Repository</a></strong> - Source code</li>
</ul>
<hr>
<p>For questions or issues, please visit: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>
<!-- LANG:en -->
<h1 id="package-development-guide">Package Development Guide</h1>
<p>Complete guide for creating, testing, and distributing MPM (Mehr&#39;s Package Manager) packages.</p>
<p>For installation and setup instructions, see <a href="INSTALL.md">INSTALL.md</a> or <a href="USAGE.md">USAGE.md</a>.</p>
<hr>
<h2 id="table-of-contents-2">Table of Contents</h2>
<ul>
<li><a href="#quick-start">Quick Start</a></li>
<li><a href="#package-structure">Package Structure</a></li>
<li><a href="#handler-implementation">Handler Implementation</a></li>
<li><a href="#package-metadata">Package Metadata</a></li>
<li><a href="#testing-packages">Testing Packages</a></li>
<li><a href="#distribution">Distribution</a></li>
<li><a href="#best-practices">Best Practices</a></li>
<li><a href="#examples">Examples</a></li>
</ul>
<hr>
<h2 id="quick-start">Quick Start</h2>
<p>Create a minimal package in 3 steps:</p>
<pre><code class="language-bash"># 1. Create package structure
mkdir -p mypackage
cd mypackage

# 2. Create handler
cat &gt; handler.php &lt;&lt; &#39;EOF&#39;
&lt;?php
return function(array $args): string {
    return &quot;Hello from mypackage!&quot;;
};
EOF

# 3. Create metadata
cat &gt; package.json &lt;&lt; &#39;EOF&#39;
{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;A simple package&quot;,
    &quot;author&quot;: &quot;Your Name&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
EOF

# Test it
cd ..
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/
php shell.php mypackage
</code></pre>
<hr>
<h2 id="package-structure">Package Structure</h2>
<h3 id="required-files">Required Files</h3>
<pre><code>mypackage/
├── handler.php       # REQUIRED: Entry point
└── package.json      # REQUIRED: Metadata
</code></pre>
<h3 id="optional-structure">Optional Structure</h3>
<pre><code>mypackage/
├── handler.php       # Entry point (required)
├── package.json      # Metadata (required)
├── lib/             # Library code
│   ├── MyClass.php
│   └── helpers.php
├── data/            # Data files
│   └── config.json
├── views/           # Templates
│   └── template.html
└── README.md        # Package documentation
</code></pre>
<h3 id="file-extraction">File Extraction</h3>
<p>Packages extract to project root preserving paths:</p>
<p><strong>Package contains:</strong></p>
<pre><code>handler.php
module.php
lib/Database.php
data/schema.json
</code></pre>
<p><strong>Extracts to:</strong></p>
<pre><code>./handler.php
./module.php
./lib/Database.php
./data/schema.json
</code></pre>
<p>For Mehr framework modules, use:</p>
<pre><code>app/packages/[name]/handler.php
app/packages/[name]/module.php
</code></pre>
<hr>
<h2 id="handler-implementation">Handler Implementation</h2>
<h3 id="basic-handler">Basic Handler</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Single action
    return &quot;Hello, World!&quot;;
};
</code></pre>
<h3 id="multi-action-handler">Multi-Action Handler</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return handleList();

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID required&#39;, 400);
            }
            return handleGet($id);

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Name required&#39;, 400);
            }
            return handleCreate($name);

        case &#39;delete&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID required&#39;, 400);
            }
            return handleDelete($id);

        case &#39;help&#39;:
            return &lt;&lt;&lt;&#39;EOF&#39;
Available actions:
  list              - List all items
  get &lt;id&gt;          - Get item by ID
  create &lt;name&gt;     - Create new item
  delete &lt;id&gt;       - Delete item
EOF;

        default:
            throw new \RuntimeException(&quot;Unknown action: $action&quot;, 404);
    }
};

function handleList(): string {
    return &quot;item1\nitem2\nitem3&quot;;
}

function handleGet(string $id): string {
    // Load from file, database, etc.
    return &quot;Item data for: $id&quot;;
}

function handleCreate(string $name): string {
    // Create and persist
    return &quot;Created: $name&quot;;
}

function handleDelete(string $id): string {
    // Remove item
    return &quot;Deleted: $id&quot;;
}
</code></pre>
<h3 id="argument-processing-1">Argument Processing</h3>
<p>Arguments are identical in both HTTP and CLI modes:</p>
<p><strong>HTTP:</strong></p>
<pre><code>GET /shell.php/KEY/users/create/alice/alice@example.com
                    ↓      ↓      ↓         ↓
                command args[0] args[1]  args[2]
</code></pre>
<p><strong>CLI:</strong></p>
<pre><code class="language-bash">php shell.php users create alice alice@example.com
               ↓      ↓      ↓         ↓
           command args[0] args[1]  args[2]
</code></pre>
<p><strong>Handler:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];    // &#39;create&#39;
    $name = $args[1];      // &#39;alice&#39;
    $email = $args[2];     // &#39;alice@example.com&#39;
}
</code></pre>
<h3 id="file-operations">File Operations</h3>
<p>Handlers execute in shell.php directory. Use relative paths:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Read data file
    $data = json_decode(
        file_get_contents(&#39;app/data/items.json&#39;),
        true
    );

    // Modify data
    $data[&#39;new_item&#39;] = $args[0] ?? &#39;default&#39;;

    // Write back
    file_put_contents(
        &#39;app/data/items.json&#39;,
        json_encode($data, JSON_PRETTY_PRINT)
    );

    return &quot;Updated&quot;;
};
</code></pre>
<h3 id="error-handling-1">Error Handling</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $id = $args[0] ?? null;

    // Validation
    if (!$id) {
        throw new \RuntimeException(&#39;ID required&#39;, 400);
    }

    if (!is_numeric($id)) {
        throw new \RuntimeException(&#39;ID must be numeric&#39;, 400);
    }

    // File operations
    $file = &quot;app/data/$id.json&quot;;
    if (!file_exists($file)) {
        throw new \RuntimeException(&#39;Item not found&#39;, 404);
    }

    try {
        $content = file_get_contents($file);
        $data = json_decode($content, true);

        if (!$data) {
            throw new \RuntimeException(&#39;Invalid JSON&#39;, 400);
        }

        return json_encode($data);
    } catch (\Throwable $e) {
        throw new \RuntimeException(
            &quot;Failed to read item: {$e-&gt;getMessage()}&quot;,
            400
        );
    }
};
</code></pre>
<h3 id="response-formats">Response Formats</h3>
<p><strong>Plain Text:</strong></p>
<pre><code class="language-php">return &quot;item1\nitem2\nitem3&quot;;
</code></pre>
<p><strong>JSON:</strong></p>
<pre><code class="language-php">return json_encode([
    &#39;status&#39; =&gt; &#39;success&#39;,
    &#39;items&#39; =&gt; [&#39;item1&#39;, &#39;item2&#39;, &#39;item3&#39;]
]);
</code></pre>
<p><strong>Empty (POSIX):</strong></p>
<pre><code class="language-php">return &#39;&#39;;  // Success with no output
</code></pre>
<hr>
<h2 id="package-metadata">Package Metadata</h2>
<h3 id="packagejson-format">package.json Format</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Package description&quot;,
    &quot;author&quot;: &quot;Your Name&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: [&quot;dependency1&quot;, &quot;dependency2&quot;]
}
</code></pre>
<h3 id="field-specifications">Field Specifications</h3>
<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>string</td>
<td>Yes</td>
<td>Lowercase, no spaces, used in URLs</td>
</tr>
<tr>
<td><code>name</code></td>
<td>string</td>
<td>Yes</td>
<td>Human-readable name</td>
</tr>
<tr>
<td><code>version</code></td>
<td>string</td>
<td>Yes</td>
<td>Semantic versioning (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>string</td>
<td>Yes</td>
<td>Brief description</td>
</tr>
<tr>
<td><code>author</code></td>
<td>string</td>
<td>No</td>
<td>Package author</td>
</tr>
<tr>
<td><code>license</code></td>
<td>string</td>
<td>No</td>
<td>License identifier (MIT, Apache-2.0, etc.)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>array</td>
<td>No</td>
<td>Array of package IDs</td>
</tr>
</tbody></table>
<h3 id="dependency-declaration">Dependency Declaration</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;auth&quot;,
    &quot;dependencies&quot;: [&quot;users&quot;, &quot;session&quot;]
}
</code></pre>
<p>The package manager:</p>
<ul>
<li>Resolves transitive dependencies automatically</li>
<li>Detects circular dependencies</li>
<li>Installs in correct order (dependencies before dependents)</li>
<li>Skips already-installed packages</li>
</ul>
<hr>
<h2 id="testing-packages">Testing Packages</h2>
<h3 id="manual-testing-cli">Manual Testing (CLI)</h3>
<pre><code class="language-bash"># Install package manually
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# Test commands
php shell.php mypackage
php shell.php mypackage list
php shell.php mypackage get 123
php shell.php mypackage create &quot;Test Item&quot;
</code></pre>
<h3 id="manual-testing-http">Manual Testing (HTTP)</h3>
<pre><code class="language-bash"># Start server
php -S localhost:8000

# Get API key
KEY=$(cat .config/key)

# Test commands
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/get/123&quot;
</code></pre>
<h3 id="testing-checklist">Testing Checklist</h3>
<ul>
<li><input disabled="" type="checkbox"> All actions work correctly</li>
<li><input disabled="" type="checkbox"> Error handling works (invalid input)</li>
<li><input disabled="" type="checkbox"> Required arguments are validated</li>
<li><input disabled="" type="checkbox"> File operations succeed</li>
<li><input disabled="" type="checkbox"> Both CLI and HTTP modes work identically</li>
<li><input disabled="" type="checkbox"> Help action documents all commands</li>
<li><input disabled="" type="checkbox"> Dependencies are declared in package.json</li>
</ul>
<hr>
<h2 id="distribution">Distribution</h2>
<h3 id="creating-package-zip">Creating Package ZIP</h3>
<pre><code class="language-bash">cd mypackage
zip -r ../mypackage-1.0.0.zip .

# Verify contents
unzip -l ../mypackage-1.0.0.zip
</code></pre>
<h3 id="calculate-checksum">Calculate Checksum</h3>
<pre><code class="language-bash">sha256sum mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
<h3 id="repository-databasejson">Repository database.json</h3>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;Package description&quot;,
      &quot;author&quot;: &quot;Your Name&quot;,
      &quot;license&quot;: &quot;MIT&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;
    }
  }
}
</code></pre>
<h3 id="github-hosting">GitHub Hosting</h3>
<pre><code class="language-bash"># Create repository structure
mkdir -p my-packages/main
cd my-packages/main

# Add package and database
cp /path/to/mypackage-1.0.0.zip .
cat &gt; database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# Push to GitHub
cd ..
git init
git add .
git commit -m &quot;Add mypackage&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# Users configure:
# &quot;main&quot;: [&quot;https://github.com/user/my-packages/raw/main/main&quot;]
</code></pre>
<hr>
<h2 id="best-practices-1">Best Practices</h2>
<h3 id="input-validation">Input Validation</h3>
<pre><code class="language-php">// BAD: No validation
$id = $args[0];
return processId($id);

// GOOD: Validate and sanitize
$id = $args[0] ?? null;
if (!$id || !is_numeric($id) || $id &lt; 1) {
    throw new \RuntimeException(&#39;Invalid ID&#39;, 400);
}
return processId((int)$id);
</code></pre>
<h3 id="security">Security</h3>
<pre><code class="language-php">// BAD: Arbitrary file access
$file = $args[0];
return file_get_contents($file);  // Vulnerable to ../../../etc/passwd

// GOOD: Restrict to safe directory
$file = basename($args[0] ?? &#39;&#39;);  // Remove path components
$path = &quot;app/data/$file&quot;;

if (!file_exists($path)) {
    throw new \RuntimeException(&#39;File not found&#39;, 404);
}

return file_get_contents($path);
</code></pre>
<h3 id="error-messages">Error Messages</h3>
<pre><code class="language-php">// BAD: Generic error
throw new \RuntimeException(&#39;Error&#39;, 400);

// GOOD: Descriptive error
throw new \RuntimeException(&#39;User ID must be a positive integer&#39;, 400);
</code></pre>
<h3 id="code-organization">Code Organization</h3>
<pre><code class="language-php">// BAD: Everything in handler
return function(array $args): string {
    // 500 lines of code...
};

// GOOD: Use lib/ directory
return function(array $args): string {
    require_once __DIR__ . &#39;/lib/Manager.php&#39;;
    $manager = new Manager();
    return $manager-&gt;handle($args);
};
</code></pre>
<h3 id="dependencies">Dependencies</h3>
<pre><code class="language-php">// GOOD: Check if Composer libraries available
if (file_exists(__DIR__ . &#39;/../../vendor/autoload.php&#39;)) {
    require_once __DIR__ . &#39;/../../vendor/autoload.php&#39;;
    // Use libraries
} else {
    throw new \RuntimeException(&#39;Composer dependencies missing&#39;, 500);
}
</code></pre>
<hr>
<h2 id="examples">Examples</h2>
<h3 id="simple-counter">Simple Counter</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $file = &#39;app/data/counter.txt&#39;;

    if (!file_exists($file)) {
        file_put_contents($file, &#39;0&#39;);
    }

    $count = (int)file_get_contents($file);
    $count++;
    file_put_contents($file, (string)$count);

    return &quot;Count: $count&quot;;
};
</code></pre>
<h3 id="json-crud">JSON CRUD</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;list&#39;;
    $file = &#39;app/data/items.json&#39;;

    // Load data
    $items = [];
    if (file_exists($file)) {
        $items = json_decode(file_get_contents($file), true) ?? [];
    }

    switch ($action) {
        case &#39;list&#39;:
            return json_encode($items);

        case &#39;add&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Name required&#39;, 400);
            }
            $items[] = [
                &#39;id&#39; =&gt; count($items) + 1,
                &#39;name&#39; =&gt; $name,
                &#39;created_at&#39; =&gt; date(&#39;Y-m-d H:i:s&#39;)
            ];
            file_put_contents($file, json_encode($items, JSON_PRETTY_PRINT));
            return &quot;Added: $name&quot;;

        case &#39;get&#39;:
            $id = (int)($args[1] ?? 0);
            foreach ($items as $item) {
                if ($item[&#39;id&#39;] === $id) {
                    return json_encode($item);
                }
            }
            throw new \RuntimeException(&#39;Item not found&#39;, 404);

        default:
            throw new \RuntimeException(&#39;Unknown action&#39;, 404);
    }
};
</code></pre>
<h3 id="mehr-framework-module">Mehr Framework Module</h3>
<pre><code>mymodule/
├── app/
│   └── packages/
│       └── mymodule/
│           ├── handler.php       # Shell command handler
│           ├── module.php        # Module implementation
│           ├── manifest.json     # Mehr manifest
│           └── migrations/       # Database migrations
│               └── 001_create_table.php
└── package.json                  # Distribution metadata
</code></pre>
<p><strong>handler.php:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    require_once __DIR__ . &#39;/module.php&#39;;
    $module = new MyModule();
    return $module-&gt;handleCommand($args);
};
</code></pre>
<p><strong>package.json:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mymodule&quot;,
    &quot;name&quot;: &quot;My Module&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Mehr framework module&quot;,
    &quot;dependencies&quot;: [&quot;core&quot;]
}
</code></pre>
<hr>
<h2 id="see-also-1">See Also</h2>
<ul>
<li><strong><a href="INSTALL.md">Installation Guide</a></strong> - Setup and repository creation</li>
<li><strong><a href="USAGE.md">Usage Reference</a></strong> - Command reference</li>
<li><strong><a href="https://github.com/mehrnet/mpm-packages">Example Packages</a></strong> - Working examples</li>
</ul>
<hr>
<p>For questions or issues, please visit: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>
    </section>
    <section class="content-section" data-lang="fa" hidden>
<!-- LANG:fa -->
<h1 id="راهنمای-نصب-و-تنظیمات">راهنمای نصب و تنظیمات</h1>
<p>راهنمای کامل برای نصب، تنظیم و شروع استفاده از MPM - مدیریت بسته های Mehr.</p>
<h2 id="فهرست-مطالب">فهرست مطالب</h2>
<ul>
<li><a href="#%D9%86%D8%B5%D8%A8">نصب</a></li>
<li><a href="#%D8%A7%D9%88%D9%84%DB%8C%D9%86-%D8%A7%D8%AC%D8%B1%D8%A7">اولین اجرا</a></li>
<li><a href="#%D9%BE%DB%8C%DA%A9%D8%B1%D8%A8%D9%86%D8%AF%DB%8C">پیکربندی</a></li>
<li><a href="#%D8%B4%D8%B1%D9%88%D8%B9-%DA%A9%D8%A7%D8%B1">شروع کار</a></li>
<li><a href="#%D8%AA%D9%88%D8%B3%D8%B9%D9%87-%D8%A8%D8%B3%D8%AA%D9%87">توسعه بسته</a></li>
<li><a href="#%D8%AA%D9%86%D8%B8%DB%8C%D9%85-%D9%85%D8%AE%D8%B2%D9%86">تنظیم مخزن</a></li>
<li><a href="#%D8%A7%D8%B3%D8%AA%D9%82%D8%B1%D8%A7%D8%B1">استقرار</a></li>
</ul>
<hr>
<h2 id="نصب">نصب</h2>
<h3 id="نصب-سریع">نصب سریع</h3>
<pre><code class="language-bash"># دانلود shell.php
wget https://raw.githubusercontent.com/mehrnet/mpm/main/shell.php

# تعیین دسترسی ها
chmod 644 shell.php

# تست نصب
php shell.php echo &quot;Hello, World!&quot;
</code></pre>
<h3 id="نصب-دستی">نصب دستی</h3>
<ol>
<li>فایل <code>shell.php</code> را از مخزن دانلود کنید</li>
<li>آن را در ریشه پروژه یا دایرکتوری سرور وب قرار دهید</li>
<li>اطمینان حاصل کنید که PHP 8.1+ نصب است</li>
<li>تایید کنید که افزونه <code>ZipArchive</code> فعال است (برای مدیریت بسته)</li>
</ol>
<h3 id="الزامات">الزامات</h3>
<ul>
<li><strong>PHP</strong>: نسخه 8.1 یا بالاتر</li>
<li><strong>افزونه ها</strong>: <code>ZipArchive</code> (برای مدیریت بسته)</li>
<li><strong>دسترسی ها</strong>: دسترسی خواندن/نوشتن به دایرکتوری پروژه</li>
</ul>
<h2 id="اولین-اجرا">اولین اجرا</h2>
<p>در اولین اجرا، MPM به طور خودکار فایل های پیکربندی را تولید می کند:</p>
<pre><code class="language-bash"># هر فرمندی را برای مقدار دهی اولیه اجرا کنید
php shell.php ls
</code></pre>
<p>این فایل های زیر را ایجاد می کند:</p>
<pre><code>.config/
├── key              # کلید API (64 کاراکتر هگزادسیمال)
├── repos.json       # پیکربندی آینه های مخزن
├── packages.json    # ثبت بسته های نصب شده
└── path.json        # الگوهای کننده فرماند
</code></pre>
<h3 id="کلید-api">کلید API</h3>
<p>کلید API شما در اولین دسترسی HTTP نمایش داده می شود یا به فایل <code>.config/key</code> در اولین اجرای CLI ذخیره می شود:</p>
<pre><code class="language-bash"># مشاهده کلید API شما
cat .config/key
</code></pre>
<p><strong>مهم:</strong> کلید API خود را محفوظ نگه دارید. هر کسی با دسترسی می تواند فرماند اجرا کند.</p>
<h2 id="پیکربندی">پیکربندی</h2>
<h3 id="آینه-های-مخزن">آینه های مخزن</h3>
<p>برای سفارشی کردن مخازن بسته، <code>.config/repos.json</code> را ویرایش کنید:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://repo.example.com&quot;,
    &quot;https://mirror1.example.com&quot;,
    &quot;https://mirror2.example.com&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.example.com&quot;
  ]
}
</code></pre>
<p>آینه ها به ترتیب درصورت شکست امتحال می شوند بدون تاخیر عقب نشینی.</p>
<h3 id="الگوهای-کننده-فرماند">الگوهای کننده فرماند</h3>
<p>برای سفارشی کردن محلی جستجوی shell برای فرماندهای سفارشی، <code>.config/path.json</code> را ویرایش کنید:</p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;,
  &quot;custom/handlers/[name].php&quot;
]
</code></pre>
<p>جانشین <code>[name]</code> با نام فرمند می شود.</p>
<h3 id="پیکربندی-خاص-محیط">پیکربندی خاص محیط</h3>
<p>برای محیط های مختلف، می توانید:</p>
<ol>
<li><p><strong>دایرکتوری های پیکربندی مختلف استفاده کنید:</strong></p>
<pre><code class="language-php">// اصلاح ثابت ها در shell.php (توصیه نشده است)
const DIR_CONFIG = &#39;.config&#39;;
</code></pre>
</li>
<li><p><strong>Symlink پیکربندی:</strong></p>
<pre><code class="language-bash">ln -s .config.production .config
</code></pre>
</li>
<li><p><strong>متغیرهای محیطی:</strong>
 دسترسی از طریق <code>php shell.php env list</code></p>
</li>
</ol>
<h2 id="شروع-کار">شروع کار</h2>
<h3 id="حالت-cli-توصیه-برای-توسعه">حالت CLI (توصیه برای توسعه)</h3>
<pre><code class="language-bash"># نمایش فهرست فایل ها
php shell.php ls

# خواندن محتویات فایل
php shell.php cat shell.php | head -20

# ایجاد دایرکتوری
php shell.php mkdir tmp

# کپی فایل ها
php shell.php cp shell.php shell.backup.php

# مدیریت بسته ها
php shell.php pkg search database
php shell.php pkg add users
php shell.php pkg list
php shell.php pkg upgrade
</code></pre>
<h3 id="حالت-http-تولید">حالت HTTP (تولید)</h3>
<ol>
<li><p><strong>سرور توسعه PHP را شروع کنید (تست کردن):</strong></p>
<pre><code class="language-bash">php -S localhost:8000
</code></pre>
</li>
<li><p><strong>کلید API خود را دریافت کنید:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
</code></pre>
</li>
<li><p><strong>فرماند ها را اجرا کنید:</strong></p>
<pre><code class="language-bash"># نمایش فهرست فایل ها
curl &quot;http://localhost:8000/shell.php/$KEY/ls&quot;

# خواندن فایل
curl &quot;http://localhost:8000/shell.php/$KEY/cat/README.md&quot;

# مدیریت بسته ها
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
</li>
</ol>
<h3 id="سرور-وب-تولید">سرور وب تولید</h3>
<p>برای تولید، از سرور وب مناسب استفاده کنید:</p>
<p><strong>Nginx:</strong></p>
<pre><code class="language-nginx">server {
    listen 80;
    server_name your-domain.com;
    root /var/www/shell;
    index shell.php;

    location / {
        try_files $uri $uri/ /shell.php$is_args$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index shell.php;
        include fastcgi_params;
    }
}
</code></pre>
<p><strong>Apache (.htaccess):</strong></p>
<pre><code class="language-apache">RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ shell.php/$1 [L,QSA]
</code></pre>
<h2 id="توسعه-بسته">توسعه بسته</h2>
<h3 id="ایجاد-بسته">ایجاد بسته</h3>
<ol>
<li><p><strong>ساختار بسته ایجاد کنید:</strong></p>
<pre><code>mypackage/
├── handler.php       # لازم: نقطه ورود
├── package.json      # لازم: فرادادها
├── lib/             # اختیاری: کد کتابخانه
└── data/            # اختیاری: فایل های داده
</code></pre>
</li>
<li><p><strong>handler.php بنویسید:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return &quot;Item 1\nItem 2\nItem 3&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;نام لازم است&#39;, 400);
            }
            return &quot;Created: $name&quot;;

        default:
            return &quot;Actions: list, create&quot;;
    }
};
</code></pre>
</li>
<li><p><strong>package.json ایجاد کنید:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Package description&quot;,
    &quot;author&quot;: &quot;Your Name&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
</code></pre>
</li>
</ol>
<h3 id="فیلدهای-فرادادهای-بسته">فیلدهای فرادادهای بسته</h3>
<table>
<thead>
<tr>
<th>فیلد</th>
<th>نوع</th>
<th>لازم</th>
<th>توضیح</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>رشته</td>
<td>بله</td>
<td>کوچک، بدون فاصله، استفاده شده در URL ها</td>
</tr>
<tr>
<td><code>name</code></td>
<td>رشته</td>
<td>بله</td>
<td>نام قابل خواندن</td>
</tr>
<tr>
<td><code>version</code></td>
<td>رشته</td>
<td>بله</td>
<td>نسخه درجه بندی معنایی (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>رشته</td>
<td>بله</td>
<td>توضیح مختصر</td>
</tr>
<tr>
<td><code>author</code></td>
<td>رشته</td>
<td>نه</td>
<td>نویسنده بسته</td>
</tr>
<tr>
<td><code>license</code></td>
<td>رشته</td>
<td>نه</td>
<td>شناسه مجوز (MIT, Apache-2.0, و غیره)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>آرایه</td>
<td>نه</td>
<td>آرایه شناسه های بسته</td>
</tr>
</tbody></table>
<h3 id="تست-بسته-شما">تست بسته شما</h3>
<p><strong>حالت CLI:</strong></p>
<pre><code class="language-bash"># نصب دستی
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# تست فرماند ها
php shell.php mypackage list
php shell.php mypackage create item-name
</code></pre>
<p><strong>حالت HTTP:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/create/item-name&quot;
</code></pre>
<h3 id="بهترین-عملکردها">بهترین عملکردها</h3>
<ol>
<li><p><strong>اعتبارسنجی ورودی:</strong></p>
<pre><code class="language-php">$id = $args[0] ?? null;
if (!$id || !is_numeric($id)) {
    throw new \RuntimeException(&#39;شناسه نامعتبر است&#39;, 400);
}
</code></pre>
</li>
<li><p><strong>مدیریت خطا:</strong></p>
<pre><code class="language-php">try {
    $data = json_decode(file_get_contents(&#39;data.json&#39;), true);
    if (!$data) {
        throw new \RuntimeException(&#39;JSON نامعتبر است&#39;, 400);
    }
} catch (\Throwable $e) {
    throw new \RuntimeException(&quot;Error: {$e-&gt;getMessage()}&quot;, 400);
}
</code></pre>
</li>
<li><p><strong>امنیت:</strong></p>
<pre><code class="language-php">// نادرست: استفاده مستقیم از ورودی کاربر
$file = $args[0];
return file_get_contents($file);  // آسیب پذیر برای پیمایش مسیر

// درست: اعتبار سنجی و محدود کردن مسیرها
$file = basename($args[0] ?? &#39;&#39;);  // حذف اجزای مسیر
$path = &quot;app/data/$file&quot;;
if (!file_exists($path)) {
    throw new \RuntimeException(&#39;فایل پیدا نشد&#39;, 404);
}
return file_get_contents($path);
</code></pre>
</li>
</ol>
<h2 id="تنظیم-مخزن">تنظیم مخزن</h2>
<h3 id="ایجاد-مخزن-بسته">ایجاد مخزن بسته</h3>
<ol>
<li><p><strong>ساختار مخزن ایجاد کنید:</strong></p>
<pre><code>my-repo/
└── main/
    ├── database.json
    ├── mypackage-1.0.0.zip
    └── otherapkg-1.0.0.zip
</code></pre>
</li>
<li><p><strong>ZIP بسته بسازید:</strong></p>
<pre><code class="language-bash">cd mypackage
zip -r ../my-repo/main/mypackage-1.0.0.zip .
</code></pre>
</li>
<li><p><strong>Checksum محاسبه کنید:</strong></p>
<pre><code class="language-bash">sha256sum my-repo/main/mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
</li>
<li><p><strong>database.json ایجاد کنید:</strong></p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;Package description&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;,
      &quot;author&quot;: &quot;Your Name&quot;,
      &quot;license&quot;: &quot;MIT&quot;
    }
  }
}
</code></pre>
</li>
<li><p><strong>مخزن را میزبانی کنید:</strong></p>
<ul>
<li>آپلود به GitHub: <code>https://github.com/user/repo/raw/main/main/</code></li>
<li>استفاده از CDN یا میزبانی استاتیک</li>
<li>اطمینان حاصل کنید HTTPS فعال است</li>
</ul>
</li>
<li><p><strong>پوسته را برای استفاده از مخزن شما تنظیم کنید:</strong>
 <code>.config/repos.json</code> را ویرایش کنید:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [&quot;https://github.com/user/repo/raw/main/main&quot;]
}
</code></pre>
</li>
</ol>
<h3 id="مثال-میزبانی-github">مثال میزبانی GitHub</h3>
<pre><code class="language-bash"># مخزن ایجاد کنید
mkdir -p my-packages/main
cd my-packages

# بسته ها اضافه کنید
cp /path/to/mypackage-1.0.0.zip main/
cat &gt; main/database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# به GitHub فشار دهید
git init
git add .
git commit -m &quot;Add packages&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# کاربران تنظیم می کنند: https://github.com/user/my-packages/raw/main/main
</code></pre>
<h2 id="استقرار">استقرار</h2>
<h3 id="توسعه">توسعه</h3>
<pre><code class="language-bash"># سرور درون ساخت PHP را اجرا کنید
php -S localhost:8000

# فرماند ها را تست کنید
php shell.php pkg list
curl &quot;http://localhost:8000/shell.php/$(cat .config/key)/pkg/list&quot;
</code></pre>
<h3 id="stagingتولید">Staging/تولید</h3>
<ol>
<li><p><strong>سرور وب مناسب استفاده کنید</strong> (Nginx, Apache, Caddy)</p>
</li>
<li><p><strong>HTTPS فعال کنید</strong> برای امنیت کلید API</p>
</li>
<li><p><strong>دسترسی های محدود تعیین کنید:</strong></p>
<pre><code class="language-bash">chmod 644 shell.php
chmod 700 .config
chmod 600 .config/key
</code></pre>
</li>
<li><p><strong>PHP-FPM را پیکربندی کنید</strong> برای عملکرد بهتر</p>
</li>
<li><p><strong>نظارت و ثبت را راه اندازی کنید</strong></p>
</li>
<li><p><strong>پشتیبان گیری منظم</strong> از دایرکتوری <code>.config/</code></p>
</li>
</ol>
<h3 id="استقرار-docker">استقرار Docker</h3>
<pre><code class="language-dockerfile">FROM php:8.1-fpm

# نصب افزونه ها
RUN docker-php-ext-install zip

# کپی shell
COPY shell.php /var/www/html/

# تعیین دسترسی ها
RUN chown -R www-data:www-data /var/www/html

WORKDIR /var/www/html
</code></pre>
<h3 id="تقویت-امنیت">تقویت امنیت</h3>
<ol>
<li><p><strong>محدود کردن دسترسی کلید API:</strong></p>
<pre><code class="language-bash">chmod 600 .config/key
chown www-data:www-data .config/key
</code></pre>
</li>
<li><p><strong>استفاده از کلیدهای خاص محیط</strong></p>
</li>
<li><p><strong>فعال کردن HTTPS فقط</strong> در تولید</p>
</li>
<li><p><strong>محدود کردن نرخ</strong> در سطح سرور وب</p>
</li>
<li><p><strong>نظارت بر تلاش های احراز هویت ناموفق</strong></p>
</li>
<li><p><strong>به روز رسانی های امنیتی منظم</strong></p>
</li>
</ol>
<h2 id="حل-مسائل">حل مسائل</h2>
<h3 id="مسائل-عام">مسائل عام</h3>
<p><strong>خطاهای &quot;اجازه رد شد&quot;:</strong></p>
<pre><code class="language-bash"># رفع دسترسی ها
chmod 755 .
chmod 644 shell.php
chmod -R 755 .config
</code></pre>
<p><strong>&quot;ZipArchive پیدا نشد&quot;:</strong></p>
<pre><code class="language-bash"># نصب افزونه
sudo apt-get install php-zip  # Debian/Ubuntu
sudo yum install php-zip       # CentOS/RHEL
</code></pre>
<p><strong>&quot;کلید API پیدا نشد&quot; (حالت CLI):</strong></p>
<pre><code class="language-bash"># تولید کلید به صورت دستی
php shell.php ls  # این .config/key را ایجاد می کند
</code></pre>
<p><strong>مسائل فایل قفل:</strong></p>
<pre><code class="language-bash"># اگر گیر کرد قفل اجباری باز کنید
php shell.php pkg unlock
</code></pre>
<h2 id="مراحل-بعدی">مراحل بعدی</h2>
<ul>
<li><a href="USAGE_FA.md">راهنمای مرجع استفاده</a> را برای مستندات فرماند کامل بخوانید</li>
<li><a href="PACKAGES_FA.md">توسعه بسته</a> را برای ایجاد بسته پیشرفته ببینید</li>
<li><a href="https://github.com/mehrnet/mpm-packages">بسته های نمونه</a> را بررسی کنید</li>
</ul>
<hr>
<p>برای پرسش ها یا مسائل، لطفا بازدید کنید: <a href="https://github.com/mehrnet/mpm">https://github.com/mehrnet/mpm</a></p>
<!-- LANG:fa -->
<h1 id="راهنمای-مرجع-استفاده">راهنمای مرجع استفاده</h1>
<p>مرجع فرماند کامل و مستندات API برای MPM - مدیریت بسته های Mehr.</p>
<h2 id="فهرست-مطالب-1">فهرست مطالب</h2>
<ul>
<li><a href="#%D9%81%D8%B1%D9%85%D8%AA-%D9%87%D8%A7%DB%8C-%D8%AF%D8%B1%D8%AE%D9%88%D8%A7%D8%B3%D8%AA">فرمت های درخواست</a></li>
<li><a href="#%D9%81%D8%B1%D9%85%D8%A7%D9%86%D8%AF%D9%87%D8%A7%DB%8C-%D8%AF%D8%B1%D9%88%D9%86-%D8%B3%D8%A7%D8%AE%D8%AA">فرماندهای درون ساخت</a></li>
<li><a href="#%D9%85%D8%AF%DB%8C%D8%B1%DB%8C%D8%AA-%D8%A8%D8%B3%D8%AA%D9%87">مدیریت بسته</a></li>
<li><a href="#%D9%BE%D8%B1%D9%88%D8%AA%DA%A9%D9%84-%D9%BE%D8%A7%D8%B3%D8%AE">پروتکل پاسخ</a></li>
<li><a href="#%D9%81%D8%A7%DB%8C%D9%84-%D9%87%D8%A7%DB%8C-%D8%AA%D9%86%D8%B8%DB%8C%D9%85%D8%A7%D8%AA">فایل های تنظیمات</a></li>
<li><a href="#%D9%81%D8%B1%D9%85%D8%A7%D9%86%D8%AF%D9%87%D8%A7%DB%8C-%D8%B3%D9%81%D8%A7%D8%B1%D8%B4%DB%8C">فرماندهای سفارشی</a></li>
<li><a href="#%D9%85%D8%B9%D9%85%D8%A7%D8%B1%DB%8C">معماری</a></li>
<li><a href="#%DA%A9%D8%A7%D8%B1%D8%A7%DB%8C%DB%8C">کارایی</a></li>
<li><a href="#%D8%AD%D9%84-%D9%85%D8%B3%D8%A7%D8%A6%D9%84">حل مسائل</a></li>
</ul>
<hr>
<h2 id="فرمت-های-درخواست">فرمت های درخواست</h2>
<h3 id="حالت-http">حالت HTTP</h3>
<p><strong>فرمت:</strong></p>
<pre><code>GET /shell.php/API_KEY/COMMAND/ARG0/ARG1/ARG2/...
</code></pre>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># دریافت کلید API
KEY=$(cat .config/key)

# نمایش فهرست فایل ها
curl &quot;http://localhost/shell.php/$KEY/ls&quot;

# خواندن فایل
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;

# نمایش متن با آرگومان های متعدد
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;

# مدیریت بسته ها
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
<p><strong>پاسخ:</strong></p>
<ul>
<li>موفقیت: HTTP 200 با پاسخ متنی ساده</li>
<li>خطا: HTTP 4xx/5xx با پیام خطا</li>
</ul>
<h3 id="حالت-cli">حالت CLI</h3>
<p><strong>فرمت:</strong></p>
<pre><code class="language-bash">php shell.php COMMAND ARG0 ARG1 ARG2 ...
</code></pre>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># نمایش فهرست فایل ها
php shell.php ls

# خواندن فایل
php shell.php cat README.md

# نمایش متن با آرگومان های متعدد
php shell.php echo hello world

# مدیریت بسته ها
php shell.php pkg search database
php shell.php pkg add users
</code></pre>
<p><strong>پاسخ:</strong></p>
<ul>
<li>موفقیت: خروجی به STDOUT، کد خروج 0</li>
<li>خطا: خروجی به STDERR با پیشوند &quot;Error: &quot;، کد خروج 1</li>
</ul>
<hr>
<h2 id="فرماندهای-درون-ساخت">فرماندهای درون ساخت</h2>
<h3 id="ls-path-1">ls [path]</h3>
<p>نمایش محتویات پوشه.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>path</code> (اختیاری): پوشه ای برای نمایش (پیش فرض: پوشه جاری)</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php ls
php shell.php ls app
php shell.php ls app/packages

# HTTP
curl &quot;http://localhost/shell.php/$KEY/ls&quot;
curl &quot;http://localhost/shell.php/$KEY/ls/app&quot;
</code></pre>
<p><strong>خروجی:</strong>
نام فایل های جدا شده با فاصله (بدون <code>.</code> و <code>..</code>)</p>
<p><strong>خطاها:</strong></p>
<ul>
<li>404: پوشه پیدا نشد</li>
<li>400: نمی توان پوشه را خواند</li>
<li>403: اعتبارسنجی مسیر ناموفق (مسیر مطلق یا <code>..</code>)</li>
</ul>
<hr>
<h3 id="cat--1">cat <file></h3>
<p>خواندن محتویات فایل.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>file</code> (اجباری): مسیر فایل</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cat README.md
php shell.php cat .config/key

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;
</code></pre>
<p><strong>خروجی:</strong>
محتویات فایل (حفظ قالب بندی و خطوط جدید)</p>
<p><strong>خطاها:</strong></p>
<ul>
<li>400: آرگومان فایل وجود ندارد یا فایل نیست</li>
<li>404: فایل پیدا نشد</li>
<li>403: اعتبارسنجی مسیر ناموفق</li>
</ul>
<hr>
<h3 id="rm--1">rm <file></h3>
<p>حذف فایل.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>file</code> (اجباری): مسیر فایل</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php rm temp.txt
php shell.php rm logs/old.log

# HTTP
curl &quot;http://localhost/shell.php/$KEY/rm/temp.txt&quot;
</code></pre>
<p><strong>خروجی:</strong>
رشته خالی در صورت موفقیت (رفتار POSIX)</p>
<p><strong>خطاها:</strong></p>
<ul>
<li>400: آرگومان فایل وجود ندارد، فایل نیست یا نمی توان حذف کرد</li>
<li>404: فایل پیدا نشد</li>
<li>403: اعتبارسنجی مسیر ناموفق</li>
</ul>
<hr>
<h3 id="mkdir--1">mkdir <path></h3>
<p>ایجاد پوشه (بصورت بازگشتی).</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>path</code> (اجباری): مسیر پوشه ای برای ایجاد</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php mkdir uploads
php shell.php mkdir app/data/cache

# HTTP
curl &quot;http://localhost/shell.php/$KEY/mkdir/uploads&quot;
</code></pre>
<p><strong>خروجی:</strong>
رشته خالی در صورت موفقیت</p>
<p><strong>خطاها:</strong></p>
<ul>
<li>400: آرگومان مسیر وجود ندارد، قبلا وجود دارد یا نمی توان ایجاد کرد</li>
<li>403: اعتبارسنجی مسیر ناموفق</li>
</ul>
<hr>
<h3 id="cp---1">cp <src> <dst></h3>
<p>کپی فایل.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>src</code> (اجباری): مسیر فایل منبع</li>
<li><code>dst</code> (اجباری): مسیر فایل مقصد</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cp config.json config.backup.json
php shell.php cp README.md docs/README.md

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cp/config.json/config.backup.json&quot;
</code></pre>
<p><strong>خروجی:</strong>
رشته خالی در صورت موفقیت</p>
<p><strong>خطاها:</strong></p>
<ul>
<li>400: آرگومان ها وجود ندارند، منبع فایل نیست یا نمی توان کپی کرد</li>
<li>404: فایل منبع پیدا نشد</li>
<li>403: اعتبارسنجی مسیر ناموفق</li>
</ul>
<hr>
<h3 id="echo--1">echo <text>...</h3>
<p>نمایش آرگومان های متنی.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>text...</code> (اجباری): یک یا بیشتر آرگومان متنی</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php echo hello
php shell.php echo hello world &quot;from shell&quot;

# HTTP
curl &quot;http://localhost/shell.php/$KEY/echo/hello&quot;
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;
</code></pre>
<p><strong>خروجی:</strong>
آرگومان های جدا شده با فاصله</p>
<hr>
<h3 id="env-action-name-1">env [action] [name]</h3>
<p>مدیریت متغیرهای محیطی.</p>
<p><strong>اقدام ها:</strong></p>
<ul>
<li><code>list</code> (پیش فرض): نمایش تمام متغیرهای محیطی</li>
<li><code>get &lt;name&gt;</code>: دریافت مقدار متغیر خاص</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php env list
php shell.php env get PATH
php shell.php env get HOME

# HTTP
curl &quot;http://localhost/shell.php/$KEY/env/list&quot;
curl &quot;http://localhost/shell.php/$KEY/env/get/PATH&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<ul>
<li><code>list</code>: یک متغیر در هر سطر (<code>KEY=value</code>)</li>
<li><code>get</code>: فقط مقدار متغیر</li>
</ul>
<p><strong>خطاها:</strong></p>
<ul>
<li>404: متغیر پیدا نشد یا اقدام نامعلوم</li>
<li>400: نام متغیر برای <code>get</code> وجود ندارد</li>
</ul>
<hr>
<h2 id="مدیریت-بسته">مدیریت بسته</h2>
<h3 id="pkg-add-package-1">pkg add [PACKAGE...]</h3>
<p>نصب بسته ها با حل خودکار وابستگی ها.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>PACKAGE...</code> (اجباری): یک یا بیشتر نام بسته</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg add users
php shell.php pkg add users auth database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users/auth&quot;
</code></pre>
<p><strong>فرایند:</strong></p>
<ol>
<li>بازیابی پایگاه داده مخزن</li>
<li>حل وابستگی ها (DFS مرتب سازی توپولوژیکی)</li>
<li>دانلود تمام بسته ها با تایید checksum</li>
<li>استخراج تمام بسته ها به ریشه پروژه</li>
<li>ثبت بسته ها به طور اتمی</li>
</ol>
<p><strong>خروجی:</strong></p>
<pre><code>بسته های نصب شامل: dependency1, dependency2, users

در حال دانلود بسته ها...
تمام بسته ها دانلود و تایید شدند

در حال استخراج بسته ها...
استخراج شده dependency1 (1.0.0)
استخراج شده dependency2 (2.0.0)
استخراج شده users (3.0.0)

در حال ثبت بسته ها...

موفقیت آمیز نصب 3 بسته: dependency1, dependency2, users
</code></pre>
<p><strong>خطاها:</strong></p>
<ul>
<li>404: بسته پیدا نشد</li>
<li>400: وابستگی دایره ای شناسایی شد</li>
<li>503: تمام آینه ها ناموفق بودند یا قفل نگه داشته شده است</li>
</ul>
<hr>
<h3 id="pkg-del--1">pkg del <PACKAGE></h3>
<p>حذف بسته (در صورتی که بسته های دیگر به آن وابسته باشند، شکست می خورد).</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>PACKAGE</code> (اجباری): نام بسته</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg del users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/del/users&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>بسته حذف شد: users (نسخه 1.0.0) - 15 فایل حذف شد، 3 پوشه خالی حذف شد
</code></pre>
<p><strong>خطاها:</strong></p>
<ul>
<li>404: بسته نصب نشده است</li>
<li>400: بسته توسط بسته های دیگر لازم است</li>
<li>503: قفل نگه داشته شده است</li>
</ul>
<hr>
<h3 id="pkg-upgrade-package-1">pkg upgrade [PACKAGE]</h3>
<p>ارتقای تمام بسته ها یا بسته خاص به آخرین نسخه.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>PACKAGE</code> (اختیاری): نام بسته (اگر حذف شود، تمام را ارتقا دهد)</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg upgrade           # ارتقای تمام
php shell.php pkg upgrade users     # ارتقای خاص

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade/users&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>ارتقای users از 1.0.0 به 1.1.0

در حال دانلود بروز رسانی بسته ها...
تمام بروز رسانی بسته ها دانلود و تایید شدند

در حال استخراج بروز رسانی بسته ها...
استخراج شده users ارتقا به 1.1.0

در حال ثبت بروز رسانی ها...

موفقیت آمیز ارتقای 1 بسته: users
</code></pre>
<hr>
<h3 id="pkg-update-1">pkg update</h3>
<p>تازه کردن کش مخزن (بازیابی پایگاه داده بسته های جدید).</p>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg update

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/update&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>کش مخزن تازه شد - 42 بسته دردسترس
</code></pre>
<hr>
<h3 id="pkg-list-filter-1">pkg list [FILTER]</h3>
<p>نمایش بسته های نصب شده.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>FILTER</code> (اختیاری): فیلتر بر اساس نام بسته (غیر حساس به بزرگی و کوچکی حروف)</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg list
php shell.php pkg list auth

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/list/auth&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>بسته های نصب شده:

  users                 v1.0.0      نصب شده: 1403-11-25
  auth                  v2.0.0      نصب شده: 1403-11-25 (وابسته: users)
  database              v1.5.0      نصب شده: 1403-11-25 (وابسته: users)
</code></pre>
<hr>
<h3 id="pkg-search--1">pkg search <KEYWORD></h3>
<p>جستجوی بسته های دردسترس.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>KEYWORD</code> (اجباری): واژه جستجو</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg search database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>3 بسته پیدا شد:

  mysql-driver          v1.0.0      درایور پایگاه داده MySQL [نصب شده]
    اتصال MySQL برای برنامه ها

  postgres-driver       v1.0.0      درایور PostgreSQL
    سازنده پایگاه داده PostgreSQL

  database-tools        v2.0.0      ابزار مدیریت پایگاه داده
    ابزارهای عمومی و کمکی پایگاه داده
</code></pre>
<hr>
<h3 id="pkg-info--1">pkg info <PACKAGE></h3>
<p>نمایش اطلاعات دقیق بسته.</p>
<p><strong>آرگومان ها:</strong></p>
<ul>
<li><code>PACKAGE</code> (اجباری): نام بسته</li>
</ul>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg info users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/info/users&quot;
</code></pre>
<p><strong>خروجی:</strong></p>
<pre><code>بسته: سیستم مدیریت کاربر
شناسه: users
آخرین: 1.0.0
توضیح: مدیریت کاربر کامل با احراز هویت
نویسنده: تیم Mehrnet
مجوز: MIT

نصب شده: v1.0.0 (در 1403-11-25 10:30:00)
وابستگی ها: هیچ

نسخه های دردسترس:
  v1.0.0 - منتشر شده: 1403-11-25
  v0.9.0 - منتشر شده: 1403-11-11 (نیاز دارد: auth-lib)
</code></pre>
<p><strong>خطاها:</strong></p>
<ul>
<li>404: بسته پیدا نشد</li>
</ul>
<hr>
<h3 id="pkg-help-1">pkg help</h3>
<p>نمایش کمک مدیریت بسته.</p>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg help

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/help&quot;
</code></pre>
<hr>
<h3 id="pkg-version-1">pkg version</h3>
<p>نمایش نسخه مدیریت بسته.</p>
<p><strong>مثال ها:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg version

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/version&quot;
</code></pre>
<hr>
<h2 id="پروتکل-پاسخ">پروتکل پاسخ</h2>
<h3 id="کدهای-وضعیت-http">کدهای وضعیت HTTP</h3>
<table>
<thead>
<tr>
<th>کد</th>
<th>معنی</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>موفقیت</td>
</tr>
<tr>
<td>400</td>
<td>درخواست نامعتبر (آرگومان های نامعتبر، خطاهای عملیاتی)</td>
</tr>
<tr>
<td>403</td>
<td>ممنوع (کلید API نامعتبر، اعتبارسنجی مسیر ناموفق)</td>
</tr>
<tr>
<td>404</td>
<td>پیدا نشد (فرمند، بسته یا فایل پیدا نشد)</td>
</tr>
<tr>
<td>503</td>
<td>سرویس در دسترس نیست (تمام آینه ها ناموفق، قفل نگه داشته شده)</td>
</tr>
</tbody></table>
<h3 id="کدهای-خروج-cli">کدهای خروج CLI</h3>
<table>
<thead>
<tr>
<th>کد</th>
<th>معنی</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>موفقیت</td>
</tr>
<tr>
<td>1</td>
<td>خطا (هر نوع)</td>
</tr>
</tbody></table>
<h3 id="معنی-شناسی-posix">معنی شناسی POSIX</h3>
<ul>
<li>فرماندهایی که خروجی دارند داده بر می گردانند</li>
<li>فرماندهایی که خروجی ندارند رشته خالی برمی گردانند (اما همچنان 0/200 خروج دارند)</li>
<li>خطاها استثنایی با کدهای مناسب پرتاب می کنند</li>
</ul>
<hr>
<h2 id="فایل-های-تنظیمات">فایل های تنظیمات</h2>
<h3 id="configkey-1">.config/key</h3>
<p>فایل متنی ساده حاوی کلید API 64 کاراکتری هگزادسیمال.</p>
<p><strong>فرمت:</strong></p>
<pre><code>abc123def456789...  (64 کاراکتر هگزادسیمال)
</code></pre>
<p><strong>تولید:</strong></p>
<pre><code class="language-php">$key = bin2hex(random_bytes(32));
</code></pre>
<p><strong>امنیت:</strong></p>
<ul>
<li>به طور خودکار در اولین اجرا تولید می شود</li>
<li>برای احراز هویت HTTP استفاده می شود</li>
<li>به طور خودکار برای حالت CLI بارگذاری می شود</li>
<li>مقایسه ایمن زمانی از طریق <code>hash_equals()</code></li>
</ul>
<hr>
<h3 id="configreposjson-1">.config/repos.json</h3>
<p>پیکربندی آینه های مخزن.</p>
<p><strong>فرمت:</strong></p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://primary-mirror.com/packages&quot;,
    &quot;https://secondary-mirror.com/packages&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.com/packages&quot;
  ]
}
</code></pre>
<p><strong>انتخاب آینه:</strong></p>
<ul>
<li>آینه ها به ترتیب آرایه در صورت شکست امتحان می شوند</li>
<li>بدون تاخیر عقب نشینی</li>
<li>اولین آینه موفق برنده می شود</li>
</ul>
<hr>
<h3 id="configpackagesjson-1">.config/packages.json</h3>
<p>ثبت بسته های نصب شده.</p>
<p><strong>فرمت:</strong></p>
<pre><code class="language-json">{
  &quot;createdAt&quot;: &quot;2025-01-15T10:00:00Z&quot;,
  &quot;updatedAt&quot;: &quot;2025-01-15T10:30:00Z&quot;,
  &quot;packages&quot;: {
    &quot;users&quot;: {
      &quot;version&quot;: &quot;1.0.0&quot;,
      &quot;installed_at&quot;: &quot;2025-01-15T10:30:00Z&quot;,
      &quot;dependencies&quot;: [],
      &quot;files&quot;: [
        &quot;./app/packages/users/handler.php&quot;,
        &quot;./app/packages/users/module.php&quot;
      ],
      &quot;download_url&quot;: &quot;https://mirror.com/users-1.0.0.zip&quot;,
      &quot;download_time&quot;: &quot;2025-01-15T10:29:00Z&quot;,
      &quot;checksum&quot;: &quot;sha256:abc123...&quot;,
      &quot;repository&quot;: &quot;main&quot;
    }
  }
}
</code></pre>
<p><strong>فرادادها:</strong></p>
<ul>
<li><code>createdAt</code>: زمان ایجاد ثبت</li>
<li><code>updatedAt</code>: آخرین زمان تغییر</li>
<li><code>files</code>: آرایه مسیرهای فایل های نصب شده (برای حذف)</li>
<li><code>download_url</code>: آینه منبع استفاده شده</li>
<li><code>checksum</code>: checksum تایید شده</li>
</ul>
<hr>
<h3 id="configpathjson-1">.config/path.json</h3>
<p>الگوهای کشف کننده فرمند.</p>
<p><strong>فرمت:</strong></p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;
]
</code></pre>
<p><strong>تطابق الگو:</strong></p>
<ul>
<li><code>[name]</code> با نام فرمند جایگزین می شود</li>
<li>الگوها به ترتیب آرایه جستجو می شوند</li>
<li>اولین تطابق برنده می شود</li>
</ul>
<p><strong>مثال:</strong>
فرمند <code>users</code> جستجو می کند:</p>
<ol>
<li><code>app/packages/users/handler.php</code></li>
<li><code>bin/users.php</code></li>
</ol>
<hr>
<h2 id="فرماندهای-سفارشی">فرماندهای سفارشی</h2>
<h3 id="فرمت-کننده">فرمت کننده</h3>
<p>کننده ها فایل های PHP هستند که قابل فراخوانی بر می گردانند:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // پردازش آرگومان ها
    // بازگشت پاسخ یا پرتاب استثنا
    return &quot;output&quot;;
};
</code></pre>
<h3 id="پردازش-آرگومان">پردازش آرگومان</h3>
<p><strong>حالت HTTP:</strong></p>
<pre><code>GET /shell.php/KEY/mycommand/action/arg1/arg2
                       ↓        ↓      ↓    ↓
                   فرمند   args[0] [1]  [2]
</code></pre>
<p><strong>حالت CLI:</strong></p>
<pre><code class="language-bash">php shell.php mycommand action arg1 arg2
                ↓        ↓      ↓    ↓
            فرمند   args[0] [1]  [2]
</code></pre>
<p><strong>کننده دریافت می کند:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];  // &#39;action&#39;
    $arg1 = $args[1];    // &#39;arg1&#39;
    $arg2 = $args[2];    // &#39;arg2&#39;
}
</code></pre>
<h3 id="مدیریت-خطا">مدیریت خطا</h3>
<p>پرتاب استثناهای داخل کدهای وضعیت HTTP:</p>
<pre><code class="language-php">// درخواست نامعتبر
throw new \RuntimeException(&#39;Invalid input&#39;, 400);

// پیدا نشد
throw new \RuntimeException(&#39;Item not found&#39;, 404);

// ممنوع
throw new \RuntimeException(&#39;Permission denied&#39;, 403);
</code></pre>
<p><strong>توجه:</strong> حالت CLI تمام کدهای خطا را به کد خروج 1 تبدیل می کند.</p>
<h3 id="مثال-کننده">مثال کننده</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            // خواندن داده ها
            $data = json_decode(
                file_get_contents(&#39;app/data/items.json&#39;),
                true
            );
            return json_encode($data);

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;شناسه لازم است&#39;, 400);
            }
            // واکشی آیتم
            return &quot;Item: $id&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;نام لازم است&#39;, 400);
            }
            // ایجاد آیتم
            return &quot;Created: $name&quot;;

        case &#39;help&#39;:
            return &quot;اقدام ها: list, get &lt;id&gt;, create &lt;name&gt;&quot;;

        default:
            throw new \RuntimeException(&quot;اقدام نامعلوم: $action&quot;, 404);
    }
};
</code></pre>
<hr>
<h2 id="معماری">معماری</h2>
<h3 id="ساختار-فایل">ساختار فایل</h3>
<pre><code>.
├── shell.php              # اجرایی اصلی (2300 سطر)
├── .config/               # پیکربندی (ایجاد خودکار)
│   ├── key                # کلید API
│   ├── repos.json         # آینه های مخزن
│   ├── packages.json      # بسته های نصب شده
│   └── path.json          # الگوهای کننده
├── .cache/                # کش (ایجاد خودکار)
│   ├── shell.lock         # فایل قفل
│   └── *.zip              # بسته های دانلود شده
└── app/packages/          # بسته های نصب شده
    └── [package]/
        └── handler.php
</code></pre>
<h3 id="جریان-اجرا">جریان اجرا</h3>
<pre><code>1. شناسایی Runtime (HTTP/CLI)
    ↓
2. مقدار دهی اولیه فایل های پیکربندی
    ↓
3. تجزیه درخواست (PATH_INFO یا argv)
    ↓
4. اعتبارسنجی کلید API
    ↓
5. اجرای فرمند
    ├─ فرمند درون ساخت
    ├─ مدیریت بسته
    └─ کننده سفارشی
    ↓
6. ارسال پاسخ (سرصفحه های HTTP یا STDOUT/STDERR)
</code></pre>
<h3 id="جریان-مدیریت-بسته">جریان مدیریت بسته</h3>
<p><strong>نصب:</strong></p>
<pre><code>1. حل وابستگی ها (DFS مرتب سازی توپولوژیکی)
    ↓
2. دانلود تمام بسته ها (با تایید checksum)
    ↓
3. استخراج تمام بسته ها (با حل تضاد)
    ↓
4. ثبت در .config/packages.json (اتمی)
</code></pre>
<p><strong>ویژگی های کلیدی:</strong></p>
<ul>
<li><strong>حل وابستگی:</strong> پیچیدگی O(V + E)</li>
<li><strong>شناسایی دایره ای:</strong> جستجوهای مجموعه O(1)</li>
<li><strong>تایید Checksum:</strong> SHA256 با مقایسه ایمن زمانی</li>
<li><strong>عقب نشینی آینه:</strong> تلاش مجدد ترتیبی، بدون تاخیر</li>
<li><strong>عملیات اتمی:</strong> نصب تمام یا هیچ</li>
<li><strong>حل تضاد:</strong> فایل های موجود با <code>-2</code>، <code>-3</code> و غیره نام گذاری می شوند</li>
</ul>
<h3 id="مدل-امنیت">مدل امنیت</h3>
<ol>
<li><p><strong>احراز هویت:</strong></p>
<ul>
<li>کلید API تصادفی 64 کاراکتری</li>
<li>مقایسه ایمن زمانی از طریق <code>hash_equals()</code></li>
<li>بارگذاری خودکار در حالت CLI</li>
</ul>
</li>
<li><p><strong>اعتبارسنجی مسیر:</strong></p>
<ul>
<li>مسدود کردن مسیرهای مطلق (<code>/etc/passwd</code>)</li>
<li>مسدود کردن پیمایش دایرکتوری (<code>../../../</code>)</li>
<li>اعمال بر تمام عملیات فایل</li>
</ul>
</li>
<li><p><strong>امنیت بسته:</strong></p>
<ul>
<li>تایید checksum SHA256</li>
<li>شناسایی پیمایش Zip</li>
<li>اجرای HTTPS آینه</li>
</ul>
</li>
</ol>
<hr>
<h2 id="کارایی">کارایی</h2>
<h3 id="معیارهای-عملکرد">معیارهای عملکرد</h3>
<ul>
<li><strong>اجرای برنامه:</strong> &lt;1ms (اندازه گیری شده از طریق نمایه گری)</li>
<li><strong>سربار سرور درون ساخت:</strong> 1000ms+ (در تولید از سرور وب مناسب استفاده کنید)</li>
<li><strong>دانلود بسته:</strong> بستگی به سرعت شبکه و آینه دارد</li>
<li><strong>حل وابستگی:</strong> O(V + E) که V = بسته ها، E = وابستگی ها</li>
</ul>
<h3 id="نکات-بهینه-سازی">نکات بهینه سازی</h3>
<ol>
<li><strong>استفاده از سرور وب تولید</strong> (Nginx, Apache)</li>
<li><strong>فعال کردن کش کد PHP</strong> (OPcache)</li>
<li><strong>استفاده از CDN برای آینه های بسته</strong></li>
<li><strong>کاهش پیچیدگی کننده سفارشی</strong></li>
<li><strong>ذخیره سازی پایگاه داده بسته به طور محلی</strong></li>
</ol>
<hr>
<h2 id="حل-مسائل-1">حل مسائل</h2>
<h3 id="کلید-api-نامعتبر">&quot;کلید API نامعتبر&quot;</h3>
<p><strong>HTTP 403</strong></p>
<p><strong>علت:</strong> کلید API وجود ندارد یا نامعتبر است</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># بررسی کلید
cat .config/key

# تولید مجدد کلید (حذف و دوباره اجرا کنید)
rm .config/key
php shell.php ls
</code></pre>
<hr>
<h3 id="کلید-api-پیدا-نشد-cli">&quot;کلید API پیدا نشد&quot; (CLI)</h3>
<p><strong>کد خروج 1</strong></p>
<p><strong>علت:</strong> فایل <code>.config/key</code> وجود ندارد</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># مقدار دهی اولیه shell
php shell.php ls
</code></pre>
<hr>
<h3 id="فرمند-پیدا-نشد">&quot;فرمند پیدا نشد&quot;</h3>
<p><strong>HTTP 404 / کد خروج 1</strong></p>
<p><strong>علت:</strong> فایل کننده پیدا نشد</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># بررسی الگوهای کننده
cat .config/path.json

# تایید وجود کننده
ls app/packages/[command]/handler.php
ls bin/[command].php
</code></pre>
<hr>
<h3 id="عملیات-pkg-دیگری-در-حال-انجام-است">&quot;عملیات pkg دیگری در حال انجام است&quot;</h3>
<p><strong>HTTP 503 / کد خروج 1</strong></p>
<p><strong>علت:</strong> فایل قفل وجود دارد</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># منتظر تکمیل عملیات یا قفل اجباری باز کنید
php shell.php pkg unlock

# یا به صورت دستی حذف کنید
rm .cache/shell.lock
</code></pre>
<hr>
<h3 id="بسته-پیدا-نشد">&quot;بسته پیدا نشد&quot;</h3>
<p><strong>HTTP 404 / کد خروج 1</strong></p>
<p><strong>علت:</strong> بسته در مخزن نیست</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># تازه کردن کش مخزن
php shell.php pkg update

# جستجوی بسته
php shell.php pkg search keyword
</code></pre>
<hr>
<h3 id="وابستگی-دایره-ای">&quot;وابستگی دایره ای&quot;</h3>
<p><strong>HTTP 400 / کد خروج 1</strong></p>
<p><strong>علت:</strong> چرخه وابستگی بسته (A → B → C → A)</p>
<p><strong>حل:</strong>
بررسی وابستگی های بسته و حذف چرخه. این یک مسئله مخزن بسته است.</p>
<hr>
<h3 id="نمی-توان-حذف-کرد---موارد-دیگر-نیاز-دارند">&quot;نمی توان حذف کرد - موارد دیگر نیاز دارند&quot;</h3>
<p><strong>HTTP 400 / کد خروج 1</strong></p>
<p><strong>علت:</strong> بسته های دیگر به بسته هدف وابسته اند</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># اولا بسته های وابسته را حذف کنید
php shell.php pkg del dependent-package
php shell.php pkg del target-package
</code></pre>
<hr>
<h3 id="خطاهای-اجازه">خطاهای اجازه</h3>
<p><strong>علت:</strong> دسترسی نقش های سیستم فایل</p>
<p><strong>حل:</strong></p>
<pre><code class="language-bash"># رفع اجازه ها
chmod 755 .
chmod 644 shell.php
chmod 755 .config
chmod 644 .config/*
chmod 755 .cache
</code></pre>
<hr>
<h2 id="همچنین-ببینید">همچنین ببینید</h2>
<ul>
<li><strong><a href="INSTALL_FA.md">راهنمای نصب</a></strong> - تنظیمات و پیکربندی</li>
<li><strong><a href="PACKAGES_FA.md">توسعه بسته</a></strong> - ایجاد بسته</li>
<li><strong><a href="https://github.com/mehrnet/mpm">مخزن GitHub</a></strong> - کد منبع</li>
</ul>
<hr>
<p>برای پرسش ها یا مسائل، لطفا بازدید کنید: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>
<!-- LANG:fa -->
<h1 id="راهنمای-توسعه-بسته">راهنمای توسعه بسته</h1>
<p>راهنمای کامل برای ایجاد، تست و توزیع بسته های MPM (مدیریت بسته های Mehr).</p>
<p>برای دستورالعمل های نصب و تنظیمات، ببینید <a href="INSTALL_FA.md">INSTALL_FA.md</a> یا <a href="USAGE_FA.md">USAGE_FA.md</a>.</p>
<hr>
<h2 id="فهرست-مطالب-2">فهرست مطالب</h2>
<ul>
<li><a href="#%D8%B4%D8%B1%D9%88%D8%B9-%D8%B3%D8%B1%DB%8C%D8%B9">شروع سریع</a></li>
<li><a href="#%D8%B3%D8%A7%D8%AE%D8%AA%D8%A7%D8%B1-%D8%A8%D8%B3%D8%AA%D9%87">ساختار بسته</a></li>
<li><a href="#%D9%BE%DB%8C%D8%A7%D8%AF%D9%87-%D8%B3%D8%A7%D8%B2%DB%8C-%DA%A9%D9%86%D9%86%D8%AF%D9%87">پیاده سازی کننده</a></li>
<li><a href="#%D9%81%D8%B1%D8%A7%D8%AF%D8%A7%D8%AF%D9%87%D8%A7%DB%8C-%D8%A8%D8%B3%D8%AA%D9%87">فرادادهای بسته</a></li>
<li><a href="#%D8%AA%D8%B3%D8%AA-%D8%A8%D8%B3%D8%AA%D9%87-%D9%87%D8%A7">تست بسته ها</a></li>
<li><a href="#%D8%AA%D9%88%D8%B2%DB%8C%D8%B9">توزیع</a></li>
<li><a href="#%D8%A8%D9%87%D8%AA%D8%B1%DB%8C%D9%86-%D8%B9%D9%85%D9%84%DA%A9%D8%B1%D8%AF%D9%87%D8%A7">بهترین عملکردها</a></li>
<li><a href="#%D9%85%D8%AB%D8%A7%D9%84-%D9%87%D8%A7">مثال ها</a></li>
</ul>
<hr>
<h2 id="شروع-سریع">شروع سریع</h2>
<p>بسته حداقل را در 3 مرحله ایجاد کنید:</p>
<pre><code class="language-bash"># 1. ساختار بسته ایجاد کنید
mkdir -p mypackage
cd mypackage

# 2. کننده ایجاد کنید
cat &gt; handler.php &lt;&lt; &#39;EOF&#39;
&lt;?php
return function(array $args): string {
    return &quot;سلام از mypackage!&quot;;
};
EOF

# 3. فرادادها ایجاد کنید
cat &gt; package.json &lt;&lt; &#39;EOF&#39;
{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;یک بسته ساده&quot;,
    &quot;author&quot;: &quot;نام شما&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
EOF

# تست کنید
cd ..
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/
php shell.php mypackage
</code></pre>
<hr>
<h2 id="ساختار-بسته">ساختار بسته</h2>
<h3 id="فایل-های-لازم">فایل های لازم</h3>
<pre><code>mypackage/
├── handler.php       # لازم: نقطه ورود
└── package.json      # لازم: فرادادها
</code></pre>
<h3 id="ساختار-اختیاری">ساختار اختیاری</h3>
<pre><code>mypackage/
├── handler.php       # نقطه ورود (لازم)
├── package.json      # فرادادها (لازم)
├── lib/             # کد کتابخانه
│   ├── MyClass.php
│   └── helpers.php
├── data/            # فایل های داده
│   └── config.json
├── views/           # الگو ها
│   └── template.html
└── README.md        # مستندات بسته
</code></pre>
<h3 id="استخراج-فایل">استخراج فایل</h3>
<p>بسته ها به ریشه پروژه استخراج می شوند و مسیرها حفظ می شوند:</p>
<p><strong>بسته شامل:</strong></p>
<pre><code>handler.php
module.php
lib/Database.php
data/schema.json
</code></pre>
<p><strong>استخراج به:</strong></p>
<pre><code>./handler.php
./module.php
./lib/Database.php
./data/schema.json
</code></pre>
<p>برای ماژول های قالب Mehr، استفاده کنید:</p>
<pre><code>app/packages/[name]/handler.php
app/packages/[name]/module.php
</code></pre>
<hr>
<h2 id="پیاده-سازی-کننده">پیاده سازی کننده</h2>
<h3 id="کننده-پایه">کننده پایه</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // اقدام واحد
    return &quot;سلام، دنیا!&quot;;
};
</code></pre>
<h3 id="کننده-چند-اقدامی">کننده چند اقدامی</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return handleList();

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;شناسه لازم است&#39;, 400);
            }
            return handleGet($id);

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;نام لازم است&#39;, 400);
            }
            return handleCreate($name);

        case &#39;delete&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;شناسه لازم است&#39;, 400);
            }
            return handleDelete($id);

        case &#39;help&#39;:
            return &lt;&lt;&lt;&#39;EOF&#39;
اقدام های دردسترس:
  list              - نمایش تمام آیتم ها
  get &lt;id&gt;          - دریافت آیتم با شناسه
  create &lt;name&gt;     - ایجاد آیتم جدید
  delete &lt;id&gt;       - حذف آیتم
EOF;

        default:
            throw new \RuntimeException(&quot;اقدام نامعلوم: $action&quot;, 404);
    }
};

function handleList(): string {
    return &quot;item1\nitem2\nitem3&quot;;
}

function handleGet(string $id): string {
    // بارگذاری از فایل، پایگاه داده، و غیره
    return &quot;Item data for: $id&quot;;
}

function handleCreate(string $name): string {
    // ایجاد و ذخیره
    return &quot;Created: $name&quot;;
}

function handleDelete(string $id): string {
    // حذف آیتم
    return &quot;Deleted: $id&quot;;
}
</code></pre>
<h3 id="پردازش-آرگومان-1">پردازش آرگومان</h3>
<p>آرگومان ها در هر دو حالت HTTP و CLI یکسان اند:</p>
<p><strong>HTTP:</strong></p>
<pre><code>GET /shell.php/KEY/users/create/alice/alice@example.com
                    ↓      ↓      ↓         ↓
                فرمند args[0] args[1]  args[2]
</code></pre>
<p><strong>CLI:</strong></p>
<pre><code class="language-bash">php shell.php users create alice alice@example.com
               ↓      ↓      ↓         ↓
           فرمند args[0] args[1]  args[2]
</code></pre>
<p><strong>کننده:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];    // &#39;create&#39;
    $name = $args[1];      // &#39;alice&#39;
    $email = $args[2];     // &#39;alice@example.com&#39;
}
</code></pre>
<h3 id="عملیات-فایل">عملیات فایل</h3>
<p>کننده ها در دایرکتوری shell.php اجرا می شوند. از مسیرهای نسبی استفاده کنید:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // خواندن فایل داده
    $data = json_decode(
        file_get_contents(&#39;app/data/items.json&#39;),
        true
    );

    // تغییر داده ها
    $data[&#39;new_item&#39;] = $args[0] ?? &#39;default&#39;;

    // بازنویسی
    file_put_contents(
        &#39;app/data/items.json&#39;,
        json_encode($data, JSON_PRETTY_PRINT)
    );

    return &quot;بروز رسانی شد&quot;;
};
</code></pre>
<h3 id="مدیریت-خطا-1">مدیریت خطا</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $id = $args[0] ?? null;

    // اعتبارسنجی
    if (!$id) {
        throw new \RuntimeException(&#39;شناسه لازم است&#39;, 400);
    }

    if (!is_numeric($id)) {
        throw new \RuntimeException(&#39;شناسه باید عددی باشد&#39;, 400);
    }

    // عملیات فایل
    $file = &quot;app/data/$id.json&quot;;
    if (!file_exists($file)) {
        throw new \RuntimeException(&#39;آیتم پیدا نشد&#39;, 404);
    }

    try {
        $content = file_get_contents($file);
        $data = json_decode($content, true);

        if (!$data) {
            throw new \RuntimeException(&#39;JSON نامعتبر است&#39;, 400);
        }

        return json_encode($data);
    } catch (\Throwable $e) {
        throw new \RuntimeException(
            &quot;خرابی در خواندن آیتم: {$e-&gt;getMessage()}&quot;,
            400
        );
    }
};
</code></pre>
<h3 id="فرمت-های-پاسخ">فرمت های پاسخ</h3>
<p><strong>متن ساده:</strong></p>
<pre><code class="language-php">return &quot;item1\nitem2\nitem3&quot;;
</code></pre>
<p><strong>JSON:</strong></p>
<pre><code class="language-php">return json_encode([
    &#39;status&#39; =&gt; &#39;success&#39;,
    &#39;items&#39; =&gt; [&#39;item1&#39;, &#39;item2&#39;, &#39;item3&#39;]
]);
</code></pre>
<p><strong>خالی (POSIX):</strong></p>
<pre><code class="language-php">return &#39;&#39;;  // موفقیت بدون خروجی
</code></pre>
<hr>
<h2 id="فرادادهای-بسته">فرادادهای بسته</h2>
<h3 id="فرمت-packagejson">فرمت package.json</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;توضیح بسته&quot;,
    &quot;author&quot;: &quot;نام شما&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: [&quot;dependency1&quot;, &quot;dependency2&quot;]
}
</code></pre>
<h3 id="مشخصات-فیلد">مشخصات فیلد</h3>
<table>
<thead>
<tr>
<th>فیلد</th>
<th>نوع</th>
<th>لازم</th>
<th>توضیح</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>رشته</td>
<td>بله</td>
<td>کوچک، بدون فاصله، استفاده در URL ها</td>
</tr>
<tr>
<td><code>name</code></td>
<td>رشته</td>
<td>بله</td>
<td>نام قابل خواندن</td>
</tr>
<tr>
<td><code>version</code></td>
<td>رشته</td>
<td>بله</td>
<td>نسخه درجه بندی معنایی (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>رشته</td>
<td>بله</td>
<td>توضیح مختصر</td>
</tr>
<tr>
<td><code>author</code></td>
<td>رشته</td>
<td>نه</td>
<td>نویسنده بسته</td>
</tr>
<tr>
<td><code>license</code></td>
<td>رشته</td>
<td>نه</td>
<td>شناسه مجوز (MIT, Apache-2.0, و غیره)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>آرایه</td>
<td>نه</td>
<td>آرایه شناسه های بسته</td>
</tr>
</tbody></table>
<h3 id="اعلان-وابستگی">اعلان وابستگی</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;auth&quot;,
    &quot;dependencies&quot;: [&quot;users&quot;, &quot;session&quot;]
}
</code></pre>
<p>مدیریت بسته:</p>
<ul>
<li>وابستگی های انتقالی را خودکار حل می کند</li>
<li>وابستگی های دایره ای را شناسایی می کند</li>
<li>به ترتیب صحیح نصب می کند (وابستگی ها قبل از وابستگان)</li>
<li>بسته های قبلا نصب شده را نادیده می گیرد</li>
</ul>
<hr>
<h2 id="تست-بسته-ها">تست بسته ها</h2>
<h3 id="تست-دستی-cli">تست دستی (CLI)</h3>
<pre><code class="language-bash"># نصب دستی بسته
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# تست فرماند ها
php shell.php mypackage
php shell.php mypackage list
php shell.php mypackage get 123
php shell.php mypackage create &quot;Test Item&quot;
</code></pre>
<h3 id="تست-دستی-http">تست دستی (HTTP)</h3>
<pre><code class="language-bash"># شروع سرور
php -S localhost:8000

# کلید API را دریافت کنید
KEY=$(cat .config/key)

# تست فرماند ها
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/get/123&quot;
</code></pre>
<h3 id="چک-لیست-تست">چک لیست تست</h3>
<ul>
<li><input disabled="" type="checkbox"> تمام اقدام ها به درستی کار می کنند</li>
<li><input disabled="" type="checkbox"> مدیریت خطا کار می کند (ورودی نامعتبر)</li>
<li><input disabled="" type="checkbox"> آرگومان های لازم اعتبارسنجی می شوند</li>
<li><input disabled="" type="checkbox"> عملیات فایل موفق می شوند</li>
<li><input disabled="" type="checkbox"> هر دو حالت CLI و HTTP یکسان کار می کنند</li>
<li><input disabled="" type="checkbox"> اقدام کمک تمام فرماند ها را مستند می کند</li>
<li><input disabled="" type="checkbox"> وابستگی ها در package.json اعلام می شوند</li>
</ul>
<hr>
<h2 id="توزیع">توزیع</h2>
<h3 id="ایجاد-zip-بسته">ایجاد ZIP بسته</h3>
<pre><code class="language-bash">cd mypackage
zip -r ../mypackage-1.0.0.zip .

# تایید محتویات
unzip -l ../mypackage-1.0.0.zip
</code></pre>
<h3 id="محاسبه-checksum">محاسبه Checksum</h3>
<pre><code class="language-bash">sha256sum mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
<h3 id="databasejson-مخزن">database.json مخزن</h3>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;توضیح بسته&quot;,
      &quot;author&quot;: &quot;نام شما&quot;,
      &quot;license&quot;: &quot;MIT&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;
    }
  }
}
</code></pre>
<h3 id="میزبانی-github">میزبانی GitHub</h3>
<pre><code class="language-bash"># ساختار مخزن ایجاد کنید
mkdir -p my-packages/main
cd my-packages/main

# بسته و پایگاه داده اضافه کنید
cp /path/to/mypackage-1.0.0.zip .
cat &gt; database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# فشار به GitHub
cd ..
git init
git add .
git commit -m &quot;Add mypackage&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# کاربران تنظیم می کنند:
# &quot;main&quot;: [&quot;https://github.com/user/my-packages/raw/main/main&quot;]
</code></pre>
<hr>
<h2 id="بهترین-عملکردها-1">بهترین عملکردها</h2>
<h3 id="اعتبارسنجی-ورودی">اعتبارسنجی ورودی</h3>
<pre><code class="language-php">// نادرست: بدون اعتبارسنجی
$id = $args[0];
return processId($id);

// درست: اعتبارسنجی و تمیز کردن
$id = $args[0] ?? null;
if (!$id || !is_numeric($id) || $id &lt; 1) {
    throw new \RuntimeException(&#39;شناسه نامعتبر است&#39;, 400);
}
return processId((int)$id);
</code></pre>
<h3 id="امنیت">امنیت</h3>
<pre><code class="language-php">// نادرست: دسترسی فایل دلخواه
$file = $args[0];
return file_get_contents($file);  // آسیب پذیر برای ../../../etc/passwd

// درست: محدود کردن به دایرکتوری امن
$file = basename($args[0] ?? &#39;&#39;);  // حذف اجزای مسیر
$path = &quot;app/data/$file&quot;;

if (!file_exists($path)) {
    throw new \RuntimeException(&#39;فایل پیدا نشد&#39;, 404);
}

return file_get_contents($path);
</code></pre>
<h3 id="پیام-های-خطا">پیام های خطا</h3>
<pre><code class="language-php">// نادرست: خطای عمومی
throw new \RuntimeException(&#39;خطا&#39;, 400);

// درست: خطای توصیفی
throw new \RuntimeException(&#39;شناسه کاربر باید عدد مثبت باشد&#39;, 400);
</code></pre>
<h3 id="سازمان-بندی-کد">سازمان بندی کد</h3>
<pre><code class="language-php">// نادرست: همه چیز در کننده
return function(array $args): string {
    // 500 سطر کد...
};

// درست: استفاده از دایرکتوری lib/
return function(array $args): string {
    require_once __DIR__ . &#39;/lib/Manager.php&#39;;
    $manager = new Manager();
    return $manager-&gt;handle($args);
};
</code></pre>
<h3 id="وابستگی-ها">وابستگی ها</h3>
<pre><code class="language-php">// درست: بررسی اگر کتابخانه های Composer در دسترس باشند
if (file_exists(__DIR__ . &#39;/../../vendor/autoload.php&#39;)) {
    require_once __DIR__ . &#39;/../../vendor/autoload.php&#39;;
    // استفاده از کتابخانه ها
} else {
    throw new \RuntimeException(&#39;وابستگی های Composer وجود ندارند&#39;, 500);
}
</code></pre>
<hr>
<h2 id="مثال-ها">مثال ها</h2>
<h3 id="شمارنده-ساده">شمارنده ساده</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $file = &#39;app/data/counter.txt&#39;;

    if (!file_exists($file)) {
        file_put_contents($file, &#39;0&#39;);
    }

    $count = (int)file_get_contents($file);
    $count++;
    file_put_contents($file, (string)$count);

    return &quot;تعداد: $count&quot;;
};
</code></pre>
<h3 id="crud-json">CRUD JSON</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;list&#39;;
    $file = &#39;app/data/items.json&#39;;

    // بارگذاری داده ها
    $items = [];
    if (file_exists($file)) {
        $items = json_decode(file_get_contents($file), true) ?? [];
    }

    switch ($action) {
        case &#39;list&#39;:
            return json_encode($items);

        case &#39;add&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;نام لازم است&#39;, 400);
            }
            $items[] = [
                &#39;id&#39; =&gt; count($items) + 1,
                &#39;name&#39; =&gt; $name,
                &#39;created_at&#39; =&gt; date(&#39;Y-m-d H:i:s&#39;)
            ];
            file_put_contents($file, json_encode($items, JSON_PRETTY_PRINT));
            return &quot;اضافه شد: $name&quot;;

        case &#39;get&#39;:
            $id = (int)($args[1] ?? 0);
            foreach ($items as $item) {
                if ($item[&#39;id&#39;] === $id) {
                    return json_encode($item);
                }
            }
            throw new \RuntimeException(&#39;آیتم پیدا نشد&#39;, 404);

        default:
            throw new \RuntimeException(&#39;اقدام نامعلوم&#39;, 404);
    }
};
</code></pre>
<h3 id="ماژول-قالب-mehr">ماژول قالب Mehr</h3>
<pre><code>mymodule/
├── app/
│   └── packages/
│       └── mymodule/
│           ├── handler.php       # کننده فرماند shell
│           ├── module.php        # پیاده سازی ماژول
│           ├── manifest.json     # Mehr manifest
│           └── migrations/       # انتقال پایگاه داده
│               └── 001_create_table.php
└── package.json                  # فرادادهای توزیع
</code></pre>
<p><strong>handler.php:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    require_once __DIR__ . &#39;/module.php&#39;;
    $module = new MyModule();
    return $module-&gt;handleCommand($args);
};
</code></pre>
<p><strong>package.json:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mymodule&quot;,
    &quot;name&quot;: &quot;My Module&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;ماژول قالب Mehr&quot;,
    &quot;dependencies&quot;: [&quot;core&quot;]
}
</code></pre>
<hr>
<h2 id="همچنین-ببینید-1">همچنین ببینید</h2>
<ul>
<li><strong><a href="INSTALL_FA.md">راهنمای نصب</a></strong> - تنظیم و ایجاد مخزن</li>
<li><strong><a href="USAGE_FA.md">مرجع استفاده</a></strong> - مرجع فرماند</li>
<li><strong><a href="https://github.com/mehrnet/mpm-packages">بسته های نمونه</a></strong> - مثال های کاری</li>
</ul>
<hr>
<p>برای پرسش ها یا مسائل، لطفا بازدید کنید: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>
    </section>
    <section class="content-section" data-lang="fr" hidden>
<!-- LANG:fr -->
<h1 id="référence-dutilisation">Référence d&#39;utilisation</h1>
<p>Référence de commande complète et documentation de l&#39;API pour MPM - Gestionnaire de paquets Mehr.</p>
<h2 id="table-des-matières">Table des matières</h2>
<ul>
<li><a href="#formats-de-requ%C3%AAte">Formats de requête</a></li>
<li><a href="#commandes-int%C3%A9gr%C3%A9es">Commandes intégrées</a></li>
<li><a href="#gestionnaire-de-paquets">Gestionnaire de paquets</a></li>
<li><a href="#protocole-de-r%C3%A9ponse">Protocole de réponse</a></li>
<li><a href="#fichiers-de-configuration">Fichiers de configuration</a></li>
<li><a href="#commandes-personnalis%C3%A9es">Commandes personnalisées</a></li>
<li><a href="#architecture">Architecture</a></li>
<li><a href="#performance">Performance</a></li>
<li><a href="#d%C3%A9pannage">Dépannage</a></li>
</ul>
<hr>
<h2 id="formats-de-requête">Formats de requête</h2>
<h3 id="mode-http">Mode HTTP</h3>
<p><strong>Format:</strong></p>
<pre><code>GET /shell.php/API_KEY/COMMAND/ARG0/ARG1/ARG2/...
</code></pre>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># Obtenir la clé API
KEY=$(cat .config/key)

# Lister les fichiers
curl &quot;http://localhost/shell.php/$KEY/ls&quot;

# Lire un fichier
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;

# Afficher du texte avec plusieurs arguments
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;

# Gestion des paquets
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
<p><strong>Réponse:</strong></p>
<ul>
<li>Succès: HTTP 200 avec réponse en texte brut</li>
<li>Erreur: HTTP 4xx/5xx avec message d&#39;erreur</li>
</ul>
<h3 id="mode-cli">Mode CLI</h3>
<p><strong>Format:</strong></p>
<pre><code class="language-bash">php shell.php COMMAND ARG0 ARG1 ARG2 ...
</code></pre>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># Lister les fichiers
php shell.php ls

# Lire un fichier
php shell.php cat README.md

# Afficher du texte avec plusieurs arguments
php shell.php echo hello world

# Gestion des paquets
php shell.php pkg search database
php shell.php pkg add users
</code></pre>
<p><strong>Réponse:</strong></p>
<ul>
<li>Succès: Sortie vers STDOUT, code de sortie 0</li>
<li>Erreur: Sortie vers STDERR avec préfixe &quot;Error: &quot;, code de sortie 1</li>
</ul>
<hr>
<h2 id="commandes-intégrées">Commandes intégrées</h2>
<h3 id="ls-path-2">ls [path]</h3>
<p>Lister le contenu d&#39;un répertoire.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>path</code> (optionnel): Répertoire à lister (par défaut: répertoire courant)</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php ls
php shell.php ls app
php shell.php ls app/packages

# HTTP
curl &quot;http://localhost/shell.php/$KEY/ls&quot;
curl &quot;http://localhost/shell.php/$KEY/ls/app&quot;
</code></pre>
<p><strong>Sortie:</strong>
Noms de fichiers séparés par des espaces (exclut <code>.</code> et <code>..</code>)</p>
<p><strong>Erreurs:</strong></p>
<ul>
<li>404: Répertoire non trouvé</li>
<li>400: Impossible de lire le répertoire</li>
<li>403: Validation du chemin échouée (chemin absolu ou <code>..</code>)</li>
</ul>
<hr>
<h3 id="cat--2">cat <file></h3>
<p>Lire le contenu d&#39;un fichier.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>file</code> (obligatoire): Chemin du fichier</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cat README.md
php shell.php cat .config/key

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cat/README.md&quot;
</code></pre>
<p><strong>Sortie:</strong>
Contenu du fichier (préserve la mise en forme et les sauts de ligne)</p>
<p><strong>Erreurs:</strong></p>
<ul>
<li>400: Argument fichier manquant ou ce n&#39;est pas un fichier</li>
<li>404: Fichier non trouvé</li>
<li>403: Validation du chemin échouée</li>
</ul>
<hr>
<h3 id="rm--2">rm <file></h3>
<p>Supprimer un fichier.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>file</code> (obligatoire): Chemin du fichier</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php rm temp.txt
php shell.php rm logs/old.log

# HTTP
curl &quot;http://localhost/shell.php/$KEY/rm/temp.txt&quot;
</code></pre>
<p><strong>Sortie:</strong>
Chaîne vide en cas de succès (comportement POSIX)</p>
<p><strong>Erreurs:</strong></p>
<ul>
<li>400: Argument fichier manquant, ce n&#39;est pas un fichier ou impossible de supprimer</li>
<li>404: Fichier non trouvé</li>
<li>403: Validation du chemin échouée</li>
</ul>
<hr>
<h3 id="mkdir--2">mkdir <path></h3>
<p>Créer un répertoire (récursivement).</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>path</code> (obligatoire): Chemin du répertoire à créer</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php mkdir uploads
php shell.php mkdir app/data/cache

# HTTP
curl &quot;http://localhost/shell.php/$KEY/mkdir/uploads&quot;
</code></pre>
<p><strong>Sortie:</strong>
Chaîne vide en cas de succès</p>
<p><strong>Erreurs:</strong></p>
<ul>
<li>400: Argument chemin manquant, existe déjà ou impossible de créer</li>
<li>403: Validation du chemin échouée</li>
</ul>
<hr>
<h3 id="cp---2">cp <src> <dst></h3>
<p>Copier un fichier.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>src</code> (obligatoire): Chemin du fichier source</li>
<li><code>dst</code> (obligatoire): Chemin du fichier destination</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php cp config.json config.backup.json
php shell.php cp README.md docs/README.md

# HTTP
curl &quot;http://localhost/shell.php/$KEY/cp/config.json/config.backup.json&quot;
</code></pre>
<p><strong>Sortie:</strong>
Chaîne vide en cas de succès</p>
<p><strong>Erreurs:</strong></p>
<ul>
<li>400: Arguments manquants, source ce n&#39;est pas un fichier ou impossible de copier</li>
<li>404: Fichier source non trouvé</li>
<li>403: Validation du chemin échouée</li>
</ul>
<hr>
<h3 id="echo--2">echo <text>...</h3>
<p>Afficher des arguments de texte.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>text...</code> (obligatoire): Un ou plusieurs arguments de texte</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php echo hello
php shell.php echo hello world &quot;from shell&quot;

# HTTP
curl &quot;http://localhost/shell.php/$KEY/echo/hello&quot;
curl &quot;http://localhost/shell.php/$KEY/echo/hello/world&quot;
</code></pre>
<p><strong>Sortie:</strong>
Arguments séparés par des espaces</p>
<hr>
<h3 id="env-action-name-2">env [action] [name]</h3>
<p>Gérer les variables d&#39;environnement.</p>
<p><strong>Actions:</strong></p>
<ul>
<li><code>list</code> (par défaut): Lister toutes les variables d&#39;environnement</li>
<li><code>get &lt;name&gt;</code>: Obtenir la valeur d&#39;une variable spécifique</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php env list
php shell.php env get PATH
php shell.php env get HOME

# HTTP
curl &quot;http://localhost/shell.php/$KEY/env/list&quot;
curl &quot;http://localhost/shell.php/$KEY/env/get/PATH&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<ul>
<li><code>list</code>: Une variable par ligne (<code>KEY=value</code>)</li>
<li><code>get</code>: Valeur de la variable uniquement</li>
</ul>
<p><strong>Erreurs:</strong></p>
<ul>
<li>404: Variable non trouvée ou action inconnue</li>
<li>400: Nom de variable manquant pour <code>get</code></li>
</ul>
<hr>
<h2 id="gestionnaire-de-paquets">Gestionnaire de paquets</h2>
<h3 id="pkg-add-package-2">pkg add [PACKAGE...]</h3>
<p>Installer des paquets avec résolution automatique des dépendances.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE...</code> (obligatoire): Un ou plusieurs noms de paquets</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg add users
php shell.php pkg add users auth database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/add/users/auth&quot;
</code></pre>
<p><strong>Processus:</strong></p>
<ol>
<li>Récupérer la base de données du référentiel</li>
<li>Résoudre les dépendances (tri topologique DFS)</li>
<li>Télécharger tous les paquets avec vérification de checksum</li>
<li>Extraire tous les paquets vers la racine du projet</li>
<li>Enregistrer les paquets de manière atomique</li>
</ol>
<p><strong>Sortie:</strong></p>
<pre><code>Paquets à installer: dependency1, dependency2, users

Téléchargement des paquets...
Tous les paquets ont été téléchargés et vérifiés

Extraction des paquets...
Extrait dependency1 (1.0.0)
Extrait dependency2 (2.0.0)
Extrait users (3.0.0)

Enregistrement des paquets...

Installation réussie de 3 paquet(s): dependency1, dependency2, users
</code></pre>
<p><strong>Erreurs:</strong></p>
<ul>
<li>404: Paquet non trouvé</li>
<li>400: Dépendance circulaire détectée</li>
<li>503: Tous les miroirs ont échoué ou verrou maintenu</li>
</ul>
<hr>
<h3 id="pkg-del--2">pkg del <PACKAGE></h3>
<p>Supprimer un paquet (échoue si d&#39;autres paquets en dépendent).</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (obligatoire): Nom du paquet</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg del users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/del/users&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>Paquet supprimé: users (version 1.0.0) - 15 fichiers supprimés, 3 répertoires vides supprimés
</code></pre>
<p><strong>Erreurs:</strong></p>
<ul>
<li>404: Paquet non installé</li>
<li>400: Paquet requis par d&#39;autres paquets</li>
<li>503: Verrou maintenu</li>
</ul>
<hr>
<h3 id="pkg-upgrade-package-2">pkg upgrade [PACKAGE]</h3>
<p>Mettre à jour tous les paquets ou un paquet spécifique vers la dernière version.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (optionnel): Nom du paquet (si omis, met à jour tous)</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg upgrade           # Mettre à jour tous
php shell.php pkg upgrade users     # Mettre à jour spécifique

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/upgrade/users&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>Mise à jour de users de 1.0.0 vers 1.1.0

Téléchargement des mises à jour de paquets...
Toutes les mises à jour ont été téléchargées et vérifiées

Extraction des mises à jour de paquets...
Extrait users mise à jour vers 1.1.0

Enregistrement des mises à jour...

Mise à jour réussie de 1 paquet(s): users
</code></pre>
<hr>
<h3 id="pkg-update-2">pkg update</h3>
<p>Actualiser le cache du référentiel (récupérer la dernière base de données des paquets).</p>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg update

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/update&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>Cache du référentiel actualisé - 42 paquets disponibles
</code></pre>
<hr>
<h3 id="pkg-list-filter-2">pkg list [FILTER]</h3>
<p>Lister les paquets installés.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>FILTER</code> (optionnel): Filtrer par nom de paquet (insensible à la casse)</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg list
php shell.php pkg list auth

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost/shell.php/$KEY/pkg/list/auth&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>Paquets installés:

  users                 v1.0.0      installé: 2025-01-15
  auth                  v2.0.0      installé: 2025-01-15 (dépend: users)
  database              v1.5.0      installé: 2025-01-15 (dépend: users)
</code></pre>
<hr>
<h3 id="pkg-search--2">pkg search <KEYWORD></h3>
<p>Rechercher des paquets disponibles.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>KEYWORD</code> (obligatoire): Terme de recherche</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg search database

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/search/database&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>3 paquets trouvés:

  mysql-driver          v1.0.0      Pilote base de données MySQL [installé]
    Fournit la connectivité MySQL pour les applications

  postgres-driver       v1.0.0      Pilote PostgreSQL
    Connecteur de base de données PostgreSQL

  database-tools        v2.0.0      Outils de gestion de base de données
    Utilitaires et assistants courants de base de données
</code></pre>
<hr>
<h3 id="pkg-info--2">pkg info <PACKAGE></h3>
<p>Afficher les informations détaillées du paquet.</p>
<p><strong>Arguments:</strong></p>
<ul>
<li><code>PACKAGE</code> (obligatoire): Nom du paquet</li>
</ul>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg info users

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/info/users&quot;
</code></pre>
<p><strong>Sortie:</strong></p>
<pre><code>Paquet: Système de gestion des utilisateurs
ID: users
Dernière: 1.0.0
Description: Gestion complète des utilisateurs avec authentification
Auteur: Équipe Mehrnet
Licence: MIT

Installé: v1.0.0 (le 2025-01-15T10:30:00Z)
Dépendances: aucune

Versions disponibles:
  v1.0.0 - publié: 2025-01-15
  v0.9.0 - publié: 2025-01-01 (requiert: auth-lib)
</code></pre>
<p><strong>Erreurs:</strong></p>
<ul>
<li>404: Paquet non trouvé</li>
</ul>
<hr>
<h3 id="pkg-help-2">pkg help</h3>
<p>Afficher l&#39;aide du gestionnaire de paquets.</p>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg help

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/help&quot;
</code></pre>
<hr>
<h3 id="pkg-version-2">pkg version</h3>
<p>Afficher la version du gestionnaire de paquets.</p>
<p><strong>Exemples:</strong></p>
<pre><code class="language-bash"># CLI
php shell.php pkg version

# HTTP
curl &quot;http://localhost/shell.php/$KEY/pkg/version&quot;
</code></pre>
<hr>
<h2 id="protocole-de-réponse">Protocole de réponse</h2>
<h3 id="codes-de-statut-http">Codes de statut HTTP</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Signification</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>Succès</td>
</tr>
<tr>
<td>400</td>
<td>Mauvaise requête (arguments invalides, erreurs opérationnelles)</td>
</tr>
<tr>
<td>403</td>
<td>Interdit (clé API invalide, validation du chemin échouée)</td>
</tr>
<tr>
<td>404</td>
<td>Non trouvé (commande, paquet ou fichier non trouvé)</td>
</tr>
<tr>
<td>503</td>
<td>Service indisponible (tous les miroirs ont échoué, verrou maintenu)</td>
</tr>
</tbody></table>
<h3 id="codes-de-sortie-cli">Codes de sortie CLI</h3>
<table>
<thead>
<tr>
<th>Code</th>
<th>Signification</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>Succès</td>
</tr>
<tr>
<td>1</td>
<td>Erreur (tout type)</td>
</tr>
</tbody></table>
<h3 id="sémantique-posix">Sémantique POSIX</h3>
<ul>
<li>Les commandes avec sortie retournent les données</li>
<li>Les commandes sans sortie retournent une chaîne vide (mais sortie toujours 0/200)</li>
<li>Les erreurs lancent des exceptions avec les codes appropriés</li>
</ul>
<hr>
<h2 id="fichiers-de-configuration">Fichiers de configuration</h2>
<h3 id="configkey-2">.config/key</h3>
<p>Fichier texte brut contenant la clé API hexadécimale de 64 caractères.</p>
<p><strong>Format:</strong></p>
<pre><code>abc123def456789...  (64 caractères hexadécimaux)
</code></pre>
<p><strong>Génération:</strong></p>
<pre><code class="language-php">$key = bin2hex(random_bytes(32));
</code></pre>
<p><strong>Sécurité:</strong></p>
<ul>
<li>Générée automatiquement au premier lancement</li>
<li>Utilisée pour l&#39;authentification HTTP</li>
<li>Chargée automatiquement en mode CLI</li>
<li>Comparaison sûre aux attaques temporelles via <code>hash_equals()</code></li>
</ul>
<hr>
<h3 id="configreposjson-2">.config/repos.json</h3>
<p>Configuration des miroirs du référentiel.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://primary-mirror.com/packages&quot;,
    &quot;https://secondary-mirror.com/packages&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.com/packages&quot;
  ]
}
</code></pre>
<p><strong>Sélection du miroir:</strong></p>
<ul>
<li>Les miroirs sont essayés séquentiellement en cas d&#39;échec</li>
<li>Aucun délai de recul</li>
<li>Le premier miroir réussi gagne</li>
</ul>
<hr>
<h3 id="configpackagesjson-2">.config/packages.json</h3>
<p>Registre des paquets installés.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">{
  &quot;createdAt&quot;: &quot;2025-01-15T10:00:00Z&quot;,
  &quot;updatedAt&quot;: &quot;2025-01-15T10:30:00Z&quot;,
  &quot;packages&quot;: {
    &quot;users&quot;: {
      &quot;version&quot;: &quot;1.0.0&quot;,
      &quot;installed_at&quot;: &quot;2025-01-15T10:30:00Z&quot;,
      &quot;dependencies&quot;: [],
      &quot;files&quot;: [
        &quot;./app/packages/users/handler.php&quot;,
        &quot;./app/packages/users/module.php&quot;
      ],
      &quot;download_url&quot;: &quot;https://mirror.com/users-1.0.0.zip&quot;,
      &quot;download_time&quot;: &quot;2025-01-15T10:29:00Z&quot;,
      &quot;checksum&quot;: &quot;sha256:abc123...&quot;,
      &quot;repository&quot;: &quot;main&quot;
    }
  }
}
</code></pre>
<p><strong>Métadonnées:</strong></p>
<ul>
<li><code>createdAt</code>: Heure de création du registre</li>
<li><code>updatedAt</code>: Heure de dernière modification</li>
<li><code>files</code>: Tableau des chemins de fichiers installés (pour la suppression)</li>
<li><code>download_url</code>: Miroir source utilisé</li>
<li><code>checksum</code>: Checksum vérifié</li>
</ul>
<hr>
<h3 id="configpathjson-2">.config/path.json</h3>
<p>Modèles de découverte de gestionnaire de commandes.</p>
<p><strong>Format:</strong></p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;
]
</code></pre>
<p><strong>Correspondance de modèle:</strong></p>
<ul>
<li><code>[name]</code> remplacé par le nom de la commande</li>
<li>Les modèles sont recherchés dans l&#39;ordre du tableau</li>
<li>Le premier correspondance gagne</li>
</ul>
<p><strong>Exemple:</strong>
La commande <code>users</code> recherche:</p>
<ol>
<li><code>app/packages/users/handler.php</code></li>
<li><code>bin/users.php</code></li>
</ol>
<hr>
<h2 id="commandes-personnalisées">Commandes personnalisées</h2>
<h3 id="format-du-gestionnaire">Format du gestionnaire</h3>
<p>Les gestionnaires sont des fichiers PHP retournant un callable:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Traiter les arguments
    // Retourner la réponse ou lancer une exception
    return &quot;output&quot;;
};
</code></pre>
<h3 id="traitement-des-arguments">Traitement des arguments</h3>
<p><strong>Mode HTTP:</strong></p>
<pre><code>GET /shell.php/KEY/mycommand/action/arg1/arg2
                       ↓        ↓      ↓    ↓
                   command   args[0] [1]  [2]
</code></pre>
<p><strong>Mode CLI:</strong></p>
<pre><code class="language-bash">php shell.php mycommand action arg1 arg2
                ↓        ↓      ↓    ↓
            command   args[0] [1]  [2]
</code></pre>
<p><strong>Le gestionnaire reçoit:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];  // &#39;action&#39;
    $arg1 = $args[1];    // &#39;arg1&#39;
    $arg2 = $args[2];    // &#39;arg2&#39;
}
</code></pre>
<h3 id="gestion-des-erreurs">Gestion des erreurs</h3>
<p>Lancer des exceptions avec codes de statut HTTP:</p>
<pre><code class="language-php">// Mauvaise requête
throw new \RuntimeException(&#39;Entrée invalide&#39;, 400);

// Non trouvé
throw new \RuntimeException(&#39;Élément non trouvé&#39;, 404);

// Interdit
throw new \RuntimeException(&#39;Accès refusé&#39;, 403);
</code></pre>
<p><strong>Note:</strong> Le mode CLI convertit tous les codes d&#39;erreur au code de sortie 1.</p>
<h3 id="exemple-de-gestionnaire">Exemple de gestionnaire</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            // Lire les données
            $data = json_decode(
                file_get_contents(&#39;app/data/items.json&#39;),
                true
            );
            return json_encode($data);

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID requis&#39;, 400);
            }
            // Récupérer l&#39;élément
            return &quot;Item: $id&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Nom requis&#39;, 400);
            }
            // Créer l&#39;élément
            return &quot;Created: $name&quot;;

        case &#39;help&#39;:
            return &quot;Actions: list, get &lt;id&gt;, create &lt;name&gt;&quot;;

        default:
            throw new \RuntimeException(&quot;Action inconnue: $action&quot;, 404);
    }
};
</code></pre>
<hr>
<h2 id="architecture-1">Architecture</h2>
<h3 id="structure-des-fichiers">Structure des fichiers</h3>
<pre><code>.
├── shell.php              # Exécutable principal (2300 lignes)
├── .config/               # Configuration (création automatique)
│   ├── key                # Clé API
│   ├── repos.json         # Miroirs du référentiel
│   ├── packages.json      # Paquets installés
│   └── path.json          # Modèles de gestionnaire
├── .cache/                # Cache (création automatique)
│   ├── shell.lock         # Fichier de verrou
│   └── *.zip              # Paquets téléchargés
└── app/packages/          # Paquets installés
    └── [package]/
        └── handler.php
</code></pre>
<h3 id="flux-dexécution">Flux d&#39;exécution</h3>
<pre><code>1. Détection de runtime (HTTP/CLI)
    ↓
2. Initialiser les fichiers de configuration
    ↓
3. Analyser la requête (PATH_INFO ou argv)
    ↓
4. Valider la clé API
    ↓
5. Exécuter la commande
    ├─ Commande intégrée
    ├─ Gestionnaire de paquets
    └─ Gestionnaire personnalisé
    ↓
6. Envoyer la réponse (en-têtes HTTP ou STDOUT/STDERR)
</code></pre>
<h3 id="flux-du-gestionnaire-de-paquets">Flux du gestionnaire de paquets</h3>
<p><strong>Installation:</strong></p>
<pre><code>1. Résoudre les dépendances (tri topologique DFS)
    ↓
2. Télécharger tous les paquets (avec vérification de checksum)
    ↓
3. Extraire tous les paquets (avec résolution de conflit)
    ↓
4. Enregistrer dans .config/packages.json (atomiquement)
</code></pre>
<p><strong>Caractéristiques clés:</strong></p>
<ul>
<li><strong>Résolution de dépendances:</strong> Complexité O(V + E)</li>
<li><strong>Détection de cycle:</strong> Recherches d&#39;ensemble O(1)</li>
<li><strong>Vérification de checksum:</strong> SHA256 avec comparaison sûre aux attaques temporelles</li>
<li><strong>Basculement de miroir:</strong> Nouvel essai séquentiel, aucun recul</li>
<li><strong>Opérations atomiques:</strong> Installation tout ou rien</li>
<li><strong>Résolution de conflit:</strong> Fichiers existants renommés avec <code>-2</code>, <code>-3</code>, etc.</li>
</ul>
<h3 id="modèle-de-sécurité">Modèle de sécurité</h3>
<ol>
<li><p><strong>Authentification:</strong></p>
<ul>
<li>Clé API aléatoire de 64 caractères</li>
<li>Comparaison sûre aux attaques temporelles via <code>hash_equals()</code></li>
<li>Chargement automatique en mode CLI</li>
</ul>
</li>
<li><p><strong>Validation du chemin:</strong></p>
<ul>
<li>Bloque les chemins absolus (<code>/etc/passwd</code>)</li>
<li>Bloque la traversée de répertoires (<code>../../../</code>)</li>
<li>Appliquée à toutes les opérations de fichiers</li>
</ul>
</li>
<li><p><strong>Sécurité des paquets:</strong></p>
<ul>
<li>Vérification de checksum SHA256</li>
<li>Détection de traversée Zip</li>
<li>Application HTTPS du miroir</li>
</ul>
</li>
</ol>
<hr>
<h2 id="performance-1">Performance</h2>
<h3 id="points-de-référence">Points de référence</h3>
<ul>
<li><strong>Exécution de l&#39;application:</strong> &lt;1ms (mesurée via profilage)</li>
<li><strong>Surcharge du serveur intégré:</strong> 1000ms+ (utilisez un serveur web approprié en production)</li>
<li><strong>Téléchargement de paquets:</strong> Dépend de la vitesse du réseau et du miroir</li>
<li><strong>Résolution de dépendances:</strong> O(V + E) où V = paquets, E = dépendances</li>
</ul>
<h3 id="conseils-doptimisation">Conseils d&#39;optimisation</h3>
<ol>
<li><strong>Utiliser un serveur web de production</strong> (Nginx, Apache)</li>
<li><strong>Activer le cache de code PHP</strong> (OPcache)</li>
<li><strong>Utiliser un CDN pour les miroirs de paquets</strong></li>
<li><strong>Minimiser la complexité du gestionnaire personnalisé</strong></li>
<li><strong>Mettre en cache la base de données des paquets localement</strong></li>
</ol>
<hr>
<h2 id="dépannage">Dépannage</h2>
<h3 id="clé-api-invalide">&quot;Clé API invalide&quot;</h3>
<p><strong>HTTP 403</strong></p>
<p><strong>Cause:</strong> Clé API manquante ou incorrecte</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Vérifier la clé
cat .config/key

# Régénérer la clé (supprimer et réexécuter)
rm .config/key
php shell.php ls
</code></pre>
<hr>
<h3 id="clé-api-non-trouvée-cli">&quot;Clé API non trouvée&quot; (CLI)</h3>
<p><strong>Code de sortie 1</strong></p>
<p><strong>Cause:</strong> Le fichier <code>.config/key</code> n&#39;existe pas</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Initialiser le shell
php shell.php ls
</code></pre>
<hr>
<h3 id="commande-non-trouvée">&quot;Commande non trouvée&quot;</h3>
<p><strong>HTTP 404 / Code de sortie 1</strong></p>
<p><strong>Cause:</strong> Fichier gestionnaire non trouvé</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Vérifier les modèles de gestionnaire
cat .config/path.json

# Vérifier que le gestionnaire existe
ls app/packages/[command]/handler.php
ls bin/[command].php
</code></pre>
<hr>
<h3 id="une-autre-opération-pkg-est-en-cours">&quot;Une autre opération pkg est en cours&quot;</h3>
<p><strong>HTTP 503 / Code de sortie 1</strong></p>
<p><strong>Cause:</strong> Le fichier de verrou existe</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Attendre que l&#39;opération se termine, ou forcer le déverrouillage
php shell.php pkg unlock

# Ou supprimer manuellement
rm .cache/shell.lock
</code></pre>
<hr>
<h3 id="paquet-non-trouvé">&quot;Paquet non trouvé&quot;</h3>
<p><strong>HTTP 404 / Code de sortie 1</strong></p>
<p><strong>Cause:</strong> Paquet non dans le référentiel</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Actualiser le cache du référentiel
php shell.php pkg update

# Rechercher le paquet
php shell.php pkg search keyword
</code></pre>
<hr>
<h3 id="dépendance-circulaire">&quot;Dépendance circulaire&quot;</h3>
<p><strong>HTTP 400 / Code de sortie 1</strong></p>
<p><strong>Cause:</strong> Cycle de dépendance de paquet (A → B → C → A)</p>
<p><strong>Solution:</strong>
Examinez les dépendances des paquets et supprimez le cycle. C&#39;est un problème du référentiel de paquets.</p>
<hr>
<h3 id="impossible-de-supprimer---requis-par">&quot;Impossible de supprimer - requis par&quot;</h3>
<p><strong>HTTP 400 / Code de sortie 1</strong></p>
<p><strong>Cause:</strong> D&#39;autres paquets dépendent du paquet cible</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Supprimer d&#39;abord les paquets dépendants
php shell.php pkg del dependent-package
php shell.php pkg del target-package
</code></pre>
<hr>
<h3 id="erreurs-de-permission">Erreurs de permission</h3>
<p><strong>Cause:</strong> Permissions du système de fichiers</p>
<p><strong>Solution:</strong></p>
<pre><code class="language-bash"># Corriger les permissions
chmod 755 .
chmod 644 shell.php
chmod 755 .config
chmod 644 .config/*
chmod 755 .cache
</code></pre>
<hr>
<h2 id="voir-aussi">Voir aussi</h2>
<ul>
<li><strong><a href="INSTALL_FR.md">Guide d&#39;installation</a></strong> - Configuration et installation</li>
<li><strong><a href="PACKAGES_FR.md">Développement de paquets</a></strong> - Création de paquets</li>
<li><strong><a href="https://github.com/mehrnet/mpm">Dépôt GitHub</a></strong> - Code source</li>
</ul>
<hr>
<p>Pour les questions ou les problèmes, veuillez visiter: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>
<!-- LANG:fr -->
<h1 id="guide-dinstallation-et-de-configuration">Guide d&#39;installation et de configuration</h1>
<p>Guide complet pour installer, configurer et commencer avec MPM - Gestionnaire de paquets Mehr.</p>
<h2 id="table-des-matières-1">Table des matières</h2>
<ul>
<li><a href="#installation">Installation</a></li>
<li><a href="#premi%C3%A8re-ex%C3%A9cution">Première exécution</a></li>
<li><a href="#configuration">Configuration</a></li>
<li><a href="#commencer">Commencer</a></li>
<li><a href="#d%C3%A9veloppement-de-paquets">Développement de paquets</a></li>
<li><a href="#configuration-du-r%C3%A9f%C3%A9rentiel">Configuration du référentiel</a></li>
<li><a href="#d%C3%A9ploiement">Déploiement</a></li>
</ul>
<hr>
<h2 id="installation-1">Installation</h2>
<h3 id="installation-rapide">Installation rapide</h3>
<pre><code class="language-bash"># Télécharger shell.php
wget https://raw.githubusercontent.com/mehrnet/mpm/main/shell.php

# Définir les permissions
chmod 644 shell.php

# Tester l&#39;installation
php shell.php echo &quot;Hello, World!&quot;
</code></pre>
<h3 id="installation-manuelle">Installation manuelle</h3>
<ol>
<li>Téléchargez <code>shell.php</code> depuis le référentiel</li>
<li>Placez-le à la racine de votre projet ou dans le répertoire du serveur web</li>
<li>Assurez-vous que PHP 8.1+ est installé</li>
<li>Vérifiez que l&#39;extension <code>ZipArchive</code> est activée (pour la gestion des paquets)</li>
</ol>
<h3 id="exigences">Exigences</h3>
<ul>
<li><strong>PHP</strong>: 8.1 ou supérieur</li>
<li><strong>Extensions</strong>: <code>ZipArchive</code> (pour la gestion des paquets)</li>
<li><strong>Permissions</strong>: Accès en lecture/écriture au répertoire du projet</li>
</ul>
<h2 id="première-exécution">Première exécution</h2>
<p>À la première exécution, MPM génère automatiquement les fichiers de configuration:</p>
<pre><code class="language-bash"># Exécutez n&#39;importe quelle commande pour initialiser
php shell.php ls
</code></pre>
<p>Cela crée:</p>
<pre><code>.config/
├── key              # Clé API (64 caractères hexadécimaux)
├── repos.json       # Configuration des miroirs du référentiel
├── packages.json    # Registre des paquets installés
└── path.json        # Modèles de gestionnaire de commandes
</code></pre>
<h3 id="clé-api">Clé API</h3>
<p>Votre clé API est affichée au premier accès HTTP ou enregistrée dans <code>.config/key</code> à la première exécution CLI:</p>
<pre><code class="language-bash"># Afficher votre clé API
cat .config/key
</code></pre>
<p><strong>Important:</strong> Gardez votre clé API sécurisée. Quiconque y ayant accès peut exécuter des commandes.</p>
<h2 id="configuration-1">Configuration</h2>
<h3 id="miroirs-du-référentiel">Miroirs du référentiel</h3>
<p>Modifiez <code>.config/repos.json</code> pour personnaliser les référentiels de paquets:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [
    &quot;https://repo.example.com&quot;,
    &quot;https://mirror1.example.com&quot;,
    &quot;https://mirror2.example.com&quot;
  ],
  &quot;extra&quot;: [
    &quot;https://extra-repo.example.com&quot;
  ]
}
</code></pre>
<p>Les miroirs sont essayés séquentiellement en cas d&#39;échec sans délai de recul.</p>
<h3 id="modèles-de-gestionnaire-de-commandes">Modèles de gestionnaire de commandes</h3>
<p>Modifiez <code>.config/path.json</code> pour personnaliser où le shell recherche les commandes personnalisées:</p>
<pre><code class="language-json">[
  &quot;app/packages/[name]/handler.php&quot;,
  &quot;bin/[name].php&quot;,
  &quot;custom/handlers/[name].php&quot;
]
</code></pre>
<p>Le placeholder <code>[name]</code> est remplacé par le nom de la commande.</p>
<h3 id="configuration-spécifique-à-lenvironnement">Configuration spécifique à l&#39;environnement</h3>
<p>Pour différents environnements, vous pouvez:</p>
<ol>
<li><p><strong>Utiliser des répertoires de configuration différents:</strong></p>
<pre><code class="language-php">// Modifier les constantes dans shell.php (non recommandé)
const DIR_CONFIG = &#39;.config&#39;;
</code></pre>
</li>
<li><p><strong>Symlink de configuration:</strong></p>
<pre><code class="language-bash">ln -s .config.production .config
</code></pre>
</li>
<li><p><strong>Variables d&#39;environnement:</strong>
 Accédez via <code>php shell.php env list</code></p>
</li>
</ol>
<h2 id="commencer">Commencer</h2>
<h3 id="mode-cli-recommandé-pour-le-développement">Mode CLI (Recommandé pour le développement)</h3>
<pre><code class="language-bash"># Lister les fichiers
php shell.php ls

# Lire le contenu des fichiers
php shell.php cat shell.php | head -20

# Créer un répertoire
php shell.php mkdir tmp

# Copier des fichiers
php shell.php cp shell.php shell.backup.php

# Gestion des paquets
php shell.php pkg search database
php shell.php pkg add users
php shell.php pkg list
php shell.php pkg upgrade
</code></pre>
<h3 id="mode-http-production">Mode HTTP (Production)</h3>
<ol>
<li><p><strong>Démarrez le serveur de développement PHP (test):</strong></p>
<pre><code class="language-bash">php -S localhost:8000
</code></pre>
</li>
<li><p><strong>Obtenez votre clé API:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
</code></pre>
</li>
<li><p><strong>Exécutez les commandes:</strong></p>
<pre><code class="language-bash"># Lister les fichiers
curl &quot;http://localhost:8000/shell.php/$KEY/ls&quot;

# Lire un fichier
curl &quot;http://localhost:8000/shell.php/$KEY/cat/README.md&quot;

# Gestion des paquets
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/pkg/add/users&quot;
</code></pre>
</li>
</ol>
<h3 id="serveur-web-de-production">Serveur web de production</h3>
<p>Pour la production, utilisez un serveur web approprié:</p>
<p><strong>Nginx:</strong></p>
<pre><code class="language-nginx">server {
    listen 80;
    server_name your-domain.com;
    root /var/www/shell;
    index shell.php;

    location / {
        try_files $uri $uri/ /shell.php$is_args$args;
    }

    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index shell.php;
        include fastcgi_params;
    }
}
</code></pre>
<p><strong>Apache (.htaccess):</strong></p>
<pre><code class="language-apache">RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ shell.php/$1 [L,QSA]
</code></pre>
<h2 id="développement-de-paquets">Développement de paquets</h2>
<h3 id="créer-un-paquet">Créer un paquet</h3>
<ol>
<li><p><strong>Créer la structure du paquet:</strong></p>
<pre><code>mypackage/
├── handler.php       # Obligatoire: point d&#39;entrée
├── package.json      # Obligatoire: métadonnées
├── lib/             # Optionnel: code de bibliothèque
└── data/            # Optionnel: fichiers de données
</code></pre>
</li>
<li><p><strong>Écrire handler.php:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return &quot;Item 1\nItem 2\nItem 3&quot;;

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Nom requis&#39;, 400);
            }
            return &quot;Created: $name&quot;;

        default:
            return &quot;Actions: list, create&quot;;
    }
};
</code></pre>
</li>
<li><p><strong>Créer package.json:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Description du paquet&quot;,
    &quot;author&quot;: &quot;Votre nom&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
</code></pre>
</li>
</ol>
<h3 id="champs-de-métadonnées-du-paquet">Champs de métadonnées du paquet</h3>
<table>
<thead>
<tr>
<th>Champ</th>
<th>Type</th>
<th>Obligatoire</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Minuscules, sans espaces, utilisé dans les URL</td>
</tr>
<tr>
<td><code>name</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Nom lisible</td>
</tr>
<tr>
<td><code>version</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Versioning sémantique (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Description brève</td>
</tr>
<tr>
<td><code>author</code></td>
<td>chaîne</td>
<td>Non</td>
<td>Auteur du paquet</td>
</tr>
<tr>
<td><code>license</code></td>
<td>chaîne</td>
<td>Non</td>
<td>Identifiant de licence (MIT, Apache-2.0, etc.)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>tableau</td>
<td>Non</td>
<td>Tableau d&#39;ID de paquets</td>
</tr>
</tbody></table>
<h3 id="tester-votre-paquet">Tester votre paquet</h3>
<p><strong>Mode CLI:</strong></p>
<pre><code class="language-bash"># Installer manuellement
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# Tester les commandes
php shell.php mypackage list
php shell.php mypackage create item-name
</code></pre>
<p><strong>Mode HTTP:</strong></p>
<pre><code class="language-bash">KEY=$(cat .config/key)
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/create/item-name&quot;
</code></pre>
<h3 id="bonnes-pratiques">Bonnes pratiques</h3>
<ol>
<li><p><strong>Validation des entrées:</strong></p>
<pre><code class="language-php">$id = $args[0] ?? null;
if (!$id || !is_numeric($id)) {
    throw new \RuntimeException(&#39;ID invalide&#39;, 400);
}
</code></pre>
</li>
<li><p><strong>Gestion des erreurs:</strong></p>
<pre><code class="language-php">try {
    $data = json_decode(file_get_contents(&#39;data.json&#39;), true);
    if (!$data) {
        throw new \RuntimeException(&#39;JSON invalide&#39;, 400);
    }
} catch (\Throwable $e) {
    throw new \RuntimeException(&quot;Error: {$e-&gt;getMessage()}&quot;, 400);
}
</code></pre>
</li>
<li><p><strong>Sécurité:</strong></p>
<pre><code class="language-php">// MAUVAIS: Utilisation directe de l&#39;entrée utilisateur
$file = $args[0];
return file_get_contents($file);  // Vulnérable à la traversée de chemin

// BON: Valider et restreindre les chemins
$file = basename($args[0] ?? &#39;&#39;);  // Supprimer les composants de chemin
$path = &quot;app/data/$file&quot;;
if (!file_exists($path)) {
    throw new \RuntimeException(&#39;Fichier non trouvé&#39;, 404);
}
return file_get_contents($path);
</code></pre>
</li>
</ol>
<h2 id="configuration-du-référentiel">Configuration du référentiel</h2>
<h3 id="créer-un-référentiel-de-paquets">Créer un référentiel de paquets</h3>
<ol>
<li><p><strong>Créer la structure du référentiel:</strong></p>
<pre><code>my-repo/
└── main/
    ├── database.json
    ├── mypackage-1.0.0.zip
    └── otherapkg-1.0.0.zip
</code></pre>
</li>
<li><p><strong>Construire le ZIP du paquet:</strong></p>
<pre><code class="language-bash">cd mypackage
zip -r ../my-repo/main/mypackage-1.0.0.zip .
</code></pre>
</li>
<li><p><strong>Calculer le checksum:</strong></p>
<pre><code class="language-bash">sha256sum my-repo/main/mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
</li>
<li><p><strong>Créer database.json:</strong></p>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;Description du paquet&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;,
      &quot;author&quot;: &quot;Votre nom&quot;,
      &quot;license&quot;: &quot;MIT&quot;
    }
  }
}
</code></pre>
</li>
<li><p><strong>Héberger le référentiel:</strong></p>
<ul>
<li>Télécharger sur GitHub: <code>https://github.com/user/repo/raw/main/main/</code></li>
<li>Utiliser un CDN ou un hébergement statique</li>
<li>S&#39;assurer que HTTPS est activé</li>
</ul>
</li>
<li><p><strong>Configurer le shell pour utiliser votre référentiel:</strong>
 Modifiez <code>.config/repos.json</code>:</p>
<pre><code class="language-json">{
  &quot;main&quot;: [&quot;https://github.com/user/repo/raw/main/main&quot;]
}
</code></pre>
</li>
</ol>
<h3 id="exemple-dhébergement-github">Exemple d&#39;hébergement GitHub</h3>
<pre><code class="language-bash"># Créer un référentiel
mkdir -p my-packages/main
cd my-packages

# Ajouter des paquets
cp /path/to/mypackage-1.0.0.zip main/
cat &gt; main/database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# Pousser vers GitHub
git init
git add .
git commit -m &quot;Add packages&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# Les utilisateurs configurent: https://github.com/user/my-packages/raw/main/main
</code></pre>
<h2 id="déploiement">Déploiement</h2>
<h3 id="développement">Développement</h3>
<pre><code class="language-bash"># Exécutez le serveur PHP intégré
php -S localhost:8000

# Testez les commandes
php shell.php pkg list
curl &quot;http://localhost:8000/shell.php/$(cat .config/key)/pkg/list&quot;
</code></pre>
<h3 id="stagingproduction-1">Staging/Production</h3>
<ol>
<li><p><strong>Utilisez un serveur web approprié</strong> (Nginx, Apache, Caddy)</p>
</li>
<li><p><strong>Activez HTTPS</strong> pour la sécurité de la clé API</p>
</li>
<li><p><strong>Définissez des permissions restrictives:</strong></p>
<pre><code class="language-bash">chmod 644 shell.php
chmod 700 .config
chmod 600 .config/key
</code></pre>
</li>
<li><p><strong>Configurez PHP-FPM</strong> pour une meilleure performance</p>
</li>
<li><p><strong>Configurez la surveillance et la journalisation</strong></p>
</li>
<li><p><strong>Sauvegardez régulièrement</strong> le répertoire <code>.config/</code></p>
</li>
</ol>
<h3 id="déploiement-docker">Déploiement Docker</h3>
<pre><code class="language-dockerfile">FROM php:8.1-fpm

# Installer les extensions
RUN docker-php-ext-install zip

# Copier le shell
COPY shell.php /var/www/html/

# Définir les permissions
RUN chown -R www-data:www-data /var/www/html

WORKDIR /var/www/html
</code></pre>
<h3 id="renforcement-de-la-sécurité">Renforcement de la sécurité</h3>
<ol>
<li><p><strong>Restreindre l&#39;accès à la clé API:</strong></p>
<pre><code class="language-bash">chmod 600 .config/key
chown www-data:www-data .config/key
</code></pre>
</li>
<li><p><strong>Utiliser des clés spécifiques à l&#39;environnement</strong></p>
</li>
<li><p><strong>Activer HTTPS uniquement</strong> en production</p>
</li>
<li><p><strong>Limitation du taux</strong> au niveau du serveur web</p>
</li>
<li><p><strong>Surveiller les tentatives d&#39;authentification échouées</strong></p>
</li>
<li><p><strong>Mises à jour de sécurité régulières</strong></p>
</li>
</ol>
<h2 id="dépannage-1">Dépannage</h2>
<h3 id="problèmes-courants">Problèmes courants</h3>
<p><strong>Erreurs &quot;Autorisation refusée&quot;:</strong></p>
<pre><code class="language-bash"># Corriger les permissions
chmod 755 .
chmod 644 shell.php
chmod -R 755 .config
</code></pre>
<p><strong>&quot;ZipArchive non trouvé&quot;:</strong></p>
<pre><code class="language-bash"># Installer l&#39;extension
sudo apt-get install php-zip  # Debian/Ubuntu
sudo yum install php-zip       # CentOS/RHEL
</code></pre>
<p><strong>&quot;Clé API non trouvée&quot; (mode CLI):</strong></p>
<pre><code class="language-bash"># Générer la clé manuellement
php shell.php ls  # Cela crée .config/key
</code></pre>
<p><strong>Problèmes de fichier de verrou:</strong></p>
<pre><code class="language-bash"># Forcer le déverrouillage s&#39;il est bloqué
php shell.php pkg unlock
</code></pre>
<h2 id="étapes-suivantes">Étapes suivantes</h2>
<ul>
<li>Lire la <a href="USAGE_FR.md">Référence d&#39;utilisation</a> pour la documentation complète des commandes</li>
<li>Voir <a href="PACKAGES_FR.md">Développement de paquets</a> pour la création avancée de paquets</li>
<li>Consulter <a href="https://github.com/mehrnet/mpm-packages">les paquets d&#39;exemple</a></li>
</ul>
<hr>
<p>Pour les questions ou les problèmes, veuillez visiter: <a href="https://github.com/mehrnet/mpm">https://github.com/mehrnet/mpm</a></p>
<!-- LANG:fr -->
<h1 id="guide-de-développement-des-paquets">Guide de développement des paquets</h1>
<p>Guide complet pour créer, tester et distribuer les paquets MPM (Gestionnaire de paquets Mehr).</p>
<p>Pour les instructions d&#39;installation et de configuration, voir <a href="INSTALL_FR.md">INSTALL_FR.md</a> ou <a href="USAGE_FR.md">USAGE_FR.md</a>.</p>
<hr>
<h2 id="table-des-matières-2">Table des matières</h2>
<ul>
<li><a href="#d%C3%A9marrage-rapide">Démarrage rapide</a></li>
<li><a href="#structure-du-paquet">Structure du paquet</a></li>
<li><a href="#impl%C3%A9mentation-du-gestionnaire">Implémentation du gestionnaire</a></li>
<li><a href="#m%C3%A9tadonn%C3%A9es-du-paquet">Métadonnées du paquet</a></li>
<li><a href="#tests-des-paquets">Tests des paquets</a></li>
<li><a href="#distribution">Distribution</a></li>
<li><a href="#bonnes-pratiques">Bonnes pratiques</a></li>
<li><a href="#exemples">Exemples</a></li>
</ul>
<hr>
<h2 id="démarrage-rapide">Démarrage rapide</h2>
<p>Créez un paquet minimal en 3 étapes:</p>
<pre><code class="language-bash"># 1. Créer la structure du paquet
mkdir -p mypackage
cd mypackage

# 2. Créer le gestionnaire
cat &gt; handler.php &lt;&lt; &#39;EOF&#39;
&lt;?php
return function(array $args): string {
    return &quot;Bonjour depuis mypackage!&quot;;
};
EOF

# 3. Créer les métadonnées
cat &gt; package.json &lt;&lt; &#39;EOF&#39;
{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Un paquet simple&quot;,
    &quot;author&quot;: &quot;Votre nom&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: []
}
EOF

# Le tester
cd ..
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/
php shell.php mypackage
</code></pre>
<hr>
<h2 id="structure-du-paquet">Structure du paquet</h2>
<h3 id="fichiers-obligatoires">Fichiers obligatoires</h3>
<pre><code>mypackage/
├── handler.php       # OBLIGATOIRE: point d&#39;entrée
└── package.json      # OBLIGATOIRE: métadonnées
</code></pre>
<h3 id="structure-optionnelle">Structure optionnelle</h3>
<pre><code>mypackage/
├── handler.php       # Point d&#39;entrée (obligatoire)
├── package.json      # Métadonnées (obligatoire)
├── lib/             # Code de bibliothèque
│   ├── MyClass.php
│   └── helpers.php
├── data/            # Fichiers de données
│   └── config.json
├── views/           # Modèles
│   └── template.html
└── README.md        # Documentation du paquet
</code></pre>
<h3 id="extraction-de-fichiers">Extraction de fichiers</h3>
<p>Les paquets s&#39;extraient à la racine du projet en préservant les chemins:</p>
<p><strong>Le paquet contient:</strong></p>
<pre><code>handler.php
module.php
lib/Database.php
data/schema.json
</code></pre>
<p><strong>S&#39;extrait vers:</strong></p>
<pre><code>./handler.php
./module.php
./lib/Database.php
./data/schema.json
</code></pre>
<p>Pour les modules du framework Mehr, utilisez:</p>
<pre><code>app/packages/[name]/handler.php
app/packages/[name]/module.php
</code></pre>
<hr>
<h2 id="implémentation-du-gestionnaire">Implémentation du gestionnaire</h2>
<h3 id="gestionnaire-basique">Gestionnaire basique</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Action unique
    return &quot;Bonjour, le monde!&quot;;
};
</code></pre>
<h3 id="gestionnaire-multi-actions">Gestionnaire multi-actions</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;help&#39;;

    switch ($action) {
        case &#39;list&#39;:
            return handleList();

        case &#39;get&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID requis&#39;, 400);
            }
            return handleGet($id);

        case &#39;create&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Nom requis&#39;, 400);
            }
            return handleCreate($name);

        case &#39;delete&#39;:
            $id = $args[1] ?? null;
            if (!$id) {
                throw new \RuntimeException(&#39;ID requis&#39;, 400);
            }
            return handleDelete($id);

        case &#39;help&#39;:
            return &lt;&lt;&lt;&#39;EOF&#39;
Actions disponibles:
  list              - Lister tous les éléments
  get &lt;id&gt;          - Obtenir l&#39;élément par ID
  create &lt;name&gt;     - Créer un nouvel élément
  delete &lt;id&gt;       - Supprimer l&#39;élément
EOF;

        default:
            throw new \RuntimeException(&quot;Action inconnue: $action&quot;, 404);
    }
};

function handleList(): string {
    return &quot;item1\nitem2\nitem3&quot;;
}

function handleGet(string $id): string {
    // Charger à partir du fichier, de la base de données, etc.
    return &quot;Item data for: $id&quot;;
}

function handleCreate(string $name): string {
    // Créer et persister
    return &quot;Created: $name&quot;;
}

function handleDelete(string $id): string {
    // Supprimer l&#39;élément
    return &quot;Deleted: $id&quot;;
}
</code></pre>
<h3 id="traitement-des-arguments-1">Traitement des arguments</h3>
<p>Les arguments sont identiques dans les modes HTTP et CLI:</p>
<p><strong>HTTP:</strong></p>
<pre><code>GET /shell.php/KEY/users/create/alice/alice@example.com
                    ↓      ↓      ↓         ↓
                command args[0] args[1]  args[2]
</code></pre>
<p><strong>CLI:</strong></p>
<pre><code class="language-bash">php shell.php users create alice alice@example.com
               ↓      ↓      ↓         ↓
           command args[0] args[1]  args[2]
</code></pre>
<p><strong>Gestionnaire:</strong></p>
<pre><code class="language-php">function(array $args): string {
    $action = $args[0];    // &#39;create&#39;
    $name = $args[1];      // &#39;alice&#39;
    $email = $args[2];     // &#39;alice@example.com&#39;
}
</code></pre>
<h3 id="opérations-sur-les-fichiers">Opérations sur les fichiers</h3>
<p>Les gestionnaires s&#39;exécutent dans le répertoire shell.php. Utilisez les chemins relatifs:</p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    // Lire un fichier de données
    $data = json_decode(
        file_get_contents(&#39;app/data/items.json&#39;),
        true
    );

    // Modifier les données
    $data[&#39;new_item&#39;] = $args[0] ?? &#39;default&#39;;

    // Réécrire
    file_put_contents(
        &#39;app/data/items.json&#39;,
        json_encode($data, JSON_PRETTY_PRINT)
    );

    return &quot;Mis à jour&quot;;
};
</code></pre>
<h3 id="gestion-des-erreurs-1">Gestion des erreurs</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $id = $args[0] ?? null;

    // Validation
    if (!$id) {
        throw new \RuntimeException(&#39;ID requis&#39;, 400);
    }

    if (!is_numeric($id)) {
        throw new \RuntimeException(&#39;L\&#39;ID doit être numérique&#39;, 400);
    }

    // Opérations sur les fichiers
    $file = &quot;app/data/$id.json&quot;;
    if (!file_exists($file)) {
        throw new \RuntimeException(&#39;Élément non trouvé&#39;, 404);
    }

    try {
        $content = file_get_contents($file);
        $data = json_decode($content, true);

        if (!$data) {
            throw new \RuntimeException(&#39;JSON invalide&#39;, 400);
        }

        return json_encode($data);
    } catch (\Throwable $e) {
        throw new \RuntimeException(
            &quot;Impossible de lire l&#39;élément: {$e-&gt;getMessage()}&quot;,
            400
        );
    }
};
</code></pre>
<h3 id="formats-de-réponse">Formats de réponse</h3>
<p><strong>Texte brut:</strong></p>
<pre><code class="language-php">return &quot;item1\nitem2\nitem3&quot;;
</code></pre>
<p><strong>JSON:</strong></p>
<pre><code class="language-php">return json_encode([
    &#39;status&#39; =&gt; &#39;success&#39;,
    &#39;items&#39; =&gt; [&#39;item1&#39;, &#39;item2&#39;, &#39;item3&#39;]
]);
</code></pre>
<p><strong>Vide (POSIX):</strong></p>
<pre><code class="language-php">return &#39;&#39;;  // Succès sans sortie
</code></pre>
<hr>
<h2 id="métadonnées-du-paquet">Métadonnées du paquet</h2>
<h3 id="format-packagejson">Format package.json</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mypackage&quot;,
    &quot;name&quot;: &quot;My Package&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Description du paquet&quot;,
    &quot;author&quot;: &quot;Votre nom&quot;,
    &quot;license&quot;: &quot;MIT&quot;,
    &quot;dependencies&quot;: [&quot;dependency1&quot;, &quot;dependency2&quot;]
}
</code></pre>
<h3 id="spécifications-des-champs">Spécifications des champs</h3>
<table>
<thead>
<tr>
<th>Champ</th>
<th>Type</th>
<th>Obligatoire</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>id</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Minuscules, pas d&#39;espaces, utilisé dans les URL</td>
</tr>
<tr>
<td><code>name</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Nom lisible</td>
</tr>
<tr>
<td><code>version</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Versioning sémantique (X.Y.Z)</td>
</tr>
<tr>
<td><code>description</code></td>
<td>chaîne</td>
<td>Oui</td>
<td>Description brève</td>
</tr>
<tr>
<td><code>author</code></td>
<td>chaîne</td>
<td>Non</td>
<td>Auteur du paquet</td>
</tr>
<tr>
<td><code>license</code></td>
<td>chaîne</td>
<td>Non</td>
<td>Identifiant de licence (MIT, Apache-2.0, etc.)</td>
</tr>
<tr>
<td><code>dependencies</code></td>
<td>tableau</td>
<td>Non</td>
<td>Tableau d&#39;ID de paquets</td>
</tr>
</tbody></table>
<h3 id="déclaration-des-dépendances">Déclaration des dépendances</h3>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;auth&quot;,
    &quot;dependencies&quot;: [&quot;users&quot;, &quot;session&quot;]
}
</code></pre>
<p>Le gestionnaire de paquets:</p>
<ul>
<li>Résout les dépendances transitives automatiquement</li>
<li>Détecte les dépendances circulaires</li>
<li>Installe dans le bon ordre (dépendances avant dépendants)</li>
<li>Ignore les paquets déjà installés</li>
</ul>
<hr>
<h2 id="tests-des-paquets">Tests des paquets</h2>
<h3 id="test-manuel-cli">Test manuel (CLI)</h3>
<pre><code class="language-bash"># Installer le paquet manuellement
mkdir -p app/packages/mypackage
cp -r mypackage/* app/packages/mypackage/

# Tester les commandes
php shell.php mypackage
php shell.php mypackage list
php shell.php mypackage get 123
php shell.php mypackage create &quot;Test Item&quot;
</code></pre>
<h3 id="test-manuel-http">Test manuel (HTTP)</h3>
<pre><code class="language-bash"># Démarrer le serveur
php -S localhost:8000

# Obtenir la clé API
KEY=$(cat .config/key)

# Tester les commandes
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/list&quot;
curl &quot;http://localhost:8000/shell.php/$KEY/mypackage/get/123&quot;
</code></pre>
<h3 id="checklist-de-test">Checklist de test</h3>
<ul>
<li><input disabled="" type="checkbox"> Toutes les actions fonctionnent correctement</li>
<li><input disabled="" type="checkbox"> La gestion des erreurs fonctionne (entrée invalide)</li>
<li><input disabled="" type="checkbox"> Les arguments obligatoires sont validés</li>
<li><input disabled="" type="checkbox"> Les opérations sur les fichiers réussissent</li>
<li><input disabled="" type="checkbox"> Les modes CLI et HTTP fonctionnent de manière identique</li>
<li><input disabled="" type="checkbox"> L&#39;action d&#39;aide documente toutes les commandes</li>
<li><input disabled="" type="checkbox"> Les dépendances sont déclarées dans package.json</li>
</ul>
<hr>
<h2 id="distribution-1">Distribution</h2>
<h3 id="création-du-zip-du-paquet">Création du ZIP du paquet</h3>
<pre><code class="language-bash">cd mypackage
zip -r ../mypackage-1.0.0.zip .

# Vérifier le contenu
unzip -l ../mypackage-1.0.0.zip
</code></pre>
<h3 id="calcul-du-checksum">Calcul du checksum</h3>
<pre><code class="language-bash">sha256sum mypackage-1.0.0.zip
# Output: abc123def456...  mypackage-1.0.0.zip
</code></pre>
<h3 id="databasejson-du-référentiel">database.json du référentiel</h3>
<pre><code class="language-json">{
  &quot;version&quot;: 1,
  &quot;packages&quot;: {
    &quot;mypackage&quot;: {
      &quot;name&quot;: &quot;My Package&quot;,
      &quot;description&quot;: &quot;Description du paquet&quot;,
      &quot;author&quot;: &quot;Votre nom&quot;,
      &quot;license&quot;: &quot;MIT&quot;,
      &quot;versions&quot;: {
        &quot;1.0.0&quot;: {
          &quot;version&quot;: &quot;1.0.0&quot;,
          &quot;dependencies&quot;: [],
          &quot;checksum&quot;: &quot;sha256:abc123def456...&quot;,
          &quot;size&quot;: 2048,
          &quot;download_url&quot;: &quot;mypackage-1.0.0.zip&quot;,
          &quot;released_at&quot;: &quot;2025-01-15&quot;
        }
      },
      &quot;latest&quot;: &quot;1.0.0&quot;
    }
  }
}
</code></pre>
<h3 id="hébergement-github">Hébergement GitHub</h3>
<pre><code class="language-bash"># Créer la structure du référentiel
mkdir -p my-packages/main
cd my-packages/main

# Ajouter le paquet et la base de données
cp /path/to/mypackage-1.0.0.zip .
cat &gt; database.json &lt;&lt; &#39;EOF&#39;
{
  &quot;version&quot;: 1,
  &quot;packages&quot;: { ... }
}
EOF

# Pousser vers GitHub
cd ..
git init
git add .
git commit -m &quot;Add mypackage&quot;
git remote add origin https://github.com/user/my-packages.git
git push -u origin main

# Les utilisateurs configurent:
# &quot;main&quot;: [&quot;https://github.com/user/my-packages/raw/main/main&quot;]
</code></pre>
<hr>
<h2 id="bonnes-pratiques-1">Bonnes pratiques</h2>
<h3 id="validation-des-entrées">Validation des entrées</h3>
<pre><code class="language-php">// MAUVAIS: Pas de validation
$id = $args[0];
return processId($id);

// BON: Valider et nettoyer
$id = $args[0] ?? null;
if (!$id || !is_numeric($id) || $id &lt; 1) {
    throw new \RuntimeException(&#39;ID invalide&#39;, 400);
}
return processId((int)$id);
</code></pre>
<h3 id="sécurité">Sécurité</h3>
<pre><code class="language-php">// MAUVAIS: Accès arbitraire aux fichiers
$file = $args[0];
return file_get_contents($file);  // Vulnérable à ../../../etc/passwd

// BON: Restreindre à un répertoire sûr
$file = basename($args[0] ?? &#39;&#39;);  // Supprimer les composants de chemin
$path = &quot;app/data/$file&quot;;

if (!file_exists($path)) {
    throw new \RuntimeException(&#39;Fichier non trouvé&#39;, 404);
}

return file_get_contents($path);
</code></pre>
<h3 id="messages-derreur">Messages d&#39;erreur</h3>
<pre><code class="language-php">// MAUVAIS: Erreur générique
throw new \RuntimeException(&#39;Erreur&#39;, 400);

// BON: Erreur descriptive
throw new \RuntimeException(&#39;L\&#39;ID utilisateur doit être un entier positif&#39;, 400);
</code></pre>
<h3 id="organisation-du-code">Organisation du code</h3>
<pre><code class="language-php">// MAUVAIS: Tout dans le gestionnaire
return function(array $args): string {
    // 500 lignes de code...
};

// BON: Utiliser le répertoire lib/
return function(array $args): string {
    require_once __DIR__ . &#39;/lib/Manager.php&#39;;
    $manager = new Manager();
    return $manager-&gt;handle($args);
};
</code></pre>
<h3 id="dépendances">Dépendances</h3>
<pre><code class="language-php">// BON: Vérifier si les bibliothèques Composer sont disponibles
if (file_exists(__DIR__ . &#39;/../../vendor/autoload.php&#39;)) {
    require_once __DIR__ . &#39;/../../vendor/autoload.php&#39;;
    // Utiliser les bibliothèques
} else {
    throw new \RuntimeException(&#39;Dépendances Composer manquantes&#39;, 500);
}
</code></pre>
<hr>
<h2 id="exemples">Exemples</h2>
<h3 id="compteur-simple">Compteur simple</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $file = &#39;app/data/counter.txt&#39;;

    if (!file_exists($file)) {
        file_put_contents($file, &#39;0&#39;);
    }

    $count = (int)file_get_contents($file);
    $count++;
    file_put_contents($file, (string)$count);

    return &quot;Compte: $count&quot;;
};
</code></pre>
<h3 id="crud-json-1">CRUD JSON</h3>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    $action = $args[0] ?? &#39;list&#39;;
    $file = &#39;app/data/items.json&#39;;

    // Charger les données
    $items = [];
    if (file_exists($file)) {
        $items = json_decode(file_get_contents($file), true) ?? [];
    }

    switch ($action) {
        case &#39;list&#39;:
            return json_encode($items);

        case &#39;add&#39;:
            $name = $args[1] ?? null;
            if (!$name) {
                throw new \RuntimeException(&#39;Nom requis&#39;, 400);
            }
            $items[] = [
                &#39;id&#39; =&gt; count($items) + 1,
                &#39;name&#39; =&gt; $name,
                &#39;created_at&#39; =&gt; date(&#39;Y-m-d H:i:s&#39;)
            ];
            file_put_contents($file, json_encode($items, JSON_PRETTY_PRINT));
            return &quot;Ajouté: $name&quot;;

        case &#39;get&#39;:
            $id = (int)($args[1] ?? 0);
            foreach ($items as $item) {
                if ($item[&#39;id&#39;] === $id) {
                    return json_encode($item);
                }
            }
            throw new \RuntimeException(&#39;Élément non trouvé&#39;, 404);

        default:
            throw new \RuntimeException(&#39;Action inconnue&#39;, 404);
    }
};
</code></pre>
<h3 id="module-du-framework-mehr">Module du framework Mehr</h3>
<pre><code>mymodule/
├── app/
│   └── packages/
│       └── mymodule/
│           ├── handler.php       # Gestionnaire de commande shell
│           ├── module.php        # Implémentation du module
│           ├── manifest.json     # Manifeste Mehr
│           └── migrations/       # Migrations de base de données
│               └── 001_create_table.php
└── package.json                  # Métadonnées de distribution
</code></pre>
<p><strong>handler.php:</strong></p>
<pre><code class="language-php">&lt;?php
return function(array $args): string {
    require_once __DIR__ . &#39;/module.php&#39;;
    $module = new MyModule();
    return $module-&gt;handleCommand($args);
};
</code></pre>
<p><strong>package.json:</strong></p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;mymodule&quot;,
    &quot;name&quot;: &quot;My Module&quot;,
    &quot;version&quot;: &quot;1.0.0&quot;,
    &quot;description&quot;: &quot;Module du framework Mehr&quot;,
    &quot;dependencies&quot;: [&quot;core&quot;]
}
</code></pre>
<hr>
<h2 id="voir-aussi-1">Voir aussi</h2>
<ul>
<li><strong><a href="INSTALL_FR.md">Guide d&#39;installation</a></strong> - Configuration et création de référentiel</li>
<li><strong><a href="USAGE_FR.md">Référence d&#39;utilisation</a></strong> - Référence des commandes</li>
<li><strong><a href="https://github.com/mehrnet/mpm-packages">Paquets d&#39;exemple</a></strong> - Exemples fonctionnels</li>
</ul>
<hr>
<p>Pour les questions ou les problèmes, veuillez visiter: <a href="https://github.com/mehrnet/mpm/issues">https://github.com/mehrnet/mpm/issues</a></p>

    </section>

    </main>

    <script>
        (function() {
            // ========== CONFIGURATION ==========
            const config = {
                langLabels: { en: 'EN', fr: 'FR', fa: 'FA' },
                translations: {
                    'logo-text': {
                        en: "Mehr's Package Manager",
                        fa: "مدیر بسته مهر",
                        fr: "Gestionnaire de Paquets Mehr"
                    }
                }
            };

            // ========== DOM ELEMENTS ==========
            const dom = {
                htmlRoot: document.getElementById('html-root'),
                langBtn: document.getElementById('lang-btn'),
                langDropdown: document.getElementById('lang-dropdown'),
                mobileMenuBtn: document.getElementById('mobile-menu-btn'),
                sidebar: document.getElementById('sidebar'),
                navLinks: document.querySelectorAll('.toc-link')
            };

            // ========== STATE ==========
            let scrollTicking = false;

            // ========== LANGUAGE MANAGEMENT ==========
            function detectLanguageFromHash() {
                const hash = window.location.hash.slice(1);

                // If URL has a hash, prioritize finding the language it belongs to
                if (hash) {
                    try {
                        const decodedHash = decodeURIComponent(hash);
                        const element = document.getElementById(decodedHash);
                        if (element) {
                            const section = element.closest('[data-lang]');
                            if (section) {
                                return section.getAttribute('data-lang');
                            }
                        }
                    } catch (e) {
                        // Continue to fallback
                    }
                }

                // Fallback: saved preference, then browser language, then English
                return localStorage.getItem('mpm-docs-lang') ||
                       (navigator.language.startsWith('fa') ? 'fa' :
                        navigator.language.startsWith('fr') ? 'fr' : 'en');
            }

            function setLanguage(lang, skipActiveUpdate = false) {
                // Update HTML attributes
                dom.htmlRoot.setAttribute('lang', lang);
                dom.htmlRoot.setAttribute('dir', lang === 'fa' ? 'rtl' : 'ltr');
                localStorage.setItem('mpm-docs-lang', lang);

                // Show/hide language sections
                document.querySelectorAll('[data-lang]').forEach(el => {
                    el.hidden = el.getAttribute('data-lang') !== lang;
                });

                // Update language button
                dom.langBtn.textContent = config.langLabels[lang];

                // Update language dropdown active state
                document.querySelectorAll('.lang-option').forEach(opt => {
                    const isActive = opt.getAttribute('data-lang') === lang;
                    opt.classList[isActive ? 'add' : 'remove']('active');
                });

                // Update UI text translations
                Object.entries(config.translations).forEach(([elementId, texts]) => {
                    const element = document.getElementById(elementId);
                    if (element && texts[lang]) {
                        element.textContent = texts[lang];
                    }
                });

                dom.langDropdown.classList.remove('show');
                // Only update active link if not during initialization
                if (!skipActiveUpdate) {
                    updateActiveLink();
                }
            }

            // ========== NAVIGATION HIGHLIGHTING ==========
            function updateActiveLink() {
                let closest = null;
                let closestDistance = Infinity;

                dom.navLinks.forEach(link => {
                    // Skip hidden links
                    if (link.offsetParent === null) return;

                    const href = link.getAttribute('href');
                    if (!href?.startsWith('#')) return;

                    const heading = document.getElementById(href.substring(1));
                    // Skip if heading not found or is hidden
                    if (!heading || heading.offsetParent === null) return;

                    // Find the link closest to viewport top
                    const distance = Math.abs(heading.getBoundingClientRect().top);
                    if (distance < closestDistance) {
                        closest = link;
                        closestDistance = distance;
                    }
                });

                // Remove active class from all links
                dom.navLinks.forEach(link => link.classList.remove('active'));

                // Add active class to closest link and update hash
                if (closest) {
                    closest.classList.add('active');

                    // Update URL hash without history entry
                    const newHash = closest.getAttribute('href');
                    if (newHash && window.location.hash !== newHash) {
                        try {
                            history.replaceState(null, '', newHash);
                        } catch (e) {
                            console.warn('Failed to update hash:', e);
                        }
                    }
                }

                scrollTicking = false;
            }

            function onScroll() {
                if (!scrollTicking) {
                    requestAnimationFrame(updateActiveLink);
                    scrollTicking = true;
                }
            }

            // ========== EVENT LISTENERS: LANGUAGE DROPDOWN ==========
            dom.langBtn.addEventListener('click', () => {
                dom.langDropdown.classList.toggle('show');
            });

            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', () => {
                    setLanguage(option.getAttribute('data-lang'));
                });
            });

            document.addEventListener('click', (e) => {
                const isLanguageArea = e.target.closest('.sidebar-header') ||
                                     e.target.closest('.lang-dropdown');
                if (!isLanguageArea) {
                    dom.langDropdown.classList.remove('show');
                }
            });

            // ========== EVENT LISTENERS: MOBILE MENU ==========
            dom.mobileMenuBtn.addEventListener('click', () => {
                const isOpen = dom.mobileMenuBtn.classList.toggle('active');
                dom.sidebar.classList.toggle('mobile-open', isOpen);
            });

            dom.sidebar.addEventListener('click', (e) => {
                if (e.target.classList.contains('toc-link')) {
                    dom.mobileMenuBtn.classList.remove('active');
                    dom.sidebar.classList.remove('mobile-open');
                }
            });

            // ========== EVENT LISTENERS: SCROLL & HASH ==========
            const mainElement = document.querySelector('.main');
            if (mainElement) {
                mainElement.addEventListener('scroll', onScroll, { passive: true });
            }
            window.addEventListener('hashchange', () => {
                setLanguage(detectLanguageFromHash());
            });

            // ========== INITIALIZATION ==========
            // Prioritize language from URL hash over saved preference
            const hashLang = detectLanguageFromHash();
            // Skip active link update during initialization to let hash scroll happen first
            setLanguage(hashLang, true);

            // Scroll to hash after language is applied and DOM is settled
            setTimeout(() => {
                const hash = window.location.hash.slice(1);
                if (hash) {
                    try {
                        const decodedHash = decodeURIComponent(hash);
                        const element = document.getElementById(decodedHash);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Update active link after scrolling to hash
                            updateActiveLink();
                        }
                    } catch (e) {
                        console.warn('Failed to scroll to hash:', e);
                    }
                }
            }, 0);
        })();
    </script>
</body>
</html>
